{% extends 'admin_dashboard/base.html' %}
{% load static i18n %}

{% block title %}{% trans "إدارة الترجمة" %} - {{ block.super }}{% endblock %}

{% block admin_extra_css %}
<style>
    .translations-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 40px;
        border-radius: 16px;
        margin-bottom: 30px;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
    }

    [data-theme='dark'] .translations-header {
        background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .translation-card {
        background: var(--bg-primary, white);
        border-radius: 16px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid transparent;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

    [data-theme='dark'] .translation-card {
        background: var(--bg-secondary, #1a1a1a);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .translation-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }

    [data-theme='dark'] .translation-card:hover {
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
    }

    .language-badge {
        display: inline-flex;
        align-items: center;
        padding: 8px 16px;
        border-radius: 50px;
        font-weight: 600;
        font-size: 0.9rem;
        gap: 8px;
    }

    .language-badge.ar {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .language-badge.en {
        background: linear-gradient(135deg, #3b82f6, #2563eb);
        color: white;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-box {
        background: var(--bg-primary, white);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid transparent;
    }

    [data-theme='dark'] .stat-box {
        background: var(--bg-secondary, #1a1a1a);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .stat-number {
        font-size: 2rem;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea, #764ba2);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    [data-theme='dark'] .stat-number {
        background: linear-gradient(135deg, #a5b4fc, #c4b5fd);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    .stat-label {
        color: var(--text-secondary, #6b7280);
        font-size: 0.9rem;
        margin-top: 8px;
    }

    [data-theme='dark'] .stat-label {
        color: #d1d5db;
    }

    .action-button {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        border-radius: 8px;
        font-weight: 600;
        text-decoration: none;
        transition: all 0.3s ease;
        border: none;
        cursor: pointer;
    }

    .action-button.primary {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
    }

    .action-button.primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        color: white;
    }

    .action-button.secondary {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
    }

    .action-button.secondary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        color: white;
    }

    .info-box {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
        border-left: 4px solid #3b82f6;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }

    [data-theme='dark'] .info-box {
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(59, 130, 246, 0.1));
        border-left-color: #60a5fa;
    }

    .feature-list {
        list-style: none;
        padding: 0;
    }

    .feature-list li {
        padding: 10px 0;
        border-bottom: 1px solid #e5e7eb;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    [data-theme='dark'] .feature-list li {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .feature-list li:last-child {
        border-bottom: none;
    }

    .feature-list li i {
        color: #10b981;
        font-size: 1.1rem;
    }

    [data-theme='dark'] .feature-list li i {
        color: #34d399;
    }

    .external-link-notice {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(37, 99, 235, 0.05));
        border-left: 4px solid #3b82f6;
        padding: 15px 20px;
        border-radius: 8px;
        margin: 20px 0;
        color: var(--text-primary);
    }

    [data-theme='dark'] .external-link-notice {
        background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(59, 130, 246, 0.1));
        border-left-color: #60a5fa;
    }

    .translation-editor {
        background: var(--bg-primary, white);
        border-radius: 16px;
        padding: 25px;
        margin-top: 30px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        border: 1px solid transparent;
    }

    [data-theme='dark'] .translation-editor {
        background: var(--bg-secondary, #1a1a1a);
        border-color: rgba(255, 255, 255, 0.1);
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .translation-item {
        background: var(--bg-secondary, #f9fafb);
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 15px;
    }

    [data-theme='dark'] .translation-item {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .translation-item .msgid {
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .translation-item .msgstr {
        width: 100%;
        padding: 10px;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        background: var(--bg-primary, white);
        color: var(--text-primary);
        font-family: inherit;
        resize: vertical;
        min-height: 40px;
    }

    [data-theme='dark'] .translation-item .msgstr {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.15);
        color: var(--text-primary);
    }

    .translation-item .msgstr:focus {
        outline: none;
        border-color: #667eea;
    }

    .language-selector {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .language-selector button {
        padding: 10px 20px;
        border: 2px solid #e5e7eb;
        background: var(--bg-primary, white);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
    }

    [data-theme='dark'] .language-selector button {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
    }

    .language-selector button.active {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
    }

    .translation-search {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid #d1d5db;
        border-radius: 8px;
        margin-bottom: 20px;
        background: var(--bg-primary, white);
        color: var(--text-primary);
    }

    [data-theme='dark'] .translation-search {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.15);
    }

    .translation-pagination {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .translation-pagination button {
        padding: 8px 16px;
        border: 1px solid #d1d5db;
        background: var(--bg-primary, white);
        border-radius: 6px;
        cursor: pointer;
    }

    [data-theme='dark'] .translation-pagination button {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.15);
    }

    .translation-pagination button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}

{% block admin_content %}
    <!-- Header -->
    <div class="translations-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="mb-2">
                    <i class="fas fa-language me-3"></i>
                    {% trans "إدارة الترجمة" %}
                </h1>
                <p class="mb-0 opacity-75">{% trans "إدارة ترجمات الموقع باستخدام Django Rosetta" %}</p>
            </div>
        </div>
    </div>

    <!-- Statistics -->
    <div class="stats-grid">
        <div class="stat-box">
            <div class="stat-number">2</div>
            <div class="stat-label">{% trans "اللغات المتاحة" %}</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="totalStrings">-</div>
            <div class="stat-label">{% trans "إجمالي النصوص" %}</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="translatedStrings">-</div>
            <div class="stat-label">{% trans "النصوص المترجمة" %}</div>
        </div>
        <div class="stat-box">
            <div class="stat-number" id="completionRate">-%</div>
            <div class="stat-label">{% trans "نسبة الإكمال" %}</div>
        </div>
    </div>

    <!-- Info Box -->
    <div class="info-box">
        <h5>
            <i class="fas fa-info-circle me-2"></i>
            {% trans "حول نظام الترجمة" %}
        </h5>
        <p class="mb-0">
            {% trans "يستخدم الموقع Django Rosetta لإدارة الترجمات. يمكنك ترجمة جميع النصوص الظاهرة في الموقع من خلال واجهة سهلة الاستخدام." %}
        </p>
    </div>

    <!-- External Link Notice -->
    <div class="external-link-notice">
        <div class="d-flex align-items-start">
            <i class="fas fa-external-link-alt me-3 mt-1"></i>
            <div>
                <strong>{% trans "ملاحظة:" %}</strong>
                {% trans "ستفتح واجهة Rosetta في نافذة جديدة لأسباب أمنية. بعد الانتهاء من التحرير، يمكنك العودة إلى هذه الصفحة." %}
            </div>
        </div>
    </div>

    <!-- Language Cards -->
    <div class="row">
        <div class="col-md-6 mb-4">
            <div class="translation-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <span class="language-badge ar">
                            <i class="fas fa-flag"></i>
                            العربية
                        </span>
                    </h4>
                </div>
                <ul class="feature-list mb-4">
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>{% trans "اللغة الافتراضية للموقع" %}</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>{% trans "دعم كامل من اليمين إلى اليسار (RTL)" %}</span>
                    </li>
                    <li>
                        <i class="fas fa-chart-line"></i>
                        <span id="arStats">{% trans "جاري التحميل..." %}</span>
                    </li>
                </ul>
                <div class="d-flex gap-2">
                    <button onclick="loadLanguageTranslations('ar')" class="action-button primary">
                        <i class="fas fa-edit"></i>
                        {% trans "تحرير الترجمات" %}
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-4">
            <div class="translation-card">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">
                        <span class="language-badge en">
                            <i class="fas fa-flag"></i>
                            English
                        </span>
                    </h4>
                </div>
                <ul class="feature-list mb-4">
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>{% trans "اللغة الثانوية" %}</span>
                    </li>
                    <li>
                        <i class="fas fa-check-circle"></i>
                        <span>{% trans "دعم من اليسار إلى اليمين (LTR)" %}</span>
                    </li>
                    <li>
                        <i class="fas fa-chart-line"></i>
                        <span id="enStats">{% trans "جاري التحميل..." %}</span>
                    </li>
                </ul>
                <div class="d-flex gap-2">
                    <button onclick="loadLanguageTranslations('en')" class="action-button primary">
                        <i class="fas fa-edit"></i>
                        {% trans "تحرير الترجمات" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline Translation Editor -->
    <div id="translationEditor" class="translation-editor" style="display: none;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0">
                <i class="fas fa-language me-2"></i>
                <span id="editorTitle">{% trans "تحرير الترجمات" %}</span>
            </h4>
            <div class="d-flex gap-2">
                <button onclick="saveAllTranslations()" class="action-button primary">
                    <i class="fas fa-save me-1"></i>
                    {% trans "حفظ جميع التغييرات" %}
                </button>
                <button onclick="closeTranslationEditor()" class="rosetta-close-btn" style="background: rgba(102, 126, 234, 0.2); color: #667eea; padding: 8px 16px; border-radius: 8px; border: none; cursor: pointer;">
                    <i class="fas fa-times me-1"></i>
                    {% trans "إغلاق" %}
                </button>
            </div>
        </div>

        <input type="text" id="translationSearch" class="translation-search" placeholder="{% trans 'ابحث في الترجمات...' %}" onkeyup="filterTranslations()">

        <div id="translationsList" class="translations-list">
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: #667eea;"></i>
                <p>{% trans "جاري تحميل الترجمات..." %}</p>
            </div>
        </div>

        <div id="translationPagination" class="translation-pagination" style="display: none;">
            <button onclick="prevPage()" id="prevBtn">{% trans "السابق" %}</button>
            <span id="pageInfo"></span>
            <button onclick="nextPage()" id="nextBtn">{% trans "التالي" %}</button>
        </div>
    </div>

    <!-- Additional Tools -->
    <div class="translation-card">
        <h4 class="mb-4">
            <i class="fas fa-tools me-2"></i>
            {% trans "أدوات سريعة" %}
        </h4>
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="d-flex flex-column gap-2">
                    <h6>{% trans "تحديث ملفات الترجمة" %}</h6>
                    <button class="action-button secondary" onclick="updateTranslations()">
                        <i class="fas fa-sync"></i>
                        {% trans "تحديث الترجمات" %}
                    </button>
                </div>
            </div>
            <div class="col-md-6 mb-3">
                <div class="d-flex flex-column gap-2">
                    <h6>{% trans "معلومات" %}</h6>
                    <button class="action-button secondary" onclick="showAutoTranslateInfo()">
                        <i class="fas fa-info-circle"></i>
                        {% trans "معلومات الترجمة التلقائية" %}
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="translation-card">
        <h4 class="mb-3">
            <i class="fas fa-book me-2"></i>
            {% trans "دليل الاستخدام" %}
        </h4>
        <div class="row">
            <div class="col-md-6">
                <h6>{% trans "كيفية ترجمة النصوص:" %}</h6>
                <ol>
                    <li>{% trans "انقر على زر 'تحرير الترجمات' للغة المطلوبة" %}</li>
                    <li>{% trans "اختر الملف الذي تريد ترجمته (django.po أو djangojs.po)" %}</li>
                    <li>{% trans "ابحث عن النص الذي تريد ترجمته" %}</li>
                    <li>{% trans "أدخل الترجمة في الحقل المخصص" %}</li>
                    <li>{% trans "احفظ التغييرات" %}</li>
                </ol>
            </div>
            <div class="col-md-6">
                <h6>{% trans "نصائح مهمة:" %}</h6>
                <ul>
                    <li>{% trans "تأكد من استخدام التنسيق الصحيح للمتغيرات (مثل %(name)s)" %}</li>
                    <li>{% trans "احفظ التغييرات بشكل متكرر لتجنب فقدان العمل" %}</li>
                    <li>{% trans "اختبر الترجمات على الموقع بعد الحفظ" %}</li>
                    <li>{% trans "استخدم البحث للعثور على نصوص محددة" %}</li>
                </ul>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
<!-- Update Translations Confirmation Modal -->
<div class="modal fade" id="updateConfirmModal" tabindex="-1" aria-labelledby="updateConfirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="updateConfirmModalLabel">
                    <i class="fas fa-sync-alt me-2"></i>
                    {% trans "تأكيد التحديث" %}
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p class="mb-0">
                    {% trans "هل تريد تحديث ملفات الترجمة؟ قد يستغرق هذا بعض الوقت." %}
                </p>
                <p class="text-warning mt-2 mb-0">
                    <i class="fas fa-clock me-1"></i>
                    {% trans "قد تستغرق هذه العملية بضع دقائق." %}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    {% trans "إلغاء" %}
                </button>
                <button type="button" class="btn btn-primary" id="confirmUpdateBtn">
                    <i class="fas fa-sync-alt me-2"></i>
                    {% trans "تحديث" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div id="toastContainer" class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 10500;"></div>
{% endblock %}

{% block admin_extra_js %}
<script>
    // URL patterns with language prefix
    const TRANSLATION_URLS = {
        get: (lang) => `{% url "main:admin_translations_get" "LANG" %}`.replace('LANG', lang),
        save: (lang) => `{% url "main:admin_translations_save" "LANG" %}`.replace('LANG', lang)
    };

    // Toast notification function
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    function showToast(message, type = 'info', duration = 5000) {
        const toastContainer = document.getElementById('toastContainer');
        const toastId = 'toast-' + Date.now();
        const bgClass = type === 'success' ? 'bg-success' :
                       type === 'error' ? 'bg-danger' :
                       type === 'warning' ? 'bg-warning' : 'bg-info';

        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center ${bgClass} text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            </div>
        `;

        toastContainer.insertAdjacentHTML('beforeend', toastHTML);
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: duration });
        toast.show();

        toastElement.addEventListener('hidden.bs.toast', function () {
            this.remove();
        });
    }

    // Note: Rosetta has X-Frame-Options set to DENY, so it opens in a new window
    const updateConfirmModal = new bootstrap.Modal(document.getElementById('updateConfirmModal'));

    function updateTranslations() {
        updateConfirmModal.show();
    }

    // Handle update confirmation
    document.getElementById('confirmUpdateBtn').addEventListener('click', function() {
        updateConfirmModal.hide();

        // Show loading notification
        showToast('{% trans "جاري تحديث الترجمات..." %}', 'info');

        // In production, this would make an AJAX call to compile translations
        setTimeout(() => {
            showToast('{% trans "تم تحديث الترجمات بنجاح" %}', 'success');
        }, 2000);
    });

    function showAutoTranslateInfo() {
        showToast('{% trans "الترجمة التلقائية متاحة من خلال واجهة Rosetta. يمكنك استخدام خدمات الترجمة الآلية لترجمة النصوص تلقائياً، ثم مراجعتها وتحسينها يدوياً." %}', 'info', 7000);
    }

    // Inline Translation Editor Functions
    let currentLanguage = '';
    let currentPage = 1;
    let itemsPerPage = 20;
    let allTranslations = [];
    let filteredTranslations = [];

    function loadLanguageTranslations(lang) {
        currentLanguage = lang;
        currentPage = 1;

        const editor = document.getElementById('translationEditor');
        const title = document.getElementById('editorTitle');

        title.textContent = lang === 'ar' ? 'تحرير الترجمات - العربية' : 'Edit Translations - English';

        editor.style.display = 'block';
        editor.scrollIntoView({ behavior: 'smooth', block: 'start' });

        // Show loading
        document.getElementById('translationsList').innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-spinner fa-spin fa-3x mb-3" style="color: #667eea;"></i>
                <p>{% trans "جاري تحميل الترجمات..." %}</p>
            </div>
        `;

        // Fetch translations for this language
        fetch(TRANSLATION_URLS.get(lang), {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success && data.translations) {
                allTranslations = data.translations;
                filteredTranslations = allTranslations;
                renderTranslations();
            } else {
                document.getElementById('translationsList').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        ${escapeHtml(data.message || '{% trans "فشل تحميل الترجمات" %}')}
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading translations:', error);
            document.getElementById('translationsList').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    {% trans "حدث خطأ أثناء تحميل الترجمات" %}: ${escapeHtml(error.message)}
                </div>
            `;
        });
    }

    function renderTranslations() {
        const start = (currentPage - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pageItems = filteredTranslations.slice(start, end);

        const listHtml = pageItems.map((item, index) => `
            <div class="translation-item">
                <div class="msgid">${escapeHtml(item.msgid)}</div>
                <textarea class="msgstr" data-index="${start + index}" rows="${item.msgstr && item.msgstr.length > 50 ? '3' : '1'}">${escapeHtml(item.msgstr || '')}</textarea>
            </div>
        `).join('');

        document.getElementById('translationsList').innerHTML = listHtml || '<p class="text-center">{% trans "لا توجد ترجمات" %}</p>';

        // Update pagination
        const totalPages = Math.ceil(filteredTranslations.length / itemsPerPage);
        document.getElementById('pageInfo').textContent = `${currentPage} / ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage === 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
        document.getElementById('translationPagination').style.display = totalPages > 1 ? 'flex' : 'none';
    }

    function filterTranslations() {
        const searchTerm = document.getElementById('translationSearch').value.toLowerCase();
        if (!searchTerm) {
            filteredTranslations = allTranslations;
        } else {
            filteredTranslations = allTranslations.filter(item =>
                item.msgid.toLowerCase().includes(searchTerm) ||
                (item.msgstr && item.msgstr.toLowerCase().includes(searchTerm))
            );
        }
        currentPage = 1;
        renderTranslations();
    }

    function prevPage() {
        if (currentPage > 1) {
            currentPage--;
            renderTranslations();
        }
    }

    function nextPage() {
        const totalPages = Math.ceil(filteredTranslations.length / itemsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTranslations();
        }
    }

    function saveAllTranslations() {
        // Collect all modified translations
        const textareas = document.querySelectorAll('.msgstr');
        const updates = [];

        textareas.forEach(textarea => {
            const index = parseInt(textarea.getAttribute('data-index'));
            const newValue = textarea.value;
            if (filteredTranslations[index] && filteredTranslations[index].msgstr !== newValue) {
                updates.push({
                    msgid: filteredTranslations[index].msgid,
                    msgstr: newValue
                });
            }
        });

        if (updates.length === 0) {
            showToast('{% trans "لا توجد تغييرات للحفظ" %}', 'info');
            return;
        }

        // Save via AJAX
        fetch(TRANSLATION_URLS.save(currentLanguage), {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ updates })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast(`{% trans "تم حفظ" %} ${updates.length} {% trans "ترجمة بنجاح" %}`, 'success');
                // Reload stats
                loadTranslationStats();
            } else {
                showToast(data.message || '{% trans "فشل الحفظ" %}', 'error');
            }
        })
        .catch(error => {
            console.error('Error saving translations:', error);
            showToast('{% trans "حدث خطأ أثناء الحفظ" %}', 'error');
        });
    }

    function closeTranslationEditor() {
        document.getElementById('translationEditor').style.display = 'none';
        document.getElementById('translationSearch').value = '';
        allTranslations = [];
        filteredTranslations = [];
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Translation stats and other functions

    // Simulate loading translation stats
    document.addEventListener('DOMContentLoaded', function() {
        loadTranslationStats();
    });

    function loadTranslationStats() {
        fetch('{% url "main:admin_translations_stats" %}', {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success && data.stats) {
                const stats = data.stats;

                // Update counters
                document.getElementById('totalStrings').textContent = stats.total_strings.toLocaleString();
                document.getElementById('translatedStrings').textContent = stats.translated_strings.toLocaleString();
                document.getElementById('completionRate').textContent = stats.completion_rate + '%';

                // Update language-specific info if available
                if (stats.languages && stats.languages.length > 0) {
                    stats.languages.forEach(lang => {
                        console.log(`${lang.code}: ${lang.translated}/${lang.total} (${lang.percent}%)`);

                        // Update language-specific stats in the cards
                        if (lang.code === 'ar') {
                            const arStatsEl = document.getElementById('arStats');
                            if (arStatsEl) {
                                arStatsEl.innerHTML = `${lang.translated}/${lang.total} (${lang.percent}%)`;
                            }
                        } else if (lang.code === 'en') {
                            const enStatsEl = document.getElementById('enStats');
                            if (enStatsEl) {
                                enStatsEl.innerHTML = `${lang.translated}/${lang.total} (${lang.percent}%)`;
                            }
                        }
                    });
                }
            } else {
                console.warn('Failed to load translation stats:', data.message);
                // Set default values
                document.getElementById('totalStrings').textContent = '0';
                document.getElementById('translatedStrings').textContent = '0';
                document.getElementById('completionRate').textContent = '0%';
            }
        })
        .catch(error => {
            console.error('Error loading translation stats:', error);
            // Set default values on error
            document.getElementById('totalStrings').textContent = '0';
            document.getElementById('translatedStrings').textContent = '0';
            document.getElementById('completionRate').textContent = '0%';
        });
    }
</script>
{% endblock %}
