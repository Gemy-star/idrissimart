{% extends 'admin_dashboard/base.html' %}
{% load static i18n %}

{% block title %}
    {% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø§Øª" %} - {% trans "Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø¯ÙŠØ±" %}
{% endblock %}

{% block admin_extra_css %}
<script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/super-build/ckeditor.js"></script>
<style>
    /* All modal styles are inherited from admin-dashboard.css */
    /* Modal z-index hierarchy: backdrop (10500), modal (10600), dialog (10700) */

    /* Ensure modals display correctly - Bootstrap 5 compatibility */
    .modal.show {
        display: block !important;
    }

    .modal-backdrop.show {
        opacity: 0.5 !important;
    }

    .blog-stats-card {
        background: linear-gradient(135deg, var(--primary-color, #4b315e) 0%, var(--secondary-color, #ff6001) 100%);
        border-radius: 16px;
        padding: 2rem;
        color: white;
        box-shadow: 0 10px 30px rgba(75, 49, 94, 0.3);
        margin-bottom: 2rem;
    }

    .stat-item {
        text-align: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-label {
        font-size: 0.9rem;
        opacity: 0.9;
    }

    .blog-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        border-left: 4px solid #667eea;
    }

    .blog-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12);
    }

    [data-theme='dark'] .blog-card {
        background: #1a202c;
        border-left-color: #a78bbd;
    }

    .blog-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: 1rem;
    }

    .blog-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: #1a202c;
        margin-bottom: 0.5rem;
    }

    [data-theme='dark'] .blog-title {
        color: #e9ecef;
    }

    .blog-meta {
        display: flex;
        gap: 1.5rem;
        font-size: 0.875rem;
        color: #6b7280;
        margin-bottom: 1rem;
    }

    [data-theme='dark'] .blog-meta {
        color: #9ca3af;
    }

    .blog-meta-item {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .blog-content-preview {
        color: #4b5563;
        line-height: 1.6;
        margin-bottom: 1rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }

    [data-theme='dark'] .blog-content-preview {
        color: #cbd5e0;
    }

    .blog-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .blog-tag {
        background: #e0e7ff;
        color: #4c51bf;
        padding: 0.25rem 0.75rem;
        border-radius: 50px;
        font-size: 0.75rem;
        font-weight: 600;
    }

    [data-theme='dark'] .blog-tag {
        background: rgba(167, 139, 189, 0.2);
        color: #a78bbd;
    }

    .blog-actions {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .blog-status-badge {
        padding: 0.5rem 1rem;
        border-radius: 50px;
        font-size: 0.875rem;
        font-weight: 600;
    }

    .status-published {
        background: #d1fae5;
        color: #065f46;
    }

    .status-draft {
        background: #fef3c7;
        color: #92400e;
    }

    [data-theme='dark'] .status-published {
        background: rgba(16, 185, 129, 0.2);
        color: #6ee7b7;
    }

    [data-theme='dark'] .status-draft {
        background: rgba(245, 158, 11, 0.2);
        color: #fbbf24;
    }

    .blog-image-thumb {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 12px;
        margin-left: 1rem;
    }

    .filter-bar {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }

    [data-theme='dark'] .filter-bar {
        background: #1a202c;
    }

    .search-input-group {
        position: relative;
    }

    .search-input-group i {
        position: absolute;
        right: 1rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
    }

    .search-input {
        padding-right: 3rem;
        border-radius: 12px;
        border: 2px solid #e5e7eb;
    }

    [data-theme='dark'] .search-input {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.1);
        color: #e9ecef;
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
    }

    .empty-state i {
        font-size: 4rem;
        color: #cbd5e0;
        margin-bottom: 1rem;
    }

    .empty-state h3 {
        color: #4b5563;
        margin-bottom: 0.5rem;
    }

    [data-theme='dark'] .empty-state h3 {
        color: #cbd5e0;
    }
</style>
{% endblock %}

{% block admin_content %}
<div class="container-fluid">
    <!-- Page Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">{% trans "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø§Øª" %}</h2>
            <p class="text-muted mb-0">{% trans "Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ­Ø±ÙŠØ± ÙˆØ­Ø°Ù Ø§Ù„Ù…Ø¯ÙˆÙ†Ø§Øª" %}</p>
        </div>
        <button class="btn btn-primary" data-action="create-blog">
            <i class="fas fa-plus me-2"></i>
            {% trans "Ù…Ø¯ÙˆÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©" %}
        </button>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="blog-stats-card">
                <div class="stat-item">
                    <div class="stat-value">{{ total_blogs }}</div>
                    <div class="stat-label">{% trans "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø§Øª" %}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="blog-stats-card" style="background: linear-gradient(135deg, rgba(75, 49, 94, 0.9) 0%, rgba(255, 96, 1, 0.8) 100%);">
                <div class="stat-item">
                    <div class="stat-value">{{ published_blogs }}</div>
                    <div class="stat-label">{% trans "Ù…Ù†Ø´ÙˆØ±" %}</div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="blog-stats-card" style="background: linear-gradient(135deg, rgba(75, 49, 94, 0.8) 0%, rgba(255, 96, 1, 0.9) 100%);">
                <div class="stat-item">
                    <div class="stat-value">{{ draft_blogs }}</div>
                    <div class="stat-label">{% trans "Ù…Ø³ÙˆØ¯Ø§Øª" %}</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
        <form method="get" class="row g-3" id="filterForm">
            <div class="col-md-4">
                <div class="search-input-group">
                    <i class="fas fa-search"></i>
                    <input type="text" name="search" class="form-control search-input"
                           placeholder="{% trans 'Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø§Øª...' %}"
                           value="{{ search_query }}">
                </div>
            </div>
            <div class="col-md-3">
                <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="all" {% if status_filter == 'all' %}selected{% endif %}>{% trans "Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø§Øª" %}</option>
                    <option value="published" {% if status_filter == 'published' %}selected{% endif %}>{% trans "Ù…Ù†Ø´ÙˆØ±" %}</option>
                    <option value="draft" {% if status_filter == 'draft' %}selected{% endif %}>{% trans "Ù…Ø³ÙˆØ¯Ø©" %}</option>
                </select>
            </div>
            <div class="col-md-3">
                <select name="sort" class="form-select" onchange="this.form.submit()">
                    <option value="-published_date" {% if sort_by == '-published_date' %}selected{% endif %}>{% trans "Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹" %}</option>
                    <option value="published_date" {% if sort_by == 'published_date' %}selected{% endif %}>{% trans "Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹" %}</option>
                    <option value="title" {% if sort_by == 'title' %}selected{% endif %}>{% trans "Ø§Ù„Ø¹Ù†ÙˆØ§Ù† (Ø£-ÙŠ)" %}</option>
                    <option value="-likes_count" {% if sort_by == '-likes_count' %}selected{% endif %}>{% trans "Ø§Ù„Ø£ÙƒØ«Ø± Ø¥Ø¹Ø¬Ø§Ø¨Ø§Ù‹" %}</option>
                </select>
            </div>
            <div class="col-md-2">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-filter me-2"></i>
                    {% trans "ØªØ·Ø¨ÙŠÙ‚" %}
                </button>
            </div>
        </form>
    </div>

    <!-- Blogs List -->
    {% if blogs %}
        {% for blog in blogs %}
        <div class="blog-card">
            <div class="d-flex">
                <div class="flex-grow-1">
                    <div class="blog-header">
                        <div>
                            <h3 class="blog-title">{{ blog.title }}</h3>
                            <span class="blog-status-badge {% if blog.is_published %}status-published{% else %}status-draft{% endif %}">
                                {% if blog.is_published %}
                                    <i class="fas fa-check-circle me-1"></i> {% trans "Ù…Ù†Ø´ÙˆØ±" %}
                                {% else %}
                                    <i class="fas fa-clock me-1"></i> {% trans "Ù…Ø³ÙˆØ¯Ø©" %}
                                {% endif %}
                            </span>
                        </div>
                    </div>

                    <div class="blog-meta">
                        <div class="blog-meta-item">
                            <i class="fas fa-user"></i>
                            <span>{{ blog.author.username }}</span>
                        </div>
                        <div class="blog-meta-item">
                            <i class="fas fa-calendar"></i>
                            <span>{{ blog.published_date|date:"Y/m/d" }}</span>
                        </div>
                        <div class="blog-meta-item">
                            <i class="fas fa-heart"></i>
                            <span>{{ blog.likes_count }} {% trans "Ø¥Ø¹Ø¬Ø§Ø¨" %}</span>
                        </div>
                        <div class="blog-meta-item">
                            <i class="fas fa-comments"></i>
                            <span>{{ blog.comments_count }} {% trans "ØªØ¹Ù„ÙŠÙ‚" %}</span>
                        </div>
                    </div>

                    <p class="blog-content-preview">{{ blog.content|striptags|truncatewords:30 }}</p>

                    {% if blog.tags.all %}
                    <div class="blog-tags">
                        {% for tag in blog.tags.all %}
                        <span class="blog-tag">
                            <i class="fas fa-tag me-1"></i>{{ tag.name }}
                        </span>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <div class="blog-actions">
                        <button class="btn btn-sm btn-primary" data-action="edit-blog" data-blog-id="{{ blog.id }}">
                            <i class="fas fa-edit me-1"></i> {% trans "ØªØ¹Ø¯ÙŠÙ„" %}
                        </button>
                        <button class="btn btn-sm btn-warning" data-action="toggle-publish" data-blog-id="{{ blog.id }}" data-is-published="{{ blog.is_published|lower }}">
                            <i class="fas fa-sync-alt me-1"></i>
                            {% if blog.is_published %}{% trans "ØªØ­ÙˆÙŠÙ„ Ù„Ù…Ø³ÙˆØ¯Ø©" %}{% else %}{% trans "Ù†Ø´Ø±" %}{% endif %}
                        </button>
                        <a href="{{ blog.get_absolute_url }}" target="_blank" class="btn btn-sm btn-info">
                            <i class="fas fa-eye me-1"></i> {% trans "Ø¹Ø±Ø¶" %}
                        </a>
                        <button class="btn btn-sm btn-danger" data-action="delete-blog" data-blog-id="{{ blog.id }}" data-blog-title="{{ blog.title }}">
                            <i class="fas fa-trash me-1"></i> {% trans "Ø­Ø°Ù" %}
                        </button>
                    </div>
                </div>

                {% if blog.image %}
                <div>
                    <img src="{{ blog.image.url }}" alt="{{ blog.title }}" class="blog-image-thumb">
                </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}

        <!-- Pagination -->
        {% if blogs.has_other_pages %}
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                {% if blogs.has_previous %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ blogs.previous_page_number }}&status={{ status_filter }}&search={{ search_query }}&sort={{ sort_by }}">
                        {% trans "Ø§Ù„Ø³Ø§Ø¨Ù‚" %}
                    </a>
                </li>
                {% endif %}

                {% for num in blogs.paginator.page_range %}
                    {% if blogs.number == num %}
                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                    {% elif num > blogs.number|add:'-3' and num < blogs.number|add:'3' %}
                    <li class="page-item">
                        <a class="page-link" href="?page={{ num }}&status={{ status_filter }}&search={{ search_query }}&sort={{ sort_by }}">{{ num }}</a>
                    </li>
                    {% endif %}
                {% endfor %}

                {% if blogs.has_next %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ blogs.next_page_number }}&status={{ status_filter }}&search={{ search_query }}&sort={{ sort_by }}">
                        {% trans "Ø§Ù„ØªØ§Ù„ÙŠ" %}
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="empty-state">
            <i class="fas fa-blog"></i>
            <h3>{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø¯ÙˆÙ†Ø§Øª" %}</h3>
            <p class="text-muted">{% trans "Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¯ÙˆÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©" %}</p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block modals %}
<!-- IMPORTANT: Modals MUST be placed outside the main content container to avoid z-index/overflow issues -->

<!-- Create/Edit Blog Modal -->
<div class="modal fade" id="blogModal" tabindex="-1" aria-labelledby="blogModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="blogModalLabel">
                    <i class="fas fa-blog me-2"></i>
                    <span id="modalTitle">{% trans "Ù…Ø¯ÙˆÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©" %}</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="blogForm" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" id="blogId" name="blog_id">

                    <div class="mb-3">
                        <label for="blogTitle" class="form-label">{% trans "Ø§Ù„Ø¹Ù†ÙˆØ§Ù†" %} <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="blogTitle" name="title" required>
                    </div>

                    <div class="mb-3">
                        <label for="blogContent" class="form-label">{% trans "Ø§Ù„Ù…Ø­ØªÙˆÙ‰" %} <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="blogContent" name="content" rows="10" required></textarea>
                    </div>

                    <div class="mb-3">
                        <label for="blogImage" class="form-label">{% trans "Ø§Ù„ØµÙˆØ±Ø©" %}</label>
                        <input type="file" class="form-control" id="blogImage" name="image" accept="image/*">
                        <div id="currentImage" class="mt-2" style="display: none;">
                            <img id="currentImagePreview" src="" alt="Current image" style="max-width: 200px; border-radius: 8px;">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="blogTags" class="form-label">{% trans "Ø§Ù„ÙˆØ³ÙˆÙ…" %}</label>
                        <input type="text" class="form-control" id="blogTags" name="tags" placeholder="{% trans 'Ø§ÙØµÙ„ Ø§Ù„ÙˆØ³ÙˆÙ… Ø¨ÙØ§ØµÙ„Ø©' %}">
                        <small class="form-text text-muted">{% trans "Ù…Ø«Ø§Ù„: ØªÙ‚Ù†ÙŠØ©, Ø¨Ø±Ù…Ø¬Ø©, ØªØ·ÙˆÙŠØ±" %}</small>
                    </div>

                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="blogPublished" name="is_published" checked>
                            <label class="form-check-label" for="blogPublished">
                                {% trans "Ù†Ø´Ø± Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    {% trans "Ø¥Ù„ØºØ§Ø¡" %}
                </button>
                <button type="button" class="btn btn-primary" id="saveBlogBtn">
                    <i class="fas fa-save me-2"></i>
                    {% trans "Ø­ÙØ¸" %}
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">
                    <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                    {% trans "ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø­Ø°Ù" %}
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>{% trans "Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %} "<strong id="deleteBlogTitle"></strong>"ØŸ</p>
                <p class="text-danger fw-bold">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    {% trans "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡" %}
                </p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>
                    {% trans "Ø¥Ù„ØºØ§Ø¡" %}
                </button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">
                    <i class="fas fa-trash me-2"></i>
                    {% trans "Ø­Ø°Ù" %}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock modals %}

{% block admin_extra_js %}
<script>
    let currentBlogId = null;
    let currentDeleteId = null;
    let editorInstance = null;

    // URL patterns with language prefix
    const BLOG_URLS = {
        create: '{% url "main:admin_blog_create" %}',
        update: (id) => `{% url "main:admin_blog_update" 0 %}`.replace('/0/', `/${id}/`),
        delete: (id) => `{% url "main:admin_blog_delete" 0 %}`.replace('/0/', `/${id}/`),
        togglePublish: (id) => `{% url "main:admin_blog_toggle_publish" 0 %}`.replace('/0/', `/${id}/`)
    };

    // CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Show notification
    function showNotification(message, type = 'success') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 10800; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
        notification.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>${message}`;
        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.opacity = '0';
            notification.style.transition = 'opacity 0.3s ease';
            setTimeout(() => notification.remove(), 300);
        }, 3000);
    }

    // Initialize Bootstrap modals on page load with debugging
    document.addEventListener('DOMContentLoaded', function() {
        console.log('ğŸ¯ Initializing modals...');
        console.log('Bootstrap available:', typeof bootstrap !== 'undefined');
        console.log('Bootstrap.Modal available:', typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined');

        const modalElements = document.querySelectorAll('.modal');
        console.log('Found modals:', modalElements.length);

        modalElements.forEach(function(modalEl) {
            console.log('Initializing modal:', modalEl.id);
            if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                try {
                    const existingModal = bootstrap.Modal.getInstance(modalEl);
                    if (!existingModal) {
                        const newModal = new bootstrap.Modal(modalEl);
                        console.log('âœ… Modal initialized:', modalEl.id);
                    } else {
                        console.log('âœ… Modal already initialized:', modalEl.id);
                    }
                } catch (error) {
                    console.error('âŒ Modal initialization error:', modalEl.id, error);
                }
            }
        });

        // Test event delegation
        console.log('ğŸ” Testing buttons with data-action...');
        const buttons = document.querySelectorAll('[data-action]');
        console.log('Found buttons with data-action:', buttons.length);
        buttons.forEach(btn => {
            console.log('  - Button:', btn.dataset.action, btn.textContent.trim());
        });

        console.log('âœ… Modal initialization complete');
    });

    // Event Delegation
    document.addEventListener('click', function(e) {
        const target = e.target.closest('[data-action]');
        if (!target) return;

        const action = target.dataset.action;
        console.log('ğŸ‘‰ Button clicked:', action, target.dataset);

        switch(action) {
            case 'create-blog':
                console.log('âœ… Opening create modal...');
                openCreateModal();
                break;

            case 'edit-blog':
                console.log('âœ… Opening edit modal for blog:', target.dataset.blogId);
                openEditModal(target.dataset.blogId);
                break;

            case 'delete-blog':
                console.log('âœ… Opening delete modal for blog:', target.dataset.blogId);
                openDeleteModal(target.dataset.blogId, target.dataset.blogTitle);
                break;

            case 'toggle-publish':
                console.log('âœ… Toggling publish status for blog:', target.dataset.blogId);
                togglePublishStatus(target.dataset.blogId, target.dataset.isPublished === 'true');
                break;
        }
    });

    // Initialize CKEditor
    function initializeCKEditor() {
        if (editorInstance) {
            editorInstance.destroy().then(() => {
                createEditor();
            });
        } else {
            createEditor();
        }
    }

    function createEditor() {
        CKEDITOR.ClassicEditor.create(document.getElementById('blogContent'), {
            language: 'ar',
            // Remove plugins that require collaboration features, special containers, or premium license
            removePlugins: [
                'RealTimeCollaborativeEditing', 'RealTimeCollaborativeComments', 'RealTimeCollaborativeTrackChanges',
                'RealTimeCollaborativeRevisionHistory', 'PresenceList', 'Comments', 'TrackChanges', 'TrackChangesData',
                'RevisionHistory', 'Pagination', 'WProofreader', 'MathType', 'SlashCommand', 'DocumentOutline',
                'AIAssistant', 'TableOfContents', 'FormatPainter', 'Template', 'PasteFromOfficeEnhanced',
                'CKBox', 'CKFinder', 'EasyImage', 'RealTimeCollaboration', 'ExportPdf', 'ExportWord',
                'MultiLevelList', 'CaseChange'
            ],
            toolbar: {
                items: [
                    'heading', '|',
                    'fontSize', 'fontFamily', 'fontColor', 'fontBackgroundColor', '|',
                    'bold', 'italic', 'underline', 'strikethrough', 'code', 'subscript', 'superscript', '|',
                    'link', 'bulletedList', 'numberedList', 'todoList', '|',
                    'alignment', 'indent', 'outdent', '|',
                    'blockQuote', 'codeBlock', 'htmlEmbed', '|',
                    'imageUpload', 'insertTable', 'mediaEmbed', 'horizontalLine', 'pageBreak', '|',
                    'highlight', 'removeFormat', '|',
                    'findAndReplace', '|',
                    'undo', 'redo', '|',
                    'sourceEditing'
                ],
                shouldNotGroupWhenFull: true
            },
            fontSize: {
                options: [9, 11, 13, 'default', 17, 19, 21, 24, 28, 32, 36]
            },
            fontFamily: {
                options: [
                    'default',
                    'Arial, Helvetica, sans-serif',
                    'Courier New, Courier, monospace',
                    'Georgia, serif',
                    'Lucida Sans Unicode, Lucida Grande, sans-serif',
                    'Tahoma, Geneva, sans-serif',
                    'Times New Roman, Times, serif',
                    'Trebuchet MS, Helvetica, sans-serif',
                    'Verdana, Geneva, sans-serif'
                ]
            },
            htmlEmbed: {
                showPreviews: true
            },
            codeBlock: {
                languages: [
                    { language: 'plaintext', label: 'Plain text' },
                    { language: 'c', label: 'C' },
                    { language: 'cs', label: 'C#' },
                    { language: 'cpp', label: 'C++' },
                    { language: 'css', label: 'CSS' },
                    { language: 'diff', label: 'Diff' },
                    { language: 'html', label: 'HTML' },
                    { language: 'java', label: 'Java' },
                    { language: 'javascript', label: 'JavaScript' },
                    { language: 'php', label: 'PHP' },
                    { language: 'python', label: 'Python' },
                    { language: 'ruby', label: 'Ruby' },
                    { language: 'typescript', label: 'TypeScript' },
                    { language: 'xml', label: 'XML' }
                ]
            },
            image: {
                toolbar: [
                    'imageTextAlternative', '|',
                    'imageStyle:inline', 'imageStyle:wrapText', 'imageStyle:breakText', '|',
                    'imageStyle:block', 'imageStyle:side', 'imageStyle:alignLeft', 'imageStyle:alignRight', 'imageStyle:alignCenter', '|',
                    'toggleImageCaption', 'linkImage'
                ]
            },
            table: {
                contentToolbar: [
                    'tableColumn', 'tableRow', 'mergeTableCells',
                    'tableProperties', 'tableCellProperties', 'toggleTableCaption'
                ]
            },
            heading: {
                options: [
                    { model: 'paragraph', title: 'Paragraph', class: 'ck-heading_paragraph' },
                    { model: 'heading1', view: 'h1', title: 'Heading 1', class: 'ck-heading_heading1' },
                    { model: 'heading2', view: 'h2', title: 'Heading 2', class: 'ck-heading_heading2' },
                    { model: 'heading3', view: 'h3', title: 'Heading 3', class: 'ck-heading_heading3' },
                    { model: 'heading4', view: 'h4', title: 'Heading 4', class: 'ck-heading_heading4' }
                ]
            }
        }).then(editor => {
            editorInstance = editor;
            console.log('âœ… CKEditor initialized with enhanced toolbar (40+ tools)');
        }).catch(error => {
            console.error('âŒ CKEditor initialization error:', error);
        });
    }

    // Open Create Modal
    function openCreateModal() {
        console.log('ğŸ“ Opening create modal...');
        currentBlogId = null;
        document.getElementById('modalTitle').textContent = '{% trans "Ù…Ø¯ÙˆÙ†Ø© Ø¬Ø¯ÙŠØ¯Ø©" %}';
        document.getElementById('blogForm').reset();
        document.getElementById('blogId').value = '';
        document.getElementById('currentImage').style.display = 'none';

        const modalEl = document.getElementById('blogModal');
        console.log('Modal element found:', !!modalEl);

        if (modalEl) {
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                console.log('Creating new modal instance...');
                modal = new bootstrap.Modal(modalEl);
            }
            console.log('Showing modal...');
            modal.show();
            console.log('âœ… Modal shown');

            // Initialize CKEditor after modal is shown
            setTimeout(() => initializeCKEditor(), 300);
        } else {
            console.error('âŒ Modal element not found!');
        }
    }

    // Open Edit Modal
    async function openEditModal(blogId) {
        currentBlogId = blogId;

        try {
            const response = await fetch(BLOG_URLS.update(blogId), {
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                console.error('âŒ Response is not JSON:', response.status);
                if (response.status === 403 || response.status === 401) {
                    showNotification('{% trans "Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ© Ù„Ù„ÙˆØµÙˆÙ„. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„." %}', 'error');
                    setTimeout(() => {
                        window.location.href = '{% url "main:login" %}';
                    }, 2000);
                } else {
                    showNotification('{% trans "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
                }
                return;
            }

            const data = await response.json();

            if (data.success) {
                document.getElementById('modalTitle').textContent = '{% trans "ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}';
                document.getElementById('blogId').value = data.blog.id;
                document.getElementById('blogTitle').value = data.blog.title;
                document.getElementById('blogTags').value = data.blog.tags;
                document.getElementById('blogPublished').checked = data.blog.is_published;

                if (data.blog.image_url) {
                    document.getElementById('currentImagePreview').src = data.blog.image_url;
                    document.getElementById('currentImage').style.display = 'block';
                }

                const modalEl = document.getElementById('blogModal');
                if (modalEl) {
                    let modal = bootstrap.Modal.getInstance(modalEl);
                    if (!modal) {
                        modal = new bootstrap.Modal(modalEl);
                    }
                    modal.show();
                    console.log('âœ… Edit modal shown');

                    // Initialize CKEditor and set content after modal is shown
                    setTimeout(() => {
                        initializeCKEditor();
                        setTimeout(() => {
                            if (editorInstance) {
                                editorInstance.setData(data.blog.content);
                            }
                        }, 500);
                    }, 300);
                }
            } else {
                showNotification(data.error || '{% trans "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª" %}', 'error');
            }
        } catch (error) {
            console.error('Error loading blog:', error);
            showNotification('{% trans "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
        }
    }

    // Save Blog
    document.getElementById('saveBlogBtn').addEventListener('click', async function() {
        console.log('ğŸ’¾ Save button clicked');
        const form = document.getElementById('blogForm');
        const formData = new FormData(form);

        // Get content from CKEditor
        if (editorInstance) {
            const content = editorInstance.getData();
            formData.set('content', content);
            console.log('ğŸ“ Content from CKEditor:', content.substring(0, 100) + '...');
        }

        const isPublished = document.getElementById('blogPublished').checked;
        formData.set('is_published', isPublished);
        console.log('ğŸ“¢ Is Published:', isPublished);

        const url = currentBlogId
            ? BLOG_URLS.update(currentBlogId)
            : BLOG_URLS.create;

        console.log('ğŸŒ Request URL:', url);
        console.log('ğŸ“¦ Current Blog ID:', currentBlogId);

        // Log form data
        console.log('ğŸ“‹ Form Data:');
        for (let pair of formData.entries()) {
            if (pair[0] !== 'content') {
                console.log(`  ${pair[0]}: ${pair[1]}`);
            } else {
                console.log(`  ${pair[0]}: [content]`);
            }
        }

        try {
            const csrfToken = getCookie('csrftoken');
            console.log('ğŸ” CSRF Token:', csrfToken ? 'Found' : 'Missing');

            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: formData
            });

            console.log('ğŸ“¡ Response Status:', response.status);
            console.log('ğŸ“¡ Response OK:', response.ok);

            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            console.log('ğŸ“„ Response Content-Type:', contentType);

            if (!contentType || !contentType.includes("application/json")) {
                console.error('âŒ Response is not JSON');
                if (response.status === 403 || response.status === 401) {
                    showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„.', 'error');
                    setTimeout(() => window.location.href = '{% url "main:login" %}', 2000);
                } else {
                    // Try to get the text response for debugging
                    const text = await response.text();
                    console.error('Response text:', text.substring(0, 500));
                    showNotification('{% trans "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
                }
                return;
            }

            const data = await response.json();
            console.log('âœ… Response Data:', data);

            if (data.success) {
                showNotification(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('blogModal')).hide();

                // Destroy editor instance before reload
                if (editorInstance) {
                    editorInstance.destroy().then(() => {
                        editorInstance = null;
                        setTimeout(() => location.reload(), 1000);
                    });
                } else {
                    setTimeout(() => location.reload(), 1000);
                }
            } else {
                console.error('âŒ Error from server:', data.error);
                showNotification(data.error, 'error');
            }
        } catch (error) {
            console.error('âŒ Error saving blog:', error);
            showNotification('{% trans "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
        }
    });

    // Open Delete Modal
    function openDeleteModal(blogId, blogTitle) {
        console.log('ğŸ—‘ï¸ Opening delete modal...');
        currentDeleteId = blogId;
        document.getElementById('deleteBlogTitle').textContent = blogTitle;

        const modalEl = document.getElementById('deleteModal');
        if (modalEl) {
            let modal = bootstrap.Modal.getInstance(modalEl);
            if (!modal) {
                modal = new bootstrap.Modal(modalEl);
            }
            modal.show();
            console.log('âœ… Delete modal shown');
        }
    }

    // Confirm Delete
    document.getElementById('confirmDeleteBtn').addEventListener('click', async function() {
        if (!currentDeleteId) return;

        try {
            const response = await fetch(BLOG_URLS.delete(currentDeleteId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                if (response.status === 403 || response.status === 401) {
                    showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„.', 'error');
                    setTimeout(() => window.location.href = '{% url "main:login" %}', 2000);
                } else {
                    showNotification('{% trans "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
                }
                return;
            }

            const data = await response.json();

            if (data.success) {
                showNotification(data.message, 'success');
                bootstrap.Modal.getInstance(document.getElementById('deleteModal')).hide();
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error, 'error');
            }
        } catch (error) {
            console.error('Error deleting blog:', error);
            showNotification('{% trans "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
        }
    });

    // Toggle Publish Status
    async function togglePublishStatus(blogId, currentStatus) {
        try {
            const response = await fetch(BLOG_URLS.togglePublish(blogId), {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // Check if response is JSON
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                if (response.status === 403 || response.status === 401) {
                    showNotification('Ù„ÙŠØ³ Ù„Ø¯ÙŠÙƒ ØµÙ„Ø§Ø­ÙŠØ©. ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙƒÙ…Ø³Ø¤ÙˆÙ„.', 'error');
                    setTimeout(() => window.location.href = '{% url "main:login" %}', 2000);
                } else {
                    showNotification('{% trans "Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
                }
                return;
            }

            const data = await response.json();

            if (data.success) {
                showNotification(data.message, 'success');
                setTimeout(() => location.reload(), 1000);
            } else {
                showNotification(data.error, 'error');
            }
        } catch (error) {
            console.error('Error toggling status:', error);
            showNotification('{% trans "Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}', 'error');
        }
    }
</script>
{% endblock %}
