{% extends 'admin_dashboard/base.html' %}
{% load static i18n %}

{% block title %}{% trans "إدارة الإعلانات" %}{% endblock %}

{% block admin_extra_css %}
<style>
    /* Rating Stars Styling */
    .rating-stars-small {
        display: inline-flex;
        gap: 2px;
        font-size: 0.75rem;
    }

    .rating-stars-small i {
        color: #f59e0b;
    }

    /* Bootstrap modals automatically use global z-index from admin-dashboard.css */
    /* Modal backdrop: 10500, Modal: 10600, Modal dialog: 10700 */
        position: relative;
        margin: auto;
    }

    [data-theme='dark'] .modal-content {
        background: #1e1e2e;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f3f4f6;
    }

    [data-theme='dark'] .modal-header {
        border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .modal-header h2 {
        font-size: 1.5rem;
        font-weight: 700;
        color: #1a202c;
        margin: 0;
    }

    [data-theme='dark'] .modal-header h2 {
        color: #e5e7eb;
    }

    .btn-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6b7280;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .btn-close:hover {
        background: #f3f4f6;
        color: #1a202c;
    }

    [data-theme='dark'] .btn-close:hover {
        background: rgba(255, 255, 255, 0.1);
        color: #e5e7eb;
    }

    .modal-body {
        margin-bottom: 0;
    }

    .form-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 2px solid #f3f4f6;
    }

    [data-theme='dark'] .form-actions {
        border-top-color: rgba(255, 255, 255, 0.1);
    }

    .btn-cancel {
        background: #f3f4f6;
        color: #4b5563;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-cancel:hover {
        background: #e5e7eb;
    }

    [data-theme='dark'] .btn-cancel {
        background: rgba(255, 255, 255, 0.1);
        color: #d1d5db;
    }

    [data-theme='dark'] .btn-cancel:hover {
        background: rgba(255, 255, 255, 0.15);
    }

    .btn-danger {
        background: linear-gradient(135deg, #ef4444, #dc2626);
        color: white;
        padding: 10px 20px;
        border-radius: 8px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .btn-danger:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(239, 68, 68, 0.4);
    }
</style>
{% endblock %}

{% block admin_content %}
    <!-- Header -->
    <div class="admin-dashboard-header">
        <div class="row align-items-center">
            <div class="col">
                <h1 class="display-6 mb-1">
                    <i class="fas fa-bullhorn me-3"></i>
                    {% trans "إدارة الإعلانات" %}
                </h1>
                <p class="text-muted mb-0">{% trans "مراجعة، تعديل، وحذف الإعلانات على المنصة" %}</p>
            </div>
            <div class="col-auto">
                <div class="admin-quick-stats">
                    <span class="badge bg-primary fs-6">
                        {% trans "الإعلانات" %}: {{ paginator.count|default:0 }}
                    </span>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <div class="col-12">
            <div class="admin-content-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        {% trans "قائمة الإعلانات" %}
                    </h5>
                </div>
                <div class="card-body">
                    <!-- Tabs -->
                    <div class="nav nav-tabs admin-tabs mb-4" role="tablist">
                        <a class="nav-link nav-link-theme {% if current_tab == 'active' %}active{% endif %}" href="?tab=active">
                            {% trans "نشط" %} <span class="badge bg-success ms-1">{{ tab_counts.active|default:0 }}</span>
                        </a>
                        <a class="nav-link nav-link-theme {% if current_tab == 'pending' %}active{% endif %}" href="?tab=pending">
                            {% trans "قيد المراجعة" %} <span class="badge bg-warning ms-1">{{ tab_counts.pending|default:0 }}</span>
                        </a>
                        <a class="nav-link nav-link-theme {% if current_tab == 'expired' %}active{% endif %}" href="?tab=expired">
                            {% trans "منتهي" %} <span class="badge bg-danger ms-1">{{ tab_counts.expired|default:0 }}</span>
                        </a>
                        <a class="nav-link nav-link-theme {% if current_tab == 'hidden' %}active{% endif %}" href="?tab=hidden">
                            {% trans "مخفي" %} <span class="badge bg-secondary ms-1">{{ tab_counts.hidden|default:0 }}</span>
                        </a>
                        <a class="nav-link nav-link-theme {% if current_tab == 'cart' %}active{% endif %}" href="?tab=cart">
                            {% trans "متاح للسلة" %} <span class="badge bg-info ms-1">{{ tab_counts.cart|default:0 }}</span>
                        </a>
                    </div>

                    <!-- Search and Filter -->
                    <div class="mb-4">
                        <form method="get" class="search-form">
                            <input type="hidden" name="tab" value="{{ current_tab }}">
                            <div class="input-group">
                                <input type="text" name="search" class="form-control" placeholder="{% trans 'ابحث بالاسم أو المستخدم...' %}" value="{{ search_query }}">
                                <button class="btn btn-primary" type="submit">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Ads Table -->
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead>
                                <tr>
                                    <th>{% trans "الإعلان" %}</th>
                                    <th>{% trans "المستخدم" %}</th>
                                    <th>{% trans "السعر" %}</th>
                                    <th>{% trans "التقييم" %}</th>
                                    <th>{% trans "الحالة" %}</th>
                                    <th>{% trans "تاريخ النشر" %}</th>
                                    <th>{% trans "إجراءات" %}</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for ad in page_obj %}
                                <tr class="ad-item-row">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            {% if ad.images.first %}
                                                <img src="{{ ad.images.first.image.url }}" alt="{{ ad.title }}" class="ad-thumbnail me-3" loading="lazy">
                                            {% else %}
                                                <div class="ad-thumbnail bg-light me-3 d-flex align-items-center justify-content-center">
                                                    <i class="fas fa-image text-muted"></i>
                                                </div>
                                            {% endif %}
                                            <div>
                                                <a href="{% url 'main:ad_publisher_detail' ad.id %}" class="fw-bold text-dark text-decoration-none">{{ ad.title|truncatechars:40 }}</a>
                                                <div class="text-muted small">{{ ad.category.name }}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><a href="#">{{ ad.user.username }}</a></td>
                                    <td>
                                        {% if ad.hide_price %}
                                            <span class="badge bg-danger">
                                                <i class="fas fa-eye-slash"></i> {% trans "مخفي" %}
                                            </span>
                                        {% elif ad.price_on_request %}
                                            <span class="badge bg-warning">
                                                <i class="fas fa-file-invoice-dollar"></i> {% trans "عند الطلب" %}
                                            </span>
                                        {% else %}
                                            <strong>{{ ad.price|floatformat:2 }}</strong>
                                            {% if ad.is_negotiable %}
                                                <i class="fas fa-handshake text-success ms-1" title="{% trans 'قابل للتفاوض' %}"></i>
                                            {% endif %}
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if ad.rating %}
                                            <div class="d-flex align-items-center">
                                                <div class="rating-stars-small me-2">
                                                    {% with rating_int=ad.rating|floatformat:0|add:"0" %}
                                                    {% for i in "12345" %}
                                                        {% if forloop.counter <= rating_int %}
                                                            <i class="fas fa-star text-warning"></i>
                                                        {% elif forloop.counter == rating_int|add:"1" and ad.rating|floatformat:1|slice:"-3:" != ".0" %}
                                                            <i class="fas fa-star-half-alt text-warning"></i>
                                                        {% else %}
                                                            <i class="far fa-star text-warning"></i>
                                                        {% endif %}
                                                    {% endfor %}
                                                    {% endwith %}
                                                </div>
                                                <span class="badge bg-warning text-dark">{{ ad.rating|floatformat:1 }}</span>
                                                {% if ad.rating_count %}
                                                    <small class="text-muted ms-1">({{ ad.rating_count }})</small>
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">-</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge rounded-pill bg-light text-dark status-{{ ad.status }}">
                                            {{ ad.get_status_display }}
                                        </span>
                                        {% if ad.is_hidden %}
                                            <span class="badge rounded-pill bg-secondary">{% trans "مخفي" %}</span>
                                        {% endif %}
                                    </td>
                                    <td>{{ ad.created_at|date:"d M, Y" }}</td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            <a href="{% url 'main:ad_publisher_detail' ad.id %}" class="btn btn-sm btn-outline-primary" title="{% trans 'عرض' %}"><i class="fas fa-eye"></i></a>
                                            <button type="button" class="btn btn-sm btn-outline-success chat-btn" title="{% trans 'محادثة مع الناشر' %}" data-action="open-chat" data-user-id="{{ ad.user.id }}" data-user-name="{{ ad.user.get_full_name|default:ad.user.username|escapejs }}"><i class="fas fa-comments"></i></button>
                                            <button class="btn btn-sm btn-outline-danger" data-action="delete-ad" data-ad-id="{{ ad.id }}" data-ad-title="{{ ad.title|escapejs }}" title="{% trans 'حذف' %}"><i class="fas fa-trash"></i></button>
                                        </div>
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center py-5">
                                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                        <p class="text-muted">{% trans "لا توجد إعلانات تطابق هذه المعايير." %}</p>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if is_paginated %}
                    <div class="pagination-container">
                        <ul class="pagination">
                            {% if page_obj.has_previous %}
                                <li class="page-item">
                                    <a class="page-link" href="?page=1&tab={{ current_tab }}&search={{ search_query }}" aria-label="First">
                                        <i class="fas fa-angle-double-right"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.previous_page_number }}&tab={{ current_tab }}&search={{ search_query }}" aria-label="Previous">
                                        <i class="fas fa-angle-right"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-right"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-right"></i></span>
                                </li>
                            {% endif %}

                            {% for num in paginator.page_range %}
                                {% if page_obj.number == num %}
                                    <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                                {% elif num > page_obj.number|add:'-3' and num < page_obj.number|add:'3' %}
                                    <li class="page-item">
                                        <a class="page-link" href="?page={{ num }}&tab={{ current_tab }}&search={{ search_query }}">{{ num }}</a>
                                    </li>
                                {% endif %}
                            {% endfor %}

                            {% if page_obj.has_next %}
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ page_obj.next_page_number }}&tab={{ current_tab }}&search={{ search_query }}" aria-label="Next">
                                        <i class="fas fa-angle-left"></i>
                                    </a>
                                </li>
                                <li class="page-item">
                                    <a class="page-link" href="?page={{ paginator.num_pages }}&tab={{ current_tab }}&search={{ search_query }}" aria-label="Last">
                                        <i class="fas fa-angle-double-left"></i>
                                    </a>
                                </li>
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-left"></i></span>
                                </li>
                                <li class="page-item disabled">
                                    <span class="page-link"><i class="fas fa-angle-double-left"></i></span>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block modals %}
<!-- Confirm Delete Modal -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
        <div class="modal-header">
            <h2>
                <i class="fas fa-exclamation-triangle text-danger me-2"></i>
                {% trans "تأكيد الحذف" %}
            </h2>
            <button class="btn-close" data-action="close-modal" data-modal-id="confirmDeleteModal">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="modal-body">
            <div class="alert alert-warning">
                <i class="fas fa-info-circle me-2"></i>
                {% trans "هل أنت متأكد من حذف الإعلان" %} "<span id="deleteAdTitle"></span>"؟
            </div>
            <p class="text-danger fw-bold">
                <i class="fas fa-exclamation-circle me-2"></i>
                {% trans "لا يمكن التراجع عن هذا الإجراء." %}
            </p>
        </div>
        <div class="form-actions">
            <button type="button" class="btn-primary btn-cancel" data-action="close-modal" data-modal-id="confirmDeleteModal">
                <i class="fas fa-times me-2"></i>
                {% trans "إلغاء" %}
            </button>
            <button type="button" class="btn-danger" id="confirmDeleteBtn">
                <i class="fas fa-trash me-2"></i>
                {% trans "حذف" %}
            </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block admin_extra_js %}
    <script>
        // Initialize Bootstrap modals on page load
        document.addEventListener('DOMContentLoaded', function() {
            const modalElements = document.querySelectorAll('.modal');
            modalElements.forEach(function(modalEl) {
                if (modalEl && typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                    try {
                        bootstrap.Modal.getInstance(modalEl) || new bootstrap.Modal(modalEl);
                    } catch (error) {
                        console.error('Modal initialization error:', error);
                    }
                }
            });
        });

        let adToDeleteId = null;

        function openModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                modal.show();
            }
        }

        function closeModal(modalId) {
            const modalElement = document.getElementById(modalId);
            if (modalElement) {
                const modal = bootstrap.Modal.getInstance(modalElement);
                if (modal) {
                    modal.hide();
                }
            }
        }

        function deleteAd(adId, adTitle) {
            adToDeleteId = adId;
            const titleElement = document.getElementById('deleteAdTitle');
            if (titleElement) {
                titleElement.textContent = adTitle;
            }
            openModal('confirmDeleteModal');
        }

        // Notification Functions
        function showSuccess(message) {
            showNotification(message, 'success');
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} position-fixed top-0 start-50 translate-middle-x mt-3`;
            notification.style.zIndex = '10800';
            notification.style.minWidth = '300px';
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Event delegation for ads management actions
            document.addEventListener('click', function(e) {
                const target = e.target.closest('[data-action]');
                if (!target) return;

                const action = target.dataset.action;

                switch(action) {
                    case 'delete-ad':
                        const adId = parseInt(target.dataset.adId);
                        const adTitle = target.dataset.adTitle;
                        deleteAd(adId, adTitle);
                        break;

                    case 'close-modal':
                        const modalId = target.dataset.modalId;
                        if (modalId) closeModal(modalId);
                        break;
                }
            });

            // Confirm Delete Handler
            document.getElementById('confirmDeleteBtn').addEventListener('click', function() {
                if (!adToDeleteId) return;

                const deleteUrl = `{% url 'main:delete_ad' 0 %}`.replace('/0/', `/${adToDeleteId}/`);

                fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': getCookie('csrftoken')
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        const modalElement = document.getElementById('confirmDeleteModal');
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                        showSuccess(data.message || '{% trans "تم حذف الإعلان بنجاح." %}');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                    } else {
                        showError(data.message || '{% trans "حدث خطأ أثناء الحذف." %}');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showError('{% trans "خطأ في الاتصال بالخادم." %}');
                })
                .finally(() => {
                    adToDeleteId = null;
                });
            });

            // Animate content cards if GSAP is available
            if (typeof gsap !== 'undefined') {
                gsap.fromTo('.admin-content-card', {
                    opacity: 0,
                    y: 20
                }, {
                    opacity: 1,
                    y: 0,
                    duration: 0.6,
                    stagger: 0.15,
                    ease: 'power2.out',
                    delay: 0.3
                });

                // Add animation to pagination on load
                gsap.from(".pagination .page-item", {
                    duration: 0.5,
                    scale: 0.5,
                    opacity: 0,
                    delay: 0.2,
                    stagger: 0.05,
                    ease: "elastic.out(1, 0.5)",
                });
            }
        });

        // Bootstrap modals handle backdrop clicks automatically
        // No custom click handler needed
    </script>
{% endblock %}
