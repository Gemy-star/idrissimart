{% load static compress i18n %}

{% get_current_language as LANGUAGE_CODE %}
<!DOCTYPE html>
<html lang="{{ LANGUAGE_CODE }}"
      dir="{% if LANGUAGE_CODE == 'ar' %}
               rtl
           {% else %}
               ltr
           {% endif %}"
      data-theme="light">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description"
              content="{% trans 'إدريسي مارت - منصة شاملة تجمع كافة الخدمات والمنتجات في مكان واحد' %}">
        <meta name="keywords"
              content="{% trans 'إدريسي مارت، توظيف، دورات تدريبية، خدمات، منتجات' %}">
        <meta name="author" content="Idrisi Mart">
        <!-- Favicon -->
        <link rel="icon"
              type="image/png"
              href="{% static 'images/mini-logo-white-theme.png' %}">
        <title>
            {% trans "إدريسي مارت" %} -

            {% block title %}
                {% trans "الصفحة الرئيسية" %}

            {% endblock title %}
        </title>
        <!-- Bootstrap CSS (Local) -->
        <link id="bootstrap-css"
              rel="stylesheet"
              href="{% static 'bootstrap/css/bootstrap.rtl.min.css' %}">
        <!-- Swiper CSS (Local) -->
        <link rel="stylesheet" href="{% static 'swiper/swiper-bundle.min.css' %}">
        <!-- Font Awesome -->
        <link rel="stylesheet"
              href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
        <!-- Google Fonts - Cairo -->
        <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;900&display=swap"
              rel="stylesheet">
        {% compress css %}
            <!-- Custom CSS -->
            <link id="pagestyle" href="{% static 'css/style.css' %}" rel="stylesheet">
            <link href="{% static 'css/yojad-header.css' %}" rel="stylesheet">
        {% endcompress %}

        {% block extra_css %}

        {% endblock extra_css %}
    </head>
    <body style="font-family: 'Cairo', sans-serif;">
        {% include "partials/_pre_loader.html" %}
        {% include "partials/_header.html" %}

        <main>

            {% block content %}

            {% endblock content %}
        </main>
        {% include "partials/_footer.html" %}

        <!-- Compare Widget -->
        <div class="compare-widget" id="compareWidget">
            <div class="compare-toggle" id="compareToggle">
                <i class="fas fa-exchange-alt"></i>
                <span class="compare-badge" id="compareBadge">0</span>
            </div>

            <div class="compare-panel" id="comparePanel">
                <div class="compare-panel-header">
                    <h6><i class="fas fa-exchange-alt me-2"></i>{% trans "المقارنة" %}</h6>
                    <button class="compare-panel-close" id="comparePanelClose">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div class="compare-items-list" id="compareItemsList">
                    <!-- Compare items will be populated here -->
                </div>

                <div class="compare-panel-actions">
                    <button class="btn btn-primary btn-sm" id="compareViewBtn" disabled>
                        <i class="fas fa-eye me-1"></i>{% trans "عرض المقارنة" %}
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" id="compareClearBtn">
                        <i class="fas fa-trash me-1"></i>{% trans "مسح الكل" %}
                    </button>
                </div>
            </div>
        </div>

        <!-- Back to Top Button -->
        <button class="back-to-top" id="backToTop" aria-label="Back to top">
            <i class="fas fa-arrow-up"></i>
        </button>

        <!-- Chatbot Widget -->
        {% include "chatbot/chatbot_widget.html" %}

        <!-- ============================================ -->
        <!-- CRITICAL: Load GSAP BEFORE other scripts -->
        <!-- ============================================ -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/gsap.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.13.0/ScrollTrigger.min.js"></script>
        <!-- Bootstrap Bundle JS (Local) -->
        <script src="{% static 'bootstrap/js/bootstrap.bundle.min.js' %}"></script>
        <!-- jQuery (Optional, for custom scripts) -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
        <!-- Swiper JS (Local) -->
        <script src="{% static 'swiper/swiper-bundle.min.js' %}"></script>
        <!-- Custom JS - Load AFTER GSAP and jQuery -->
        {% compress js %}
            <script src="{% static 'js/main.js' %}"></script>
            <script src="{% static 'js/cart-wishlist.js' %}"></script>
            <script src="{% static 'js/test-utils.js' %}"></script>
            <script src="{% static 'js/verify-load.js' %}"></script>
        {% endcompress %}
        <!-- Language & RTL/LTR Initialization -->
        <script>
            const html = document.documentElement;
            const savedLang = localStorage.getItem('language') || '{{ LANGUAGE_CODE }}';
            html.setAttribute('lang', savedLang);
            html.setAttribute('dir', savedLang === 'ar' ? 'rtl' : 'ltr');

            // Swap Bootstrap CSS dynamically for language switching
            const bootstrapLink = document.getElementById('bootstrap-css');
            if (savedLang === 'ar') {
                bootstrapLink.href = "{% static 'bootstrap/css/bootstrap.rtl.min.css' %}";
            } else {
                bootstrapLink.href = "{% static 'bootstrap/css/bootstrap.min.css' %}";
            }

            // Initialize widgets when DOM is loaded
            document.addEventListener('DOMContentLoaded', function() {
                initializeCompareWidget();
                initializeBackToTop();
                initializeWishlistButtons();
                initializeGlobalWishlistButtons();
            });

            // Compare Widget Functionality
            function initializeCompareWidget() {
                const compareToggle = document.getElementById('compareToggle');
                const comparePanel = document.getElementById('comparePanel');
                const comparePanelClose = document.getElementById('comparePanelClose');
                const compareBadge = document.getElementById('compareBadge');
                const compareItemsList = document.getElementById('compareItemsList');
                const compareViewBtn = document.getElementById('compareViewBtn');
                const compareClearBtn = document.getElementById('compareClearBtn');

                let compareList = JSON.parse(localStorage.getItem('compareList')) || [];
                let isPanelOpen = false;

                // Update widget UI
                function updateCompareWidget() {
                    const count = compareList.length;

                    // Update badge
                    compareBadge.textContent = count;
                    if (count > 0) {
                        compareBadge.classList.add('show');
                    } else {
                        compareBadge.classList.remove('show');
                    }

                    // Update view button
                    compareViewBtn.disabled = count < 2;

                    // Update items list
                    compareItemsList.innerHTML = '';

                    if (count === 0) {
                        compareItemsList.innerHTML = `
                            <div class="compare-empty">
                                <i class="fas fa-exchange-alt"></i>
                                <p>لا توجد عناصر للمقارنة</p>
                            </div>
                        `;
                    } else {
                        compareList.forEach(item => {
                            const itemEl = document.createElement('div');
                            itemEl.className = 'compare-item';
                            itemEl.innerHTML = `
                                <img src="${item.image}" alt="${item.title}">
                                <div class="compare-item-info">
                                    <p class="compare-item-title">${item.title}</p>
                                </div>
                                <button class="compare-item-remove" data-ad-id="${item.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            `;
                            compareItemsList.appendChild(itemEl);
                        });
                    }

                    // Update all compare buttons on page
                    document.querySelectorAll('.compare-btn').forEach(btn => {
                        const adId = btn.dataset.adId;
                        if (compareList.some(item => item.id == adId)) {
                            btn.classList.add('active');
                        } else {
                            btn.classList.remove('active');
                        }
                    });
                }

                // Toggle panel
                compareToggle.addEventListener('click', function() {
                    isPanelOpen = !isPanelOpen;
                    if (isPanelOpen) {
                        comparePanel.classList.add('show');
                    } else {
                        comparePanel.classList.remove('show');
                    }
                });

                // Close panel
                comparePanelClose.addEventListener('click', function() {
                    isPanelOpen = false;
                    comparePanel.classList.remove('show');
                });

                // View comparison
                compareViewBtn.addEventListener('click', function() {
                    if (compareList.length > 1) {
                        const ids = compareList.map(item => item.id).join(',');
                        window.location.href = `{% url 'main:compare_ads' %}?ids=${ids}`;
                    }
                });

                // Clear all
                compareClearBtn.addEventListener('click', function() {
                    compareList = [];
                    localStorage.removeItem('compareList');
                    updateCompareWidget();
                });

                // Remove item
                compareItemsList.addEventListener('click', function(e) {
                    if (e.target.closest('.compare-item-remove')) {
                        const adId = e.target.closest('.compare-item-remove').dataset.adId;
                        compareList = compareList.filter(item => item.id != adId);
                        localStorage.setItem('compareList', JSON.stringify(compareList));
                        updateCompareWidget();
                    }
                });

                // Global toggle compare function
                window.toggleCompare = function(adId, button) {
                    const adTitle = button.dataset.adTitle;
                    const adImage = button.dataset.adImage;
                    const existingIndex = compareList.findIndex(item => item.id == adId);

                    if (existingIndex > -1) {
                        compareList.splice(existingIndex, 1);
                    } else {
                        if (compareList.length >= 4) {
                            alert('يمكنك مقارنة 4 عناصر كحد أقصى');
                            return;
                        }
                        compareList.push({ id: adId, title: adTitle, image: adImage });
                    }
                    localStorage.setItem('compareList', JSON.stringify(compareList));
                    updateCompareWidget();
                };

                // Initial update
                updateCompareWidget();
                
                // Attach event listeners to compare buttons
                attachCompareListeners();
            }
            
            // Function to attach compare button event listeners
            function attachCompareListeners() {
                document.querySelectorAll('.compare-btn').forEach(btn => {
                    // Remove existing listeners to avoid duplicates
                    btn.removeEventListener('click', handleCompareClick);
                    // Add new listener
                    btn.addEventListener('click', handleCompareClick);
                });
            }
            
            // Compare button click handler
            function handleCompareClick(e) {
                e.preventDefault();
                e.stopPropagation();
                const adId = this.dataset.adId;
                const adTitle = this.dataset.adTitle;
                const adImage = this.dataset.adImage;
                
                if (adId && adTitle && adImage) {
                    toggleCompare(adId, this);
                } else {
                    console.error('Missing data attributes for compare button:', this);
                }
            }
            
            // Re-attach listeners when new content is loaded (for dynamic content)
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        // Check if any added nodes contain compare buttons
                        mutation.addedNodes.forEach(node => {
                            if (node.nodeType === 1) { // Element node
                                if (node.classList && node.classList.contains('compare-btn')) {
                                    attachCompareListeners();
                                } else if (node.querySelector && node.querySelector('.compare-btn')) {
                                    attachCompareListeners();
                                }
                            }
                        });
                    }
                });
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });

            // Back to Top Functionality
            function initializeBackToTop() {
                const backToTopBtn = document.getElementById('backToTop');

                if (backToTopBtn) {
                    // Function to calculate 25% of page height
                    function getScrollThreshold() {
                        const documentHeight = Math.max(
                            document.body.scrollHeight,
                            document.body.offsetHeight,
                            document.documentElement.clientHeight,
                            document.documentElement.scrollHeight,
                            document.documentElement.offsetHeight
                        );
                        const windowHeight = window.innerHeight;
                        const scrollableHeight = documentHeight - windowHeight;
                        return scrollableHeight * 0.25;
                    }

                    // Simple scroll handler
                    window.addEventListener('scroll', function() {
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
                        const threshold = getScrollThreshold();

                        if (scrollTop > threshold) {
                            backToTopBtn.classList.add('show');
                        } else {
                            backToTopBtn.classList.remove('show');
                        }
                    });

                    // Recalculate threshold on window resize
                    window.addEventListener('resize', function() {
                        const scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
                        const threshold = getScrollThreshold();

                        if (scrollTop > threshold) {
                            backToTopBtn.classList.add('show');
                        } else {
                            backToTopBtn.classList.remove('show');
                        }
                    });

                    // Smooth scroll to top when clicked
                    backToTopBtn.addEventListener('click', function(e) {
                        e.preventDefault();

                        if (window.scrollTo) {
                            window.scrollTo({
                                top: 0,
                                behavior: 'smooth'
                            });
                        } else {
                            document.documentElement.scrollTop = 0;
                            document.body.scrollTop = 0;
                        }
                    });

                    // Initial check
                    const initialScroll = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop;
                    const initialThreshold = getScrollThreshold();
                    if (initialScroll > initialThreshold) {
                        backToTopBtn.classList.add('show');
                    }
                }
            }
        </script>

        {% block extra_js %}

        {% endblock extra_js %}
    </body>
</html>
