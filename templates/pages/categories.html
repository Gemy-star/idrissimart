{% extends 'base.html' %}

{% load static i18n %}

{% block title %}
    {% trans "الفئات - Categories" %} - {% trans "إدريسي مارت" %}

{% endblock %}

{% block content %}
    <!-- Categories Hero Section -->
    <section class="page-hero">
        <div class="container">
            <div class="hero-content-center">
                <h1 class="page-title">{% trans "جميع الفئات" %}</h1>
                <p class="page-subtitle">{% trans "استكشف جميع فئات منصة إدريسي مارت المتنوعة" %}</p>
            </div>
        </div>
    </section>
    <!-- Categories Section -->
    <section class="categories-page-section pt-4">
        <div class="container">
            <!-- Section Tabs (generated from categories_by_section) -->
            <div class="categories-tabs">
                <div class="tab-buttons" role="tablist" aria-label="Categories sections">
                    <button type="button"
                            id="tab-btn-all"
                            class="tab-btn
                                   {% if active_section == 'all' %}active{% endif %}"
                            data-tab="all"
                            role="tab"
                            aria-controls="all"
                            aria-selected="{% if active_section == 'all' %}
                                               true
                                           {% else %}
                                               false
                                           {% endif %}">
                        <i class="fas fa-th-large"></i>
                        {% trans "جميع الفئات" %}
                    </button>
                    {% for section_code, section_data in categories_by_section.items %}
                        <button type="button"
                                id="tab-btn-{{ section_code }}"
                                class="tab-btn
                                       {% if active_section == section_code %}active{% endif %}"
                                data-tab="{{ section_code }}"
                                role="tab"
                                aria-controls="{{ section_code }}"
                                aria-selected="{% if active_section == section_code %}
                                                   true
                                               {% else %}
                                                   false
                                               {% endif %}">
                            {# Use icons based on section_code - fallback to folder #}
                            {% if section_code == 'classified' %}
                                <i class="fas fa-bullhorn"></i>
                            {% elif section_code == 'product' %}
                                <i class="fas fa-shopping-basket"></i>
                            {% elif section_code == 'service' %}
                                <i class="fas fa-concierge-bell"></i>
                            {% elif section_code == 'course' %}
                                <i class="fas fa-chalkboard-teacher"></i>
                            {% elif section_code == 'job' %}
                                <i class="fas fa-briefcase"></i>
                            {% else %}
                                <i class="fas fa-folder"></i>
                            {% endif %}
                            {{ section_data.name }}
                        </button>
                    {% endfor %}
                </div>
            </div>
            <!-- All Categories Tab -->
            <div class="tab-pane fade
                        {% if active_section == 'all' %}show active{% endif %}"
                 id="all"
                 role="tabpanel"
                 aria-labelledby="tab-btn-all">
                {% for section_code, section_data in categories_by_section.items %}
                    <div class="section-group mb-5">
                        <h2 class="section-title">{{ section_data.name }}</h2>
                        <div class="row g-4">
                            {% for cat_data in section_data.categories %}
                                {% with category=cat_data.category subcats=cat_data.subcategories subcats_count=cat_data.subcategories_count %}
                                    <div class="col-lg-3 col-md-4 col-sm-6">
                                        <div class="category-card">
                                            <div class="category-icon">
                                                {% if category.icon %}
                                                    <i class="{{ category.icon }}"></i>
                                                {% else %}
                                                    <i class="fas fa-folder"></i>
                                                {% endif %}
                                            </div>
                                            <h3 class="category-title">{{ category.name }}</h3>
                                            {% if category.description %}<p class="category-desc">{{ category.description|truncatechars:80 }}</p>{% endif %}
                                            <div class="category-stats">
                                                {% if subcats %}
                                                    <span class="subcat-count">
                                                        <i class="fas fa-list"></i>
                                                        {{ subcats_count }} {% trans "فئة فرعية" %}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            {% if category.slug %}
                                                <a href="{% url 'main:category_detail' category.slug %}"
                                                   class="btn btn-custom btn-primary-custom mt-3">
                                                    <i class="fas fa-arrow-left me-2"></i>{% trans "استكشف" %}
                                                </a>
                                            {% else %}
                                                <a href="#"
                                                   class="btn btn-custom btn-secondary-custom mt-3 disabled"
                                                   aria-disabled="true">
                                                    <i class="fas fa-arrow-left me-2"></i>{% trans "استكشف" %}
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                {% endfor %}
            </div>
            <!-- Individual Section Tabs -->
            {% for section_code, section_data in categories_by_section.items %}
                <div class="tab-pane fade
                            {% if active_section == section_code %}show active{% endif %}"
                     id="{{ section_code }}"
                     role="tabpanel"
                     aria-labelledby="tab-btn-{{ section_code }}">
                    <div class="section-group">
                        <h2 class="section-title">{{ section_data.name }}</h2>
                        <div class="row g-4">
                            {% for cat_data in section_data.categories %}
                                {% with category=cat_data.category subcats=cat_data.subcategories subcats_count=cat_data.subcategories_count %}
                                    <div class="col-lg-3 col-md-4 col-sm-6">
                                        <div class="category-card">
                                            <div class="category-icon">
                                                {% if category.icon %}
                                                    <i class="{{ category.icon }}"></i>
                                                {% else %}
                                                    <i class="fas fa-folder"></i>
                                                {% endif %}
                                            </div>
                                            <h3 class="category-title">{{ category.name }}</h3>
                                            {% if category.description %}<p class="category-desc">{{ category.description|truncatechars:80 }}</p>{% endif %}
                                            <div class="category-stats">
                                                {% if subcats %}
                                                    <span class="subcat-count">
                                                        <i class="fas fa-list"></i>
                                                        {{ subcats_count }} {% trans "فئة فرعية" %}
                                                    </span>
                                                {% endif %}
                                            </div>
                                            {% if category.slug %}
                                                <a href="{% url 'main:category_detail' category.slug %}"
                                                   class="btn btn-custom btn-primary-custom mt-3">
                                                    <i class="fas fa-arrow-left me-2"></i>{% trans "استكشف" %}
                                                </a>
                                            {% else %}
                                                <a href="#"
                                                   class="btn btn-custom btn-secondary-custom mt-3 disabled"
                                                   aria-disabled="true">
                                                    <i class="fas fa-arrow-left me-2"></i>{% trans "استكشف" %}
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                {% endwith %}
                            {% endfor %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    </section>

{% endblock %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality (scoped per tab group)
            document.querySelectorAll('.tab-buttons').forEach((btnContainer) => {
                const buttons = Array.from(btnContainer.querySelectorAll('.tab-btn'));
                // Find panes within the same nearest container (parent of btnContainer)
                // use nearest .container as the common root for buttons and panes
                const panesRoot = btnContainer.closest('.container') || document.body;
                const panes = Array.from(panesRoot.querySelectorAll('.tab-pane'));

                function deactivateLocal() {
                    buttons.forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    panes.forEach(p => p.classList.remove('active', 'show'));
                }

                // default activation within this group
                const anyActiveLocal = buttons.some(b => b.classList.contains('active'));
                if (!anyActiveLocal && buttons.length) {
                    const defaultBtn = btnContainer.querySelector('#tab-btn-all') || buttons[0];
                    defaultBtn.classList.add('active');
                    defaultBtn.setAttribute('aria-selected', 'true');
                    const defaultTarget = defaultBtn.getAttribute('data-tab');
                    const el = defaultTarget ? panesRoot.querySelector('#' + defaultTarget) : null;
                    if (el) el.classList.add('active', 'show');
                }

                buttons.forEach((button) => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        if (!targetTab) return;
                        const targetEl = panesRoot.querySelector('#' + targetTab) || document.getElementById(targetTab);
                        if (!targetEl) return;

                        deactivateLocal();
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        targetEl.classList.add('active', 'show');
                        this.focus();
                    });
                });
            });

            // Smooth hover effect for category cards
            document.querySelectorAll('.category-card').forEach((card) => {
                card.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-5px)';
                });

                card.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });
            });
        });
    </script>

{% endblock %}
