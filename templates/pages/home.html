{% extends "base.html" %}

{% load static i18n %}

{% block title %}
    {% trans "Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©" %} - {% trans "Ø¥Ø¯Ø±ÙŠØ³ÙŠ Ù…Ø§Ø±Øª" %}

{% endblock title %}

{% block content %}
    <!-- Hero Section -->
    <section class="hero-section" id="home">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-6 hero-content">
                    <h1 class="hero-title">{% trans "Ù…Ù†ØµØ© ØªØ¬Ù…Ø¹ Ø³ÙˆÙ‚ ÙˆØ§Ø­Ø¯ Ù…ØªÙƒØ§Ù…Ù„" %}</h1>
                    <p class="hero-subtitle">
                        {% trans "Ù…Ù†ØµØ© ØªØ¬Ù…Ø¹ Ø³ÙˆÙ‚ ÙˆØ§Ø­Ø¯ Ù…ØªØ®ØµØµ ÙŠØ³ØªÙÙŠØ¯ Ù…Ù†Ù‡ Ø§Ù„Ù…ØªØ®ØµØµÙˆÙ† ÙˆØ§Ù„Ø¬Ù…Ù‡ÙˆØ± Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ø°ÙŠ ÙŠØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø£ÙŠÙ Ù…Ù† Ø®Ø¯Ù…Ø§Øª Ù‡Ø°Ø§ Ø§Ù„Ø³ÙˆÙ‚" %}
                    </p>

                    <div class="hero-cta-section mb-4">
                        <div class="d-flex flex-wrap gap-3">
                            <a href="{% url 'main:enhanced_ad_create' %}"
                               class="btn btn-custom btn-secondary-custom btn-hero me-3 pulse-btn">
                                <i class="fas fa-plus-circle me-2"></i>{% trans "Ù†Ø´Ø± Ø¥Ø¹Ù„Ø§Ù† Ù…Ø­Ø³Ù†" %}
                            </a>
                            <a href="{% url 'main:packages_list' %}"
                               class="btn btn-custom btn-secondary-custom btn-hero me-3">
                                <i class="fas fa-gift me-2"></i>{% trans "Ø§Ø´ØªØ±Ø§Ùƒ Ø§Ù„Ø¨Ø§Ù‚Ø§Øª" %}
                            </a>
                        </div>
                    </div>

                </div>
                <div class="col-lg-6 mt-5 mt-lg-0">
                    <img src="https://images.unsplash.com/photo-1545239351-1141bd82e8a6?w=600&h=500&fit=crop"
                         alt="Unified marketplace"
                         width="600"
                         height="500"
                         class="img-fluid rounded-4 shadow-lg"
                         id="heroImage" />
                </div>
            </div>
        </div>
    </section>

    <!-- Swiper Section -->
    <section class="swiper-section" id="featured">
        <div class="container">
            <h2 class="section-title">{% trans "Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø§Ù„Ù…Ù…ÙŠØ²Ø©" %}</h2>
            <div class="swiper idrisiMartFeaturedSwiper">
                <div class="swiper-wrapper">
                    {% for ad in featured_ads %}
                        <div class="swiper-slide">
                            {% include "classifieds/_ad_card.html" with ad=ad %}
                        </div>
                    {% empty %}
                        <div class="swiper-slide">
                            <p class="text-center text-muted">{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ù…Ù…ÙŠØ²Ø© Ø­Ø§Ù„ÙŠØ§Ù‹." %}</p>
                        </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
    </section>
    <!-- Features Section -->
    <section class="features-section" id="about">
        <div class="container">
            <h2 class="section-title text-white">{% trans "Ù„Ù…Ø§Ø°Ø§ Ø¥Ø¯Ø±ÙŠØ³ÙŠ Ù…Ø§Ø±Øª Ù„Ù„Ù…Ø³Ø§Ø­Ø©ØŸ" %}</h2>
            <div class="row g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-crosshairs"></i>
                        </div>
                        <h4 class="feature-title">{% trans "Ø¯Ù‚Ø© Ø¹Ø§Ù„ÙŠØ©" %}</h4>
                        <p>{% trans "Ù†Ø¶Ù…Ù† Ø£Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø§Ù„Ø¯Ù‚Ø© ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø£Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„Ù‚ÙŠØ§Ø³" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-satellite"></i>
                        </div>
                        <h4 class="feature-title">{% trans "ØªÙ‚Ù†ÙŠØ© Ù…ØªØ·ÙˆØ±Ø©" %}</h4>
                        <p>{% trans "Ù†Ø³ØªØ®Ø¯Ù… Ø£Ø­Ø¯Ø« Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø³Ø§Ø­Ø© ÙˆØ§Ù„ØªÙ‚Ù†ÙŠØ§Øª Ø§Ù„Ø¬ÙŠÙˆØ¯ÙŠØ³ÙŠØ©" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-certificate"></i>
                        </div>
                        <h4 class="feature-title">{% trans "Ø®Ø¨Ø±Ø© Ù…Ø¹ØªÙ…Ø¯Ø©" %}</h4>
                        <p>{% trans "ÙØ±ÙŠÙ‚ Ù…Ù† Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ÙŠÙ† Ø§Ù„Ù…Ø³Ø§Ø­ÙŠÙ† Ø§Ù„Ù…Ø¹ØªÙ…Ø¯ÙŠÙ† ÙˆØ°ÙˆÙŠ Ø§Ù„Ø®Ø¨Ø±Ø©" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="feature-box">
                        <div class="feature-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h4 class="feature-title">{% trans "ØªØ³Ù„ÙŠÙ… Ø³Ø±ÙŠØ¹" %}</h4>
                        <p>{% trans "Ø§Ù„ØªØ²Ø§Ù… Ø¨Ø§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ Ø§Ù„Ù…Ø­Ø¯Ø¯Ø© ÙˆØªØ³Ù„ÙŠÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ ÙÙŠ Ø§Ù„ÙˆÙ‚Øª" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Latest Ads Section -->
    <section class="latest-ads-section py-5">
        <div class="container">
            <h2 class="section-title">{% trans "Ø£Ø­Ø¯Ø« Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª" %}</h2>
            <div class="swiper idrisiMartLatestSwiper">
                <div class="swiper-wrapper">
                    {% for ad in latest_ads %}
                        <div class="swiper-slide">
                            {% include "classifieds/_ad_card.html" with ad=ad %}
                        </div>
                    {% empty %}
                        <div class="swiper-slide">
                            <p class="text-center text-muted">{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ù„Ø§Ù†Ø§Øª Ø¬Ø¯ÙŠØ¯Ø© Ø­Ø§Ù„ÙŠØ§Ù‹." %}</p>
                        </div>
                    {% endfor %}
                </div>
                <div class="swiper-pagination"></div>
            </div>
        </div>
    </section>
    <!-- Stats Section -->
    <section class="stats-section py-5">
        <div class="container">
            <div class="row text-center g-4">
                <div class="col-lg-3 col-md-6">
                    <div class="stat-box">
                        <i class="fas fa-map fa-3x mb-3 text-secondary-color"></i>
                        <h3 class="stat-number" data-target="250">0</h3>
                        <p class="stat-label">{% trans "Ù…Ø´Ø±ÙˆØ¹ Ù…Ø³Ø§Ø­ÙŠ Ù…Ù†Ø¬Ø²" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-box">
                        <i class="fas fa-drafting-compass fa-3x mb-3 text-secondary-color"></i>
                        <h3 class="stat-number" data-target="500">0</h3>
                        <p class="stat-label">{% trans "Ø®Ø±ÙŠØ·Ø© Ù…Ø³Ø§Ø­ÙŠØ©" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-box">
                        <i class="fas fa-users fa-3x mb-3 text-secondary-color"></i>
                        <h3 class="stat-number" data-target="150">0</h3>
                        <p class="stat-label">{% trans "Ø¹Ù…ÙŠÙ„ Ø±Ø§Ø¶Ù" %}</p>
                    </div>
                </div>
                <div class="col-lg-3 col-md-6">
                    <div class="stat-box">
                        <i class="fas fa-award fa-3x mb-3 text-secondary-color"></i>
                        <h3 class="stat-number" data-target="15">0</h3>
                        <p class="stat-label">{% trans "Ø³Ù†Ø© Ø®Ø¨Ø±Ø©" %}</p>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Latest Blogs Section -->
    <section class="latest-blogs-section py-5">
        <div class="container">
            <div class="section-header text-center mb-5">
                <h2 class="section-title">{% trans "Ø£Ø­Ø¯Ø« Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª" %}</h2>
                <p class="section-subtitle">{% trans "Ø§ÙƒØªØ´Ù Ø¢Ø®Ø± Ù…Ø§ Ù†Ø´Ø±Ù†Ø§Ù‡ ÙÙŠ Ø§Ù„Ù…Ø¯ÙˆÙ†Ø©" %}</p>
            </div>
            {% if latest_blogs %}
                <!-- Swiper Container -->
                <div class="swiper home-blogs-swiper">
                    <div class="swiper-wrapper">
                        {% for blog in latest_blogs %}
                            <div class="swiper-slide">
                                <div class="blog-post-card h-100 gsap-fade-up">
                                    <a href="{{ blog.get_absolute_url }}" class="card-img-container">
                                        {% if blog.image %}
                                            <img src="{{ blog.image.url }}"
                                                 class="card-img-top"
                                                 alt="{{ blog.title }}">
                                        {% else %}
                                            <img src="https://via.placeholder.com/400x250"
                                                 class="card-img-top"
                                                 alt="Placeholder">
                                        {% endif %}
                                    </a>
                                    <div class="card-body d-flex flex-column">
                                        <div class="mb-2">
                                            {% for tag in blog.tags.all|slice:":2" %}
                                                <a href="{% url 'content:blog_list_by_tag' tag.slug %}" class="blog-tag">
                                                    <i class="fas fa-tag me-1"></i>{{ tag.name }}
                                                </a>
                                            {% endfor %}
                                        </div>
                                        <h5 class="card-title">
                                            <a href="{{ blog.get_absolute_url }}">{{ blog.title }}</a>
                                        </h5>
                                        <p class="card-text flex-grow-1">{{ blog.content|striptags|truncatewords:15 }}</p>
                                        <div class="card-footer bg-transparent border-0 p-0 mt-auto">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div class="blog-author-info">
                                                    <small class="text-muted d-block"><i class="fas fa-user-edit me-1"></i> {{ blog.author.get_full_name|default:blog.author.username }}</small>
                                                    <small class="text-muted d-block"><i class="fas fa-calendar-alt me-1"></i> {{ blog.published_date|date:"Y-m-d" }}</small>
                                                </div>
                                                <a href="{{ blog.get_absolute_url }}"
                                                   class="btn btn-sm btn-outline-primary blog-read-more-btn">{% trans "Ø§Ù‚Ø±Ø£ Ø§Ù„Ù…Ø²ÙŠØ¯" %}</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <!-- Swiper Navigation -->
                    <div class="swiper-button-next home-blogs-next"></div>
                    <div class="swiper-button-prev home-blogs-prev"></div>
                    <!-- Swiper Pagination -->
                    <div class="swiper-pagination home-blogs-pagination"></div>
                </div>
                <div class="text-center mt-5">
                    <a href="{% url 'content:blog_list' %}" class="btn btn-primary btn-lg btn-post-ad">
                        <i class="fas fa-newspaper me-2"></i>{% trans "Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù‚Ø§Ù„Ø§Øª" %}
                    </a>
                </div>
            {% else %}
                <div class="text-center py-5">
                    <i class="fas fa-newspaper fa-3x text-muted mb-3"></i>
                    <p class="text-muted">{% trans "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù‚Ø§Ù„Ø§Øª Ù…Ù†Ø´ÙˆØ±Ø© Ø¨Ø¹Ø¯." %}</p>
                </div>
            {% endif %}
        </div>
    </section>

{% endblock content %}

{% block extra_js %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize Home Blogs Swiper
            const homeBlogsSwiper = document.querySelector('.home-blogs-swiper');
            if (homeBlogsSwiper) {
                new Swiper('.home-blogs-swiper', {
                    slidesPerView: 1,
                    spaceBetween: 20,
                    loop: true,
                    autoplay: {
                        delay: 5000,
                        disableOnInteraction: false,
                        pauseOnMouseEnter: true,
                    },
                    speed: 800,
                    navigation: {
                        nextEl: '.home-blogs-next',
                        prevEl: '.home-blogs-prev',
                    },
                    pagination: {
                        el: '.home-blogs-pagination',
                        clickable: true,
                    },
                    breakpoints: {
                        640: {
                            slidesPerView: 1,
                            spaceBetween: 20,
                        },
                        768: {
                            slidesPerView: 2,
                            spaceBetween: 25,
                        },
                        1024: {
                            slidesPerView: 3,
                            spaceBetween: 30,
                        }
                    }
                });
                console.log('âœ… Home Blogs Swiper: Initialized');
            }

            // Tab functionality (scoped per tab group)
            document.querySelectorAll('.tab-buttons').forEach((btnContainer) => {
                const buttons = Array.from(btnContainer.querySelectorAll('.tab-btn'));
                // use nearest .container as the common root for buttons and panes
                const panesRoot = btnContainer.closest('.container') || document.body;
                const panes = panesRoot ? Array.from(panesRoot.querySelectorAll('.tab-pane')) : Array.from(document.querySelectorAll('.tab-pane'));

                function deactivateLocal() {
                    buttons.forEach(b => {
                        b.classList.remove('active');
                        b.setAttribute('aria-selected', 'false');
                    });
                    panes.forEach(p => p.classList.remove('active', 'show'));
                }

                const anyActiveLocal = buttons.some(b => b.classList.contains('active'));
                if (!anyActiveLocal && buttons.length) {
                    const defaultBtn = btnContainer.querySelector('#tab-btn-all') || buttons[0];
                    defaultBtn.classList.add('active');
                    defaultBtn.setAttribute('aria-selected', 'true');
                    const defaultTarget = defaultBtn.getAttribute('data-tab');
                    const el = defaultTarget ? panesRoot.querySelector('#' + defaultTarget) : null;
                    if (el) el.classList.add('active', 'show');
                }

                buttons.forEach((button) => {
                    button.addEventListener('click', function() {
                        const targetTab = this.getAttribute('data-tab');
                        if (!targetTab) return;
                        const targetEl = panesRoot.querySelector('#' + targetTab) || document.getElementById(targetTab);
                        if (!targetEl) return;

                        deactivateLocal();
                        this.classList.add('active');
                        this.setAttribute('aria-selected', 'true');
                        targetEl.classList.add('active', 'show');
                        this.focus();
                    });
                });
            });

            // Swiper initialization
            const idrisiMartSwiper = new Swiper('.idrisiMartFeaturedSwiper', {
                slidesPerView: 1,
                spaceBetween: 20,
                autoplay: {
                    delay: 3000,
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true,
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                    dynamicBullets: true,
                },
                breakpoints: {
                    576: {
                        slidesPerView: 2,
                        spaceBetween: 20,
                    },
                    768: {
                        slidesPerView: 3,
                        spaceBetween: 25,
                    },
                    992: {
                        slidesPerView: 3,
                        spaceBetween: 30,
                    },
                    1200: {
                        slidesPerView: 3,
                        spaceBetween: 35,
                    },
                    1400: {
                        slidesPerView: 4,
                        spaceBetween: 40,
                    },
                },
                speed: 600,
                effect: 'slide',
                grabCursor: true,
                watchSlidesProgress: true,
                lazy: {
                    loadPrevNext: true,
                    loadOnTransitionStart: true,
                },
                on: {
                    init: function() {
                        console.log('ğŸ¨ Idrisi Mart Swiper Initialized')
                    },
                },
            })

            // Swiper initialization for Latest Ads
            const idrisiMartLatestSwiper = new Swiper('.idrisiMartLatestSwiper', {
                slidesPerView: 1,
                spaceBetween: 20,
                autoplay: {
                    delay: 3500, // Slightly different delay
                    disableOnInteraction: false,
                    pauseOnMouseEnter: true,
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                    dynamicBullets: true,
                },
                breakpoints: {
                    576: {
                        slidesPerView: 2,
                        spaceBetween: 20
                    },
                    768: {
                        slidesPerView: 2,
                        spaceBetween: 25
                    },
                    992: {
                        slidesPerView: 3,
                        spaceBetween: 30
                    },
                    1200: {
                        slidesPerView: 3,
                        spaceBetween: 35
                    },
                    1400: {
                        slidesPerView: 4,
                        spaceBetween: 40
                    },
                },
                speed: 600,
                effect: 'slide',
                grabCursor: true,
                watchSlidesProgress: true,
                lazy: {
                    loadPrevNext: true,
                    loadOnTransitionStart: true,
                },
                on: {
                    init: function() {
                        console.log('ğŸ¨ Idrisi Mart Latest Ads Swiper Initialized')
                    },
                },
            });
        })

        // Subcategories toggle functionality
        globalThis.toggleSubcategories = function(element, categoryId, level = 0) {
            const subcategoriesContainer = document.getElementById(`subcategories-${categoryId}`);

            if (!subcategoriesContainer) return;

            if (subcategoriesContainer.style.display === 'none' || !subcategoriesContainer.style.display) {
                // Show subcategories
                element.classList.add('expanded');
                subcategoriesContainer.style.display = 'block';
                loadSubcategories(categoryId, level);
            } else {
                // Hide subcategories
                closeSubcategories(categoryId, false);
            }
        }

        globalThis.closeSubcategories = function(categoryId, updateParent = true) {
            const subcategoriesContainer = document.getElementById(`subcategories-${categoryId}`);
            const categoryLink = document.querySelector(`[data-category-id="${categoryId}"]`);

            if (subcategoriesContainer) {
                subcategoriesContainer.style.display = 'none';
            }

            if (categoryLink && updateParent) {
                categoryLink.classList.remove('expanded');
            }

            // Close any nested subcategories
            const nestedContainers = subcategoriesContainer?.querySelectorAll('.sub-subcategories-container');
            if (nestedContainers) {
                for (const container of nestedContainers) {
                    container.style.display = 'none';
                }
            }
        }

        function loadSubcategories(categoryId, level = 0) {
            const container = document.getElementById(`subcategories-${categoryId}`);
            const loadingEl = container.querySelector('.subcategories-loading');
            const gridEl = container.querySelector(`#subcategories-grid-${categoryId}`);

            // Show loading
            loadingEl.style.display = 'block';
            gridEl.innerHTML = '';

            // Fetch subcategories
            fetch(`/ajax/subcategories/${categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    loadingEl.style.display = 'none';

                    if (data.error) {
                        gridEl.innerHTML = '<p class="text-muted text-center">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©</p>';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        renderSubcategories(data.subcategories, gridEl, level + 1);
                    } else {
                        gridEl.innerHTML = '<p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª ÙØ±Ø¹ÙŠØ©</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading subcategories:', error);
                    loadingEl.style.display = 'none';
                    gridEl.innerHTML = '<p class="text-danger text-center">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p>';
                });
        }

        function renderSubcategories(subcategories, container, level) {
            container.innerHTML = subcategories.map(subcat => {
                const hasChildren = subcat.has_children;
                const levelClass = level === 1 ? 'subcategory-item' : 'sub-subcategory-item';
                const childrenIndicator = hasChildren ? '<i class="fas fa-chevron-left subcategory-expand"></i>' : '';
                const childrenClass = hasChildren ? 'has-children' : '';

                return `
                    <div class="${levelClass} ${childrenClass}"
                         data-subcategory-id="${subcat.id}"
                         data-has-children="${hasChildren}"
                         onclick="handleSubcategoryClick(this, ${subcat.id}, '${subcat.url}', ${hasChildren}, ${level})"
                         role="button" tabindex="0">
                        <div class="subcategory-content">
                            <i class="${subcat.icon}"></i>
                            <span>${subcat.name_ar || subcat.name}</span>
                        </div>
                        ${childrenIndicator}
                        <div class="sub-subcategories-container" id="sub-subcategories-${subcat.id}" style="display: none;">
                            <div class="sub-subcategories-loading">
                                <i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙØ±Ø¹ÙŠØ©...
                            </div>
                            <div class="sub-subcategories-grid" id="sub-subcategories-grid-${subcat.id}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        globalThis.handleSubcategoryClick = function(element, subcategoryId, url, hasChildren, level) {
            if (hasChildren && level === 1) {
                // Toggle sub-subcategories for level 1 subcategories
                event.preventDefault();
                event.stopPropagation();

                const subSubContainer = element.querySelector(`#sub-subcategories-${subcategoryId}`);
                if (!subSubContainer) return;

                if (subSubContainer.style.display === 'none' || !subSubContainer.style.display) {
                    // Show sub-subcategories
                    element.classList.add('expanded');
                    subSubContainer.style.display = 'block';
                    loadSubSubcategories(subcategoryId, level + 1);
                } else {
                    // Hide sub-subcategories
                    element.classList.remove('expanded');
                    subSubContainer.style.display = 'none';
                }
            } else {
                // Navigate to category page
                globalThis.location.href = url;
            }
        }

        function loadSubSubcategories(subcategoryId, level) {
            const container = document.getElementById(`sub-subcategories-${subcategoryId}`);
            const loadingEl = container.querySelector('.sub-subcategories-loading');
            const gridEl = container.querySelector(`#sub-subcategories-grid-${subcategoryId}`);

            // Show loading
            loadingEl.style.display = 'block';
            gridEl.innerHTML = '';

            // Fetch sub-subcategories
            fetch(`/ajax/subcategories/${subcategoryId}/`)
                .then(response => response.json())
                .then(data => {
                    loadingEl.style.display = 'none';

                    if (data.error) {
                        gridEl.innerHTML = '<p class="text-muted text-center">Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ÙØ¦Ø§Øª</p>';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        renderSubcategories(data.subcategories, gridEl, level);
                    } else {
                        gridEl.innerHTML = '<p class="text-muted text-center">Ù„Ø§ ØªÙˆØ¬Ø¯ ÙØ¦Ø§Øª ÙØ±Ø¹ÙŠØ© Ø¥Ø¶Ø§ÙÙŠØ©</p>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sub-subcategories:', error);
                    loadingEl.style.display = 'none';
                    gridEl.innerHTML = '<p class="text-danger text-center">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„</p>';
                });
        }

        // Mobile touch handling
        if ('ontouchstart' in globalThis) {
            document.addEventListener('touchstart', function(e) {
                // Handle mobile touch events for better responsiveness
                const target = e.target.closest('.subcategory-item, .sub-subcategory-item');
                if (target) {
                    target.style.transform = 'scale(0.98)';
                }
            });

            document.addEventListener('touchend', function(e) {
                const target = e.target.closest('.subcategory-item, .sub-subcategory-item');
                if (target) {
                    setTimeout(() => {
                        target.style.transform = '';
                    }, 150);
                }
            });
        }

        // Keyboard navigation support
        document.addEventListener('keydown', function(e) {
            if (e.target.matches('.subcategory-item, .sub-subcategory-item')) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    e.target.click();
                }
            }
        });
    </script>

{% endblock extra_js %}
