{% extends "base.html" %}

{% load static i18n %}

{% block title %}
    {% if category %}
        {% if LANGUAGE_CODE == 'ar' and category.name_ar %}
            {{ category.name_ar }}
        {% else %}
            {{ category.name }}
        {% endif %}
    {% else %}
        {% trans "القسم غير موجود" %}
    {% endif %}
    - {% trans "إدريسي مارت" %}
{% endblock title %}

{% block content %}
    {% if category %}
        <!-- Modern Category Hero Section -->
        <section class="modern-hero-section">
            <div class="hero-background-gradient"></div>
            <div class="container">
                <!-- Breadcrumb Navigation using Partial -->
                <div class="enhanced-breadcrumb mb-4">
                    {% include 'partials/_breadcrumbs.html' %}
                </div>

                <div class="hero-content-modern">
                    <div class="hero-icon-wrapper">
                        <i class="fas fa-{% if category.icon %}{{ category.icon }}{% else %}tag{% endif %} hero-icon"></i>
                    </div>
                    <h1 class="modern-hero-title">
                        {% if LANGUAGE_CODE == 'ar' and category.name_ar %}
                            {{ category.name_ar }}
                        {% else %}
                            {{ category.name }}
                        {% endif %}
                    </h1>
                    <p class="modern-hero-subtitle">
                        {% if LANGUAGE_CODE == 'ar' and category.description_ar %}
                            {{ category.description_ar }}
                        {% elif category.description %}
                            {{ category.description }}
                        {% else %}
                            {% trans "استكشف جميع الإعلانات في هذا القسم واعثر على ما تبحث عنه بسهولة" %}
                        {% endif %}
                    </p>

                    <!-- Enhanced Search and Filter Bar -->
                    <div class="hero-search-container">
                        <div class="search-filter-wrapper">
                            <!-- Search Input -->
                            <div class="search-input-group">
                                <div class="search-icon-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                                <input type="text"
                                       id="categorySearchInput"
                                       class="form-control modern-search-input"
                                       placeholder="{% trans 'ابحث في إعلانات هذا القسم...' %}"
                                       autocomplete="off">
                                <button type="button" id="clearSearchBtn" class="clear-search-btn" style="display: none;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Price Filter Group -->
                            <div class="price-filter-group">
                                <div class="input-group">
                                    <span class="input-group-text">
                                        <i class="fas fa-dollar-sign"></i>
                                    </span>
                                    <input type="number"
                                           id="minPrice"
                                           class="form-control"
                                           placeholder="{% trans 'الحد الأدنى' %}"
                                           min="0">
                                    <span class="input-group-text">-</span>
                                    <input type="number"
                                           id="maxPrice"
                                           class="form-control"
                                           placeholder="{% trans 'الحد الأقصى' %}"
                                           min="0">
                                </div>
                            </div>

                            <!-- Country Filter -->
                            <div class="location-filter-group">
                                <select class="form-control" id="countryFilter">
                                    <option value="">{% trans "جميع البلدان" %}</option>
                                    <option value="MA">{% trans "المغرب" %}</option>
                                    <option value="DZ">{% trans "الجزائر" %}</option>
                                    <option value="TN">{% trans "تونس" %}</option>
                                    <option value="EG">{% trans "مصر" %}</option>
                                    <option value="SA">{% trans "السعودية" %}</option>
                                    <option value="AE">{% trans "الإمارات" %}</option>
                                    <option value="KW">{% trans "الكويت" %}</option>
                                    <option value="QA">{% trans "قطر" %}</option>
                                    <option value="BH">{% trans "البحرين" %}</option>
                                    <option value="OM">{% trans "عمان" %}</option>
                                    <option value="JO">{% trans "الأردن" %}</option>
                                    <option value="LB">{% trans "لبنان" %}</option>
                                    <option value="SY">{% trans "سوريا" %}</option>
                                    <option value="IQ">{% trans "العراق" %}</option>
                                    <option value="LY">{% trans "ليبيا" %}</option>
                                    <option value="SD">{% trans "السودان" %}</option>
                                    <option value="YE">{% trans "اليمن" %}</option>
                                </select>
                            </div>

                            <!-- Advanced Filter Dropdown -->
                            <div class="filter-dropdown-container">
                                <button class="btn modern-filter-btn" type="button" id="filterDropdownBtn" data-bs-toggle="dropdown">
                                    <i class="fas fa-filter me-2"></i>
                                    <span class="filter-text">{% trans "فلترة متقدمة" %}</span>
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </button>
                                <ul class="dropdown-menu modern-dropdown-menu">
                                    <!-- Sort Section -->
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-sort-amount-down me-2"></i>
                                            {% trans "ترتيب حسب" %}
                                        </h6>
                                    </li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="date">
                                        <i class="fas fa-calendar me-2"></i>{% trans "تاريخ النشر" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="price-low">
                                        <i class="fas fa-sort-amount-down me-2"></i>{% trans "السعر (أقل لأعلى)" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="price-high">
                                        <i class="fas fa-sort-amount-up me-2"></i>{% trans "السعر (أعلى لأقل)" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="views">
                                        <i class="fas fa-eye me-2"></i>{% trans "الأكثر مشاهدة" %}
                                    </a></li>

                                    <li><hr class="dropdown-divider"></li>

                                    <!-- Ad Type Filter -->
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-tags me-2"></i>
                                            {% trans "نوع الإعلان" %}
                                        </h6>
                                    </li>
                                    <li><a class="dropdown-item filter-option active" href="#" data-type="all">
                                        <i class="fas fa-th-large me-2"></i>{% trans "جميع الإعلانات" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-type="featured">
                                        <i class="fas fa-star me-2"></i>{% trans "إعلانات مميزة" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-type="urgent">
                                        <i class="fas fa-bolt me-2"></i>{% trans "إعلانات عاجلة" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-type="verified">
                                        <i class="fas fa-shield-alt me-2"></i>{% trans "إعلانات موثقة" %}
                                    </a></li>
                                </ul>
                            </div>

                            <!-- View Toggle -->
                            <div class="view-toggle-container">
                                <div class="view-toggle-buttons">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary active" id="heroGridViewToggle" data-view="grid">
                                            <i class="fas fa-th"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="heroListViewToggle" data-view="list">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Quick Stats -->
                        <div class="quick-stats-bar">
                            <div class="stats-item">
                                <span class="stats-icon"><i class="fas fa-layer-group"></i></span>
                                <span class="stats-text">
                                    <span id="subcategoriesCount">{{ category.children.count|default:0 }}</span>
                                    {% trans "قسم فرعي" %}
                                </span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-icon"><i class="fas fa-bullhorn"></i></span>
                                <span class="stats-text">
                                    <span id="categoryAdsCount">{{ category.ads.count|default:0 }}</span>
                                    {% trans "إعلان" %}
                                </span>
                            </div>
                            <div class="stats-item">
                                <span class="stats-icon"><i class="fas fa-eye"></i></span>
                                <span class="stats-text">
                                    <span id="visibleAdsCount">{{ category.ads.count|default:0 }}</span>
                                    {% trans "معروض" %}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modern Category Content Section -->
        <section class="modern-category-content">
                {% if breadcrumbs %}
                    <nav aria-label="breadcrumb" class="enhanced-breadcrumb mb-4">
                        <ol class="breadcrumb modern-breadcrumb-nav">
                            <li class="breadcrumb-item">
                                <a href="{% url 'main:home' %}" class="breadcrumb-link">
                                    <i class="fas fa-home me-2"></i>
                                    {% trans "الرئيسية" %}
                                </a>
                            </li>
                            <li class="breadcrumb-item">
                                <a href="{% url 'main:categories' %}" class="breadcrumb-link">
                                    <i class="fas fa-th-large me-2"></i>
                                    {% trans "جميع الأقسام" %}
                                </a>
                            </li>
                            {% for breadcrumb in breadcrumbs %}
                                {% if forloop.last %}
                                    <li class="breadcrumb-item active" aria-current="page">
                                        <span class="breadcrumb-active">
                                            {% if category.icon %}
                                                <i class="{{ category.icon }} me-2"></i>
                                            {% else %}
                                                <i class="fas fa-folder me-2"></i>
                                            {% endif %}
                                            {% if LANGUAGE_CODE == 'ar' and breadcrumb.name_ar %}
                                                {{ breadcrumb.name_ar }}
                                            {% else %}
                                                {{ breadcrumb.name }}
                                            {% endif %}
                                        </span>
                                    </li>
                                {% else %}
                                    <li class="breadcrumb-item">
                                        <a href="{% url 'main:category_detail' breadcrumb.slug %}" class="breadcrumb-link">
                                            {% if breadcrumb.icon %}
                                                <i class="{{ breadcrumb.icon }} me-2"></i>
                                            {% else %}
                                                <i class="fas fa-tag me-2"></i>
                                            {% endif %}
                                            {% if LANGUAGE_CODE == 'ar' and breadcrumb.name_ar %}
                                                {{ breadcrumb.name_ar }}
                                            {% else %}
                                                {{ breadcrumb.name }}
                                            {% endif %}
                                        </a>
                                    </li>
                                {% endif %}
                            {% endfor %}
                        </ol>
                    </nav>
                {% endif %}

                <!-- Enhanced Category Header with Stats -->
                <div class="enhanced-hero-content">
                    <div class="category-header-wrapper">
                        <div class="category-main-info">
                            <div class="category-icon-wrapper">
                                {% if category.icon %}
                                    <i class="{{ category.icon }} category-hero-icon"></i>
                                {% else %}
                                    <i class="fas fa-folder category-hero-icon"></i>
                                {% endif %}
                            </div>
                            <div class="category-text-content">
                                <h1 class="modern-category-title">
                                    {% if LANGUAGE_CODE == 'ar' and category.name_ar %}
                                        {{ category.name_ar }}
                                    {% else %}
                                        {{ category.name }}
                                    {% endif %}
                                </h1>
                                {% if category.description %}
                                    <p class="modern-category-desc">
                                        {% if LANGUAGE_CODE == 'ar' and category.description_ar %}
                                            {{ category.description_ar }}
                                        {% else %}
                                            {{ category.description }}
                                        {% endif %}
                                    </p>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Enhanced Category Stats Cards -->
                        <div class="category-stats-enhanced">
                            <div class="stats-cards-grid">
                                <div class="stat-card-enhanced">
                                    <div class="stat-icon-wrapper">
                                        <i class="fas fa-bullhorn"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="categoryAdsCount">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </div>
                                        <div class="stat-label">{% trans "إعلان متاح" %}</div>
                                    </div>
                                </div>
                                <div class="stat-card-enhanced">
                                    <div class="stat-icon-wrapper">
                                        <i class="fas fa-sitemap"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number" id="categorySubcatsCount">
                                            <i class="fas fa-spinner fa-spin"></i>
                                        </div>
                                        <div class="stat-label">{% trans "قسم فرعي" %}</div>
                                    </div>
                                </div>
                                <div class="stat-card-enhanced">
                                    <div class="stat-icon-wrapper">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <div class="stat-content">
                                        <div class="stat-number">{{ category.view_count|default:0 }}</div>
                                        <div class="stat-label">{% trans "مشاهدة" %}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Search and Filter Bar -->
                    <div class="category-search-container">
                        <div class="search-filter-wrapper">
                            <!-- Search Input -->
                            <div class="search-input-group">
                                <div class="search-icon-wrapper">
                                    <i class="fas fa-search search-icon"></i>
                                </div>
                                <input type="text"
                                       id="categorySearchInput"
                                       class="form-control modern-search-input"
                                       placeholder="{% trans 'ابحث في الإعلانات والأقسام الفرعية...' %}"
                                       value="{{ current_filters.search }}"
                                       autocomplete="off">
                                <button type="button" id="clearSearchBtn" class="clear-search-btn" style="display: {% if current_filters.search %}block{% else %}none{% endif %};">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>

                            <!-- Price Range Filter -->
                            <div class="price-filter-group">
                                <div class="input-group">
                                    <input type="number" id="minPrice" class="form-control modern-search-input"
                                           placeholder="{% trans 'السعر من' %}" min="0" step="0.01"
                                           value="{{ current_filters.min_price }}">
                                    <span class="input-group-text">-</span>
                                    <input type="number" id="maxPrice" class="form-control modern-search-input"
                                           placeholder="{% trans 'السعر إلى' %}" min="0" step="0.01"
                                           value="{{ current_filters.max_price }}">
                                </div>
                            </div>

                            <!-- Location Filter -->
                            <div class="location-filter-group">
                                <input type="text" id="cityFilter" class="form-control modern-search-input"
                                       placeholder="{% trans 'المدينة' %}"
                                       value="{{ current_filters.city }}">
                            </div>

                            <!-- Filter Dropdown -->
                            <div class="filter-dropdown-container">
                                <button class="btn modern-filter-btn" type="button" id="filterDropdownBtn" data-bs-toggle="dropdown">
                                    <i class="fas fa-filter me-2"></i>
                                    <span class="filter-text">{% trans "فلترة" %}</span>
                                    <i class="fas fa-chevron-down ms-2"></i>
                                </button>
                                <ul class="dropdown-menu modern-dropdown-menu">
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-sort-amount-down me-2"></i>
                                            {% trans "ترتيب حسب" %}
                                        </h6>
                                    </li>
                                    <li><a class="dropdown-item filter-option {% if current_filters.sort == '-created_at' %}active{% endif %}" href="#" data-sort="-created_at">
                                        <i class="fas fa-clock me-2"></i>{% trans "الأحدث" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option {% if current_filters.sort == 'price' %}active{% endif %}" href="#" data-sort="price">
                                        <i class="fas fa-sort-numeric-down me-2"></i>{% trans "السعر (من الأقل)" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option {% if current_filters.sort == '-price' %}active{% endif %}" href="#" data-sort="-price">
                                        <i class="fas fa-sort-numeric-up me-2"></i>{% trans "السعر (من الأعلى)" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option {% if current_filters.sort == '-views_count' %}active{% endif %}" href="#" data-sort="-views_count">
                                        <i class="fas fa-eye me-2"></i>{% trans "الأكثر مشاهدة" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option {% if current_filters.sort == 'title' %}active{% endif %}" href="#" data-sort="title">
                                        <i class="fas fa-sort-alpha-down me-2"></i>{% trans "العنوان أ-ي" %}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-filter me-2"></i>
                                            {% trans "خيارات إضافية" %}
                                        </h6>
                                    </li>
                                    <li>
                                        <div class="dropdown-item-text">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="negotiableFilter"
                                                       {% if current_filters.negotiable %}checked{% endif %}>
                                                <label class="form-check-label" for="negotiableFilter">
                                                    <i class="fas fa-handshake me-2"></i>{% trans "قابل للتفاوض" %}
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="dropdown-item-text">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="deliveryFilter"
                                                       {% if current_filters.delivery %}checked{% endif %}>
                                                <label class="form-check-label" for="deliveryFilter">
                                                    <i class="fas fa-shipping-fast me-2"></i>{% trans "توصيل متوفر" %}
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                    <li>
                                        <div class="dropdown-item-text">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="verifiedFilter"
                                                       {% if current_filters.verified_only %}checked{% endif %}>
                                                <label class="form-check-label" for="verifiedFilter">
                                                    <i class="fas fa-shield-alt me-2"></i>{% trans "أعضاء موثقون فقط" %}
                                                </label>
                                            </div>
                                        </div>
                                    </li>
                                </ul>
                            </div>
                                <ul class="dropdown-menu modern-dropdown-menu">
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-sort-amount-down me-2"></i>
                                            {% trans "ترتيب الإعلانات" %}
                                        </h6>
                                    </li>
                                    <li><a class="dropdown-item filter-option active" href="#" data-sort="recent">
                                        <i class="fas fa-clock me-2"></i>{% trans "الأحدث" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="price_low">
                                        <i class="fas fa-sort-amount-down me-2"></i>{% trans "السعر من الأقل" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="price_high">
                                        <i class="fas fa-sort-amount-up me-2"></i>{% trans "السعر من الأعلى" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-sort="views">
                                        <i class="fas fa-eye me-2"></i>{% trans "الأكثر مشاهدة" %}
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <h6 class="dropdown-header">
                                            <i class="fas fa-tags me-2"></i>
                                            {% trans "نوع المحتوى" %}
                                        </h6>
                                    </li>
                                    <li><a class="dropdown-item filter-option active" href="#" data-type="all">
                                        <i class="fas fa-th-large me-2"></i>{% trans "الكل" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-type="ads">
                                        <i class="fas fa-bullhorn me-2"></i>{% trans "الإعلانات فقط" %}
                                    </a></li>
                                    <li><a class="dropdown-item filter-option" href="#" data-type="subcategories">
                                        <i class="fas fa-sitemap me-2"></i>{% trans "الأقسام الفرعية فقط" %}
                                    </a></li>
                                </ul>
                            </div>

                            <!-- View Toggle -->
                            <div class="view-toggle-container">
                                <div class="view-toggle-buttons">
                                    <div class="btn-group" role="group">
                                        <button type="button" class="btn btn-outline-primary active" id="gridViewToggle" data-view="grid">
                                            <i class="fas fa-th"></i>
                                        </button>
                                        <button type="button" class="btn btn-outline-primary" id="listViewToggle" data-view="list">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Modern Content Section -->
        <section class="modern-category-content">
            <div class="container">
                <!-- Loading Overlay -->
                <div class="loading-overlay" id="contentLoader" style="display: none;">
                    <div class="loading-spinner">
                        <div class="spinner-ring"></div>
                        <p class="loading-text">{% trans "جارٍ التحميل..." %}</p>
                    </div>
                </div>

                <!-- No Results Message -->
                <div class="no-results-message" id="noResultsMessage" style="display: none;">
                    <div class="no-results-icon">
                        <i class="fas fa-search-minus"></i>
                    </div>
                    <h3 class="no-results-title">{% trans "لم يتم العثور على نتائج" %}</h3>
                    <p class="no-results-text">{% trans "جرب البحث بكلمات مختلفة أو تعديل الفلترة" %}</p>
                    <button class="btn btn-primary reset-filters-btn" id="resetFiltersBtn">
                        <i class="fas fa-refresh me-2"></i>{% trans "إعادة تعيين" %}
                    </button>
                </div>

                <!-- Subcategories Section -->
                <div class="subcategories-section-modern" id="subcategoriesSection">
                    <div class="section-header-modern">
                        <div class="section-header-content">
                            <div class="section-icon-wrapper">
                                <i class="fas fa-sitemap"></i>
                            </div>
                            <div class="section-content-header">
                                <h2 class="section-title-modern">{% trans "الأقسام الفرعية" %}</h2>
                                <p class="section-subtitle" id="subcategoriesCount">{% trans "استكشف الأقسام الفرعية المتاحة" %}</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <div class="section-stats">
                                <span class="stats-badge" id="subcategoriesStatsCount">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                            </div>
                            <div class="section-toggle">
                                <button class="btn section-toggle-btn" id="subcategoriesToggle" data-target="subcategoriesContent">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="section-content-modern" id="subcategoriesContent">
                        <!-- Subcategories Grid -->
                        <div id="subcategoriesGrid" class="content-grid" data-view="grid">
                            <!-- Subcategories will be loaded here via AJAX -->
                        </div>

                        <!-- No subcategories message -->
                        <div id="noSubcategoriesMessage" class="empty-state" style="display: none;">
                            <div class="empty-icon">
                                <i class="fas fa-folder-open"></i>
                            </div>
                            <h4 class="empty-title">{% trans "لا توجد أقسام فرعية" %}</h4>
                            <p class="empty-desc">{% trans "لا توجد أقسام فرعية لهذا القسم حالياً" %}</p>
                        </div>
                    </div>
                </div>

                <!-- Ads Section -->
                <div class="ads-section-modern" id="adsSection">
                    <div class="section-header-modern">
                        <div class="section-header-content">
                            <div class="section-icon-wrapper">
                                <i class="fas fa-bullhorn"></i>
                            </div>
                            <div class="section-content-header">
                                <h2 class="section-title-modern">{% trans "الإعلانات المتاحة" %}</h2>
                                <p class="section-subtitle">{% trans "تصفح جميع الإعلانات في هذا القسم" %}</p>
                            </div>
                        </div>
                        <div class="section-actions">
                            <div class="section-stats">
                                <span class="stats-badge" id="adsStatsCount">{{ ads|length }}</span>
                            </div>
                            <div class="section-toggle">
                                <button class="btn section-toggle-btn" id="adsToggle" data-target="adsContent">
                                    <i class="fas fa-chevron-down"></i>
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="section-content-modern" id="adsContent">
                        <!-- Ads Grid/List -->
                        <div id="adsContainer" class="content-grid" data-view="grid">
                            <div class="row" id="adsBootstrapGrid">
                                {% for ad in ads %}
                                    <div class="col-xl-3 col-lg-4 col-md-6 col-sm-12 mb-4 bootstrap-ad-card" data-category="{{ ad.category.slug|default:'' }}">
                                        {% include "partials/_ad_card_component.html" with ad=ad %}
                                    </div>
                                {% empty %}
                            </div>
                            <div class="col-12">
                                <div class="empty-state">
                                    <div class="empty-icon">
                                        <i class="fas fa-bullhorn"></i>
                                    </div>
                                    <h4 class="empty-title">{% trans "لا توجد إعلانات" %}</h4>
                                    <p class="empty-desc">{% trans "لا توجد إعلانات في هذا القسم حالياً" %}</p>
                                    <a href="{% url 'main:ad_create' %}" class="btn btn-primary">
                                        <i class="fas fa-plus me-2"></i>{% trans "أضف إعلانك الأول" %}
                                    </a>
                                </div>
                            </div>
                            {% endfor %}
                        </div>

                        <!-- Pagination -->
                        {% if is_paginated %}
                            <nav aria-label="Page navigation" class="pagination-modern">
                                <ul class="pagination justify-content-center">
                                    {% if page_obj.has_previous %}
                                        <li class="page-item">
                                            <a class="page-link modern-page-link" href="?page={{ page_obj.previous_page_number }}&{{ query_params }}">
                                                <i class="fas fa-chevron-left me-1"></i>{% trans "السابق" %}
                                            </a>
                                        </li>
                                    {% endif %}

                                    {% for num in paginator.page_range %}
                                        {% if page_obj.number == num %}
                                            <li class="page-item active">
                                                <span class="page-link modern-page-link">{{ num }}</span>
                                            </li>
                                        {% else %}
                                            <li class="page-item">
                                                <a class="page-link modern-page-link" href="?page={{ num }}&{{ query_params }}">{{ num }}</a>
                                            </li>
                                        {% endif %}
                                    {% endfor %}

                                    {% if page_obj.has_next %}
                                        <li class="page-item">
                                            <a class="page-link modern-page-link" href="?page={{ page_obj.next_page_number }}&{{ query_params }}">
                                                {% trans "التالي" %}<i class="fas fa-chevron-right ms-1"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                        {% endif %}
                    </div>
                </div>
            </div>
        </section>

    {% else %}
        <!-- Category not found -->
        <section class="error-section">
            <div class="container">
                <div class="error-state-modern">
                    <div class="error-icon-wrapper">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <h2 class="error-title-modern">{% trans "القسم غير موجود" %}</h2>
                    <p class="error-message-modern">{% trans "عذراً، القسم المطلوب غير موجود أو غير متاح حالياً" %}</p>
                    <div class="error-actions-modern">
                        <a href="{% url 'main:categories' %}" class="btn btn-primary btn-lg">
                            <i class="fas fa-th-large me-2"></i>{% trans "تصفح الأقسام" %}
                        </a>
                        <a href="{% url 'main:home' %}" class="btn btn-outline-primary btn-lg">
                            <i class="fas fa-home me-2"></i>{% trans "العودة للرئيسية" %}
                        </a>
                    </div>
                </div>
            </div>
        </section>
    {% endif %}
{% endblock content %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const categoryId = {{ category.id|default:0 }};

    // Initialize Modern Category Detail Manager
    class ModernCategoryDetailManager {
        constructor(categoryId) {
            this.categoryId = categoryId;
            this.currentSort = 'date';
            this.currentType = 'all';
            this.searchQuery = '';
            this.currentView = 'grid';
            this.currentCountry = '';
            this.priceRange = { min: null, max: null };

            // Initialize DOM elements
            this.searchInput = document.getElementById('categorySearchInput');
            this.clearSearchBtn = document.getElementById('clearSearchBtn');
            this.countryFilter = document.getElementById('countryFilter');
            this.minPriceInput = document.getElementById('minPrice');
            this.maxPriceInput = document.getElementById('maxPrice');
            this.filterDropdown = document.getElementById('filterDropdownBtn');
            this.contentLoader = document.getElementById('contentLoader');
            this.noResults = document.getElementById('noResultsMessage');

            // View toggle buttons (new IDs)
            this.heroGridViewToggle = document.getElementById('heroGridViewToggle');
            this.heroListViewToggle = document.getElementById('heroListViewToggle');
            this.gridViewToggle = document.getElementById('gridViewToggle');
            this.listViewToggle = document.getElementById('listViewToggle');

            // Legacy support for old IDs
            this.gridViewBtn = document.getElementById('gridViewBtn') || this.gridViewToggle;
            this.listViewBtn = document.getElementById('listViewBtn') || this.listViewToggle;

            this.subcategoriesSection = document.getElementById('subcategoriesSection');
            this.adsSection = document.getElementById('adsSection');
            this.subcategoriesGrid = document.getElementById('subcategoriesGrid');
            this.adsContainer = document.getElementById('adsContainer');

            this.currentSort = 'recent';
            this.currentType = 'all';
            this.searchQuery = '';
            this.currentLayout = 'grid';
            this.debounceTimeout = null;

            this.init();
        }

        init() {
            this.loadCategoryData();
            this.setupSearchFunctionality();
            this.setupFilterFunctionality();
            this.setupPriceFiltering();
            this.setupLocationFiltering();
            this.setupAdvancedFiltering();
            this.setupViewToggle();
            this.setupSectionToggling();
            this.setupAnimations();

            console.log('✅ Modern Category Detail Manager initialized');
        }

        loadCategoryData() {
            if (!this.categoryId) return;

            // Load subcategories
            this.loadSubcategories();

            // Load category stats
            this.loadCategoryStats();
        }

        setupSearchFunctionality() {
            if (!this.searchInput) return;

            // Real-time search with debouncing
            let searchTimeout;
            this.searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();

                if (query.length > 0) {
                    this.clearSearchBtn.style.display = 'block';
                } else {
                    this.clearSearchBtn.style.display = 'none';
                }

                searchTimeout = setTimeout(() => {
                    this.searchQuery = query;
                    this.filterContent();
                }, 300);
            });

            // Clear search functionality
            this.clearSearchBtn?.addEventListener('click', () => {
                this.searchInput.value = '';
                this.clearSearchBtn.style.display = 'none';
                this.searchQuery = '';
                this.filterContent();
                this.searchInput.focus();
            });

            // Search on enter
            this.searchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.searchQuery = this.searchInput.value.trim();
                    this.filterContent();
                }
            });
        }

        setupFilterFunctionality() {
            // Filter option clicks
            document.querySelectorAll('.filter-option').forEach(option => {
                option.addEventListener('click', (e) => {
                    e.preventDefault();

                    // Remove active class from all options in this group
                    const parent = option.closest('.dropdown-menu');
                    if (option.dataset.sort) {
                        parent.querySelectorAll('[data-sort]').forEach(o => o.classList.remove('active'));
                        this.currentSort = option.dataset.sort;
                    } else if (option.dataset.type) {
                        parent.querySelectorAll('[data-type]').forEach(o => o.classList.remove('active'));
                        this.currentType = option.dataset.type;
                    }

                    option.classList.add('active');
                    this.filterContent();

                    // Update filter button text
                    this.updateFilterButtonText();
                });
            });

            // Reset filters button
            document.getElementById('resetFiltersBtn')?.addEventListener('click', () => {
                this.resetFilters();
            });
        },

        setupPriceFiltering() {
            const minPriceInput = document.getElementById('min-price');
            const maxPriceInput = document.getElementById('max-price');

            if (minPriceInput && maxPriceInput) {
                [minPriceInput, maxPriceInput].forEach(input => {
                    input.addEventListener('input', () => {
                        this.debounced(() => this.applyFilters(), 500);
                    });
                });
            }
        },

        setupLocationFiltering() {
            const locationInput = document.getElementById('location');

            if (locationInput) {
                locationInput.addEventListener('input', () => {
                    this.debounced(() => this.applyFilters(), 500);
                });
            }
        },

        setupAdvancedFiltering() {
            const sortSelect = document.getElementById('sort');
            const negotiableCheckbox = document.getElementById('negotiable');
            const deliveryCheckbox = document.getElementById('delivery');
            const verifiedCheckbox = document.getElementById('verified');

            [sortSelect, negotiableCheckbox, deliveryCheckbox, verifiedCheckbox].forEach(element => {
                if (element) {
                    element.addEventListener('change', () => this.applyFilters());
                }
            });
        },

        applyFilters() {
            const searchValue = document.getElementById('search-input')?.value || '';
            const minPrice = document.getElementById('min-price')?.value || '';
            const maxPrice = document.getElementById('max-price')?.value || '';
            const location = document.getElementById('location')?.value || '';
            const sortBy = document.getElementById('sort')?.value || '';
            const negotiable = document.getElementById('negotiable')?.checked || false;
            const delivery = document.getElementById('delivery')?.checked || false;
            const verified = document.getElementById('verified')?.checked || false;

            const params = new URLSearchParams();
            if (searchValue) params.append('search', searchValue);
            if (minPrice) params.append('min_price', minPrice);
            if (maxPrice) params.append('max_price', maxPrice);
            if (location) params.append('location', location);
            if (sortBy) params.append('ordering', sortBy);
            if (negotiable) params.append('negotiable', 'true');
            if (delivery) params.append('delivery', 'true');
            if (verified) params.append('verified', 'true');

            // Add category to maintain context
            if (this.categoryData.id) {
                params.append('category', this.categoryData.id);
            }

            // Update URL without page reload
            const newUrl = `${window.location.pathname}?${params.toString()}`;
            window.history.pushState({}, '', newUrl);

            // Apply filters to visible ads
            this.filterAds({
                search: searchValue,
                minPrice,
                maxPrice,
                location,
                sortBy,
                negotiable,
                delivery,
                verified
            });
        },

        filterAds(filters) {
            // Client-side filtering demonstration (replace with AJAX in production)
            console.log('Applying filters:', filters);

            const adCards = document.querySelectorAll('.classified-ad-card');

            adCards.forEach(card => {
                let shouldShow = true;

                // Search filter
                if (filters.search) {
                    const title = card.querySelector('.ad-title')?.textContent.toLowerCase() || '';
                    const description = card.querySelector('.ad-description')?.textContent.toLowerCase() || '';
                    const searchTerm = filters.search.toLowerCase();

                    if (!title.includes(searchTerm) && !description.includes(searchTerm)) {
                        shouldShow = false;
                    }
                }

                // Price filters
                if (filters.minPrice || filters.maxPrice) {
                    const priceElement = card.querySelector('.ad-price');
                    const priceText = priceElement?.textContent.replace(/[^\d.]/g, '') || '0';
                    const price = parseFloat(priceText);

                    if (filters.minPrice && price < parseFloat(filters.minPrice)) {
                        shouldShow = false;
                    }
                    if (filters.maxPrice && price > parseFloat(filters.maxPrice)) {
                        shouldShow = false;
                    }
                }

                // Location filter
                if (filters.location) {
                    const location = card.querySelector('.ad-location')?.textContent.toLowerCase() || '';
                    if (!location.includes(filters.location.toLowerCase())) {
                        shouldShow = false;
                    }
                }

                // Show/hide card with animation
                if (shouldShow) {
                    card.style.display = 'block';
                    gsap.to(card, { opacity: 1, scale: 1, duration: 0.3 });
                } else {
                    gsap.to(card, {
                        opacity: 0,
                        scale: 0.9,
                        duration: 0.3,
                        onComplete: () => card.style.display = 'none'
                    });
                }
            });
        },

        debounced(func, delay) {
            clearTimeout(this.debounceTimeout);
            this.debounceTimeout = setTimeout(func, delay);
        }

        setupViewToggle() {
            // Handle all view toggle buttons
            const allGridButtons = [
                this.gridViewBtn,
                this.gridViewToggle,
                this.heroGridViewToggle,
                document.getElementById('gridViewBtn')
            ].filter(btn => btn);

            const allListButtons = [
                this.listViewBtn,
                this.listViewToggle,
                this.heroListViewToggle,
                document.getElementById('listViewBtn')
            ].filter(btn => btn);

            // Grid view handlers
            allGridButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    this.setLayout('grid');
                });
            });

            // List view handlers
            allListButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    this.setLayout('list');
                });
            });

            // Country filter handler
            if (this.countryFilter) {
                this.countryFilter.addEventListener('change', (e) => {
                    this.currentCountry = e.target.value;
                    this.applyFilters();
                });
            }

            // Price range handlers
            if (this.minPriceInput) {
                this.minPriceInput.addEventListener('input', (e) => {
                    this.priceRange.min = e.target.value ? parseFloat(e.target.value) : null;
                    this.debounced(() => this.applyFilters(), 500);
                });
            }

            if (this.maxPriceInput) {
                this.maxPriceInput.addEventListener('input', (e) => {
                    this.priceRange.max = e.target.value ? parseFloat(e.target.value) : null;
                    this.debounced(() => this.applyFilters(), 500);
                });
            }
        }

        setupSectionToggling() {
            // Enhanced section toggle functionality
            document.querySelectorAll('.section-toggle-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = btn.dataset.target;
                    const targetElement = document.getElementById(targetId);
                    const chevronIcon = btn.querySelector('i');

                    if (targetElement) {
                        const isCollapsed = targetElement.style.display === 'none';

                        if (isCollapsed) {
                            // Expand section
                            targetElement.style.display = 'block';
                            chevronIcon.style.transform = 'rotate(0deg)';
                            btn.classList.remove('collapsed');

                            // Animate section expansion
                            if (globalThis.gsap) {
                                globalThis.gsap.from(targetElement, {
                                    height: 0,
                                    opacity: 0,
                                    duration: 0.3,
                                    ease: 'power2.out'
                                });
                            }
                        } else {
                            // Collapse section
                            if (globalThis.gsap) {
                                globalThis.gsap.to(targetElement, {
                                    height: 0,
                                    opacity: 0,
                                    duration: 0.3,
                                    ease: 'power2.in',
                                    onComplete: () => {
                                        targetElement.style.display = 'none';
                                        targetElement.style.height = 'auto';
                                        targetElement.style.opacity = '1';
                                    }
                                });
                            } else {
                                targetElement.style.display = 'none';
                            }

                            chevronIcon.style.transform = 'rotate(180deg)';
                            btn.classList.add('collapsed');
                        }
                    }
                });
            });

            // Update section counters
            this.updateSectionCounters();
        }

        updateSectionCounters() {
            // Update subcategories counter
            const subcatsCount = document.querySelectorAll('.content-item[data-type="subcategory"]').length;
            const subcatsStatsElement = document.getElementById('subcategoriesStatsCount');
            if (subcatsStatsElement) {
                subcatsStatsElement.innerHTML = subcatsCount;
            }

            // Update ads counter (already done, but make sure it's current)
            const adsCount = document.querySelectorAll('.bootstrap-ad-card').length;
            const adsStatsElement = document.getElementById('adsStatsCount');
            if (adsStatsElement && !adsStatsElement.textContent.includes('fa-')) {
                adsStatsElement.innerHTML = adsCount;
            }
        }

        setupAnimations() {
            if (globalThis.gsap && globalThis.ScrollTrigger) {
                // Hero animation
                globalThis.gsap.from('.modern-category-title', {
                    y: 50,
                    opacity: 0,
                    duration: 0.8,
                    ease: 'power2.out'
                });

                globalThis.gsap.from('.modern-category-desc', {
                    y: 30,
                    opacity: 0,
                    duration: 0.8,
                    delay: 0.2,
                    ease: 'power2.out'
                });

                globalThis.gsap.from('.category-search-container', {
                    y: 40,
                    opacity: 0,
                    duration: 0.8,
                    delay: 0.4,
                    ease: 'power2.out'
                });

                // Stats cards animation
                globalThis.gsap.from('.stat-card-modern', {
                    scale: 0.8,
                    opacity: 0,
                    duration: 0.6,
                    delay: 0.3,
                    stagger: 0.1,
                    ease: 'back.out(1.7)'
                });

                // Content sections animation
                globalThis.gsap.from('.section-header-modern', {
                    scrollTrigger: {
                        trigger: '.modern-category-content',
                        start: 'top 85%'
                    },
                    y: 30,
                    opacity: 0,
                    duration: 0.6,
                    stagger: 0.2,
                    ease: 'power2.out'
                });
            }
        }

        loadSubcategories() {
            const loadingIndicator = document.getElementById('subcategoriesLoading');
            const noSubcatsMessage = document.getElementById('noSubcategoriesMessage');

            fetch(`/ajax/subcategories/${this.categoryId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        console.error('Error loading subcategories:', data.error);
                        noSubcatsMessage.style.display = 'block';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        this.renderSubcategories(data.subcategories);
                    } else {
                        noSubcatsMessage.style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error fetching subcategories:', error);
                    noSubcatsMessage.style.display = 'block';
                });
        }

        renderSubcategories(subcategories) {
            this.subcategoriesGrid.innerHTML = '';

            subcategories.forEach(subcat => {
                const subcatCard = this.createSubcategoryCard(subcat);
                this.subcategoriesGrid.appendChild(subcatCard);
            });

            // Add click handlers for subcategory cards
            this.addSubcategoryClickHandlers();

            // Update section counters
            this.updateSectionCounters();

            // Animate in
            if (globalThis.gsap) {
                globalThis.gsap.from('.subcategory-card-modern', {
                    y: 30,
                    opacity: 0,
                    duration: 0.5,
                    stagger: 0.1,
                    ease: 'power2.out'
                });
            }
        }

        createSubcategoryCard(subcat) {
            const wrapper = document.createElement('div');
            wrapper.className = 'content-item';
            wrapper.dataset.type = 'subcategory';
            wrapper.dataset.title = subcat.name.toLowerCase();

            wrapper.innerHTML = `
                <div class="subcategory-card-modern" data-category-id="${subcat.id}" data-category-slug="${subcat.slug}">
                    <div class="card-header-modern">
                        <div class="subcategory-icon-modern">
                            <i class="${subcat.icon || 'fas fa-tag'}"></i>
                        </div>
                        ${subcat.has_children ? '<div class="subcategory-badge-modern"><i class="fas fa-plus"></i></div>' : ''}
                    </div>
                    <div class="card-content-modern">
                        <h4 class="subcategory-title-modern">${subcat.name}</h4>
                        <div class="subcategory-stats-modern">
                            <div class="stat-item-modern">
                                <span class="stat-count-modern" data-stat="ads">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </span>
                                <span class="stat-label-modern">{% trans "إعلان" %}</span>
                            </div>
                        </div>
                    </div>
                    <div class="card-actions-modern">
                        <button class="btn btn-primary btn-sm view-subcategory" onclick="viewSubcategory('${subcat.slug}')">
                            <i class="fas fa-eye me-1"></i>{% trans "عرض" %}
                        </button>
                        <button class="btn btn-outline-primary btn-sm load-subcat-data"
                                onclick="loadSubcategoryData(${subcat.id})"
                                title="{% trans 'تحميل البيانات' %}">
                            <i class="fas fa-info-circle"></i>
                        </button>
                    </div>
                </div>
            `;

            // Load subcategory stats
            setTimeout(() => this.loadSubcategoryStats(subcat.id), 100);

            return wrapper;
        }

        addSubcategoryClickHandlers() {
            document.querySelectorAll('.subcategory-card-modern').forEach(card => {
                card.addEventListener('click', function(e) {
                    if (e.target.closest('.card-actions-modern')) return;

                    const slug = this.dataset.categorySlug;
                    if (slug) {
                        // Add loading animation
                        card.style.transform = 'scale(0.95)';
                        setTimeout(() => {
                            globalThis.location.href = `/category/${slug}/`;
                        }, 200);
                    }
                });

                // Hover effects
                card.addEventListener('mouseenter', () => {
                    if (globalThis.gsap) {
                        globalThis.gsap.to(card, {
                            y: -8,
                            scale: 1.02,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    }
                });

                card.addEventListener('mouseleave', () => {
                    if (globalThis.gsap) {
                        globalThis.gsap.to(card, {
                            y: 0,
                            scale: 1,
                            duration: 0.3,
                            ease: 'power2.out'
                        });
                    }
                });
            });
        }

        loadSubcategoryStats(subcatId) {
            fetch(`/ajax/category-stats/?category_id=${subcatId}`)
                .then(response => response.json())
                .then(data => {
                    const statElement = document.querySelector(`[data-category-id="${subcatId}"] [data-stat="ads"]`);
                    if (statElement) {
                        statElement.innerHTML = data.ads_count || 0;
                    }
                })
                .catch(error => {
                    console.error('Error loading subcategory stats:', error);
                    const statElement = document.querySelector(`[data-category-id="${subcatId}"] [data-stat="ads"]`);
                    if (statElement) {
                        statElement.innerHTML = '0';
                    }
                });
        }

        loadCategoryStats() {
            fetch(`/ajax/category-stats/?category_id=${this.categoryId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('categoryAdsCount').textContent = data.ads_count || 0;
                    document.getElementById('categorySubcatsCount').textContent = data.subcategories_count || 0;
                })
                .catch(error => {
                    console.error('Error loading category stats:', error);
                    document.getElementById('categoryAdsCount').textContent = '0';
                    document.getElementById('categorySubcatsCount').textContent = '0';
                });
        }

        filterContent() {
            this.showLoader();

            setTimeout(() => {
                // Handle subcategories (still using content-item)
                const allSubcatItems = document.querySelectorAll('.content-item[data-type="subcategory"]');
                // Handle ads (now using bootstrap-ad-card)
                const allAdItems = document.querySelectorAll('.bootstrap-ad-card');

                let visibleCount = 0;
                let hasResults = false;

                // Filter subcategories
                allSubcatItems.forEach(item => {
                    const itemType = item.dataset.type;
                    const itemTitle = item.dataset.title || '';

                    let shouldShow = true;

                    // Type filter
                    if (this.currentType !== 'all') {
                        if (this.currentType === 'ads') {
                            shouldShow = false; // Hide subcategories when filtering for ads only
                        } else if (this.currentType === 'subcategories' && itemType !== 'subcategory') {
                            shouldShow = false;
                        }
                    }

                    // Search filter
                    if (this.searchQuery && !itemTitle.includes(this.searchQuery.toLowerCase())) {
                        shouldShow = false;
                    }

                    // Apply visibility
                    if (shouldShow) {
                        item.style.display = 'block';
                        this.animateIn(item);
                        visibleCount++;
                        hasResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Filter ads
                allAdItems.forEach(item => {
                    // Get ad data from the included ad card
                    const adCard = item.querySelector('.modern-ad-card');
                    const adTitle = adCard ? (adCard.querySelector('.ad-title')?.textContent || '').toLowerCase() : '';

                    let shouldShow = true;

                    // Type filter
                    if (this.currentType !== 'all') {
                        if (this.currentType === 'subcategories') {
                            shouldShow = false; // Hide ads when filtering for subcategories only
                        }
                    }

                    // Search filter
                    if (this.searchQuery && !adTitle.includes(this.searchQuery.toLowerCase())) {
                        shouldShow = false;
                    }

                    // Apply visibility
                    if (shouldShow) {
                        item.style.display = 'block';
                        this.animateIn(item);
                        visibleCount++;
                        hasResults = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                // Sort visible items
                this.sortContent();

                // Update sections visibility
                this.updateSectionsVisibility();

                this.hideLoader();

                if (!hasResults) {
                    this.showNoResults();
                } else {
                    this.hideNoResults();
                }
            }, 300);
        }

        sortContent() {
            const adsItems = Array.from(document.querySelectorAll('.bootstrap-ad-card'));
            const visibleAdsItems = adsItems.filter(item => item.style.display !== 'none');

            if (this.currentSort && visibleAdsItems.length > 0) {
                visibleAdsItems.sort((a, b) => {
                    if (this.currentSort === 'price_low') {
                        return (parseFloat(a.dataset.price) || 0) - (parseFloat(b.dataset.price) || 0);
                    } else if (this.currentSort === 'price_high') {
                        return (parseFloat(b.dataset.price) || 0) - (parseFloat(a.dataset.price) || 0);
                    } else if (this.currentSort === 'recent') {
                        // Sort by creation date (if available)
                        return 0; // Placeholder
                    }
                    return 0;
                });

                // Re-append in sorted order
                visibleAdsItems.forEach(item => {
                    this.adsContainer.appendChild(item);
                });
            }
        }

        updateSectionsVisibility() {
            const hasVisibleSubcats = document.querySelectorAll('.content-item[data-type="subcategory"]:not([style*="display: none"])').length > 0;
            const hasVisibleAds = document.querySelectorAll('.bootstrap-ad-card:not([style*="display: none"])').length > 0;

            if (this.subcategoriesSection) {
                this.subcategoriesSection.style.display = hasVisibleSubcats ? 'block' : 'none';
            }

            if (this.adsSection) {
                this.adsSection.style.display = hasVisibleAds ? 'block' : 'none';
            }
        }

        setLayout(layout) {
            this.currentLayout = layout;

            // Update all button states
            const allButtons = [
                this.gridViewBtn,
                this.gridViewToggle,
                this.heroGridViewToggle,
                this.listViewBtn,
                this.listViewToggle,
                this.heroListViewToggle,
                document.getElementById('gridViewBtn'),
                document.getElementById('listViewBtn')
            ].filter(btn => btn);

            allButtons.forEach(btn => {
                const isGridBtn = btn.dataset.view === 'grid' ||
                                  btn.id?.includes('grid') ||
                                  btn === this.gridViewBtn ||
                                  btn === this.gridViewToggle ||
                                  btn === this.heroGridViewToggle;

                if (isGridBtn) {
                    btn.classList.toggle('active', layout === 'grid');
                } else {
                    btn.classList.toggle('active', layout === 'list');
                }
            });

            // Update container layouts
            document.querySelectorAll('.content-grid, .ads-grid, #adsBootstrapGrid').forEach(container => {
                container.setAttribute('data-view', layout);
            });
        }

        updateFilterButtonText() {
            const activeType = document.querySelector('.filter-option[data-type].active');
            const activeSort = document.querySelector('.filter-option[data-sort].active');

            if (activeType && activeType.dataset.type !== 'all') {
                this.filterDropdown.querySelector('.filter-text').textContent = activeType.textContent.trim();
            } else {
                this.filterDropdown.querySelector('.filter-text').textContent = '{% trans "فلترة" %}';
            }
        }

        resetFilters() {
            this.searchInput.value = '';
            this.clearSearchBtn.style.display = 'none';
            this.searchQuery = '';
            this.currentType = 'all';
            this.currentSort = 'recent';

            // Reset filter options
            document.querySelectorAll('.filter-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.type === 'all' || option.dataset.sort === 'recent') {
                    option.classList.add('active');
                }
            });

            this.updateFilterButtonText();
            this.filterContent();
        }

        showLoader() {
            this.contentLoader.style.display = 'flex';
        }

        hideLoader() {
            this.contentLoader.style.display = 'none';
        }

        showNoResults() {
            this.noResults.style.display = 'block';
        }

        hideNoResults() {
            this.noResults.style.display = 'none';
        }

        animateIn(element) {
            if (globalThis.gsap) {
                globalThis.gsap.from(element, {
                    y: 20,
                    opacity: 0,
                    duration: 0.4,
                    ease: 'power2.out'
                });
            }
        }
    }

    // Initialize the manager
    globalThis.categoryManager = new ModernCategoryDetailManager(categoryId);

    // Global functions for onclick handlers
    globalThis.viewSubcategory = function(slug) {
        globalThis.location.href = `/category/${slug}/`;
    };

    globalThis.loadSubcategoryData = function(categoryId) {
        // Show modal or sidebar with detailed subcategory information
        showSubcategoryModal(categoryId);
    };

    function showSubcategoryModal(categoryId) {
        // Create and show a modal with subcategory details
        fetch(`/ajax/subcategories/${categoryId}/`)
            .then(response => response.json())
            .then(data => {
                // Implementation for modal showing subcategory details
                console.log('Subcategory data:', data);
                // You can implement a modal here to show detailed information
            })
            .catch(error => {
                console.error('Error loading subcategory details:', error);
            });
    }
});
</script>
{% endblock extra_js %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/categories-enhanced.css' %}">
    <style>
        /* Category Detail Page - Only page-specific overrides */
        /* All common styles are in categories-enhanced.css and style.css */

        /* Only keep absolutely necessary category_detail specific styles here */
    </style>
{% endblock extra_css %}
