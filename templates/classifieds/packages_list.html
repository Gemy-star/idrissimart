{% extends "base.html" %}

{% load static i18n %}

{% block title %}
    {% trans "باقات نشر الإعلانات" %}
{% endblock title %}

{% block content %}
<div class="container py-5">
    <!-- Header -->
    <div class="text-center mb-5">
        <h1 class="display-5 fw-bold text-primary">{% trans "باقات نشر الإعلانات" %}</h1>
        <p class="lead text-muted">{% trans "اختر الباقة المناسبة لاحتياجاتك وابدأ بنشر إعلاناتك" %}</p>
    </div>

    <!-- Current Active Packages -->
    {% if active_packages %}
        <div class="mb-5">
            <h3 class="text-success mb-4">
                <i class="fas fa-check-circle me-2"></i>{% trans "باقاتك النشطة" %}
            </h3>
            <div class="row g-4">
                {% for user_package in active_packages %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card border-success h-100">
                            <div class="card-header bg-success text-white text-center">
                                <h5 class="mb-0">{{ user_package.package.name }}</h5>
                            </div>
                            <div class="card-body text-center">
                                <div class="mb-3">
                                    <div class="display-6 text-success fw-bold">
                                        {{ user_package.ads_remaining }}
                                    </div>
                                    <small class="text-muted">{% trans "إعلانات متبقية" %}</small>
                                </div>

                                <div class="mb-3">
                                    <i class="fas fa-calendar text-muted me-1"></i>
                                    <small>
                                        {% trans "تنتهي في:" %}
                                        {{ user_package.expiry_date|date:"Y/m/d" }}
                                    </small>
                                </div>

                                {% if user_package.package.category %}
                                    <div class="mb-2">
                                        <span class="badge bg-primary">
                                            {{ user_package.package.category.name_ar|default:user_package.package.category.name }}
                                        </span>
                                    </div>
                                {% endif %}

                                <a href="{% url 'main:ad_create' %}" class="btn btn-success">
                                    <i class="fas fa-plus me-1"></i>{% trans "نشر إعلان" %}
                                </a>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- General Packages -->
    {% if general_packages %}
        <div class="mb-5">
            <h3 class="mb-4">
                <i class="fas fa-tags me-2 text-primary"></i>{% trans "الباقات العامة" %}
            </h3>
            <div class="row g-4">
                {% for package in general_packages %}
                    <div class="col-md-6 col-lg-4">
                        <div class="card h-100 {% if package.is_default %}border-warning{% endif %}">
                            {% if package.is_default %}
                                <div class="ribbon ribbon-warning">{% trans "افتراضية" %}</div>
                            {% endif %}

                            <div class="card-header text-center bg-{% if package.price == 0 %}success{% else %}primary{% endif %} text-white">
                                <h5 class="mb-0">{{ package.name }}</h5>
                                {% if package.price == 0 %}
                                    <small>{% trans "مجانية" %}</small>
                                {% endif %}
                            </div>

                            <div class="card-body text-center">
                                <div class="price-section mb-3">
                                    {% if package.price == 0 %}
                                        <div class="display-6 text-success fw-bold">{% trans "مجاناً" %}</div>
                                    {% else %}
                                        <div class="display-6 text-primary fw-bold">{{ package.price }}</div>
                                        <small class="text-muted">{% trans "ريال سعودي" %}</small>
                                    {% endif %}
                                </div>

                                <div class="features mb-4">
                                    <div class="feature-item mb-2">
                                        <i class="fas fa-check text-success me-2"></i>
                                        {{ package.ad_count }} {% trans "إعلان" %}
                                    </div>
                                    <div class="feature-item mb-2">
                                        <i class="fas fa-calendar text-success me-2"></i>
                                        {{ package.duration_days }} {% trans "يوم" %}
                                    </div>
                                    <div class="feature-item mb-2">
                                        <i class="fas fa-globe text-success me-2"></i>
                                        {% trans "جميع الأقسام" %}
                                    </div>
                                </div>

                                {% if package.description %}
                                    <p class="text-muted small">{{ package.description|truncatewords:20 }}</p>
                                {% endif %}
                            </div>

                            <div class="card-footer text-center">
                                {% if package.price == 0 %}
                                    <button class="btn btn-success w-100" onclick="activatePackage({{ package.id }})">
                                        <i class="fas fa-gift me-1"></i>{% trans "تفعيل مجاناً" %}
                                    </button>
                                {% else %}
                                    <button class="btn btn-primary w-100" onclick="purchasePackage({{ package.id }})">
                                        <i class="fas fa-shopping-cart me-1"></i>{% trans "شراء" %}
                                    </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}

    <!-- Category-Specific Packages -->
    {% if category_packages %}
        <div class="mb-5">
            <h3 class="mb-4">
                <i class="fas fa-layer-group me-2 text-primary"></i>{% trans "باقات مخصصة للأقسام" %}
            </h3>

            {% for category, packages in category_packages.items %}
                <div class="category-section mb-5">
                    <h4 class="text-secondary mb-3">
                        {% if category.icon %}
                            <i class="{{ category.icon }} me-2"></i>
                        {% endif %}
                        {{ category.name_ar|default:category.name }}
                    </h4>

                    <div class="row g-4">
                        {% for package in packages %}
                            <div class="col-md-6 col-lg-4">
                                <div class="card h-100 border-secondary">
                                    <div class="card-header text-center bg-secondary text-white">
                                        <h6 class="mb-0">{{ package.name }}</h6>
                                    </div>

                                    <div class="card-body text-center">
                                        <div class="price-section mb-3">
                                            <div class="h4 text-secondary fw-bold">{{ package.price }}</div>
                                            <small class="text-muted">{% trans "ريال سعودي" %}</small>
                                        </div>

                                        <div class="features mb-3">
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-check text-success me-2"></i>
                                                {{ package.ad_count }} {% trans "إعلان" %}
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-calendar text-success me-2"></i>
                                                {{ package.duration_days }} {% trans "يوم" %}
                                            </div>
                                            <div class="feature-item mb-2">
                                                <i class="fas fa-tag text-success me-2"></i>
                                                {% trans "مخصص للقسم" %}
                                            </div>
                                        </div>

                                        {% if package.description %}
                                            <p class="text-muted small">{{ package.description|truncatewords:15 }}</p>
                                        {% endif %}
                                    </div>

                                    <div class="card-footer text-center">
                                        <button class="btn btn-secondary w-100" onclick="purchasePackage({{ package.id }})">
                                            <i class="fas fa-shopping-cart me-1"></i>{% trans "شراء" %}
                                        </button>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Features Comparison -->
    <div class="mb-5">
        <h3 class="mb-4 text-center">
            <i class="fas fa-star me-2 text-warning"></i>{% trans "مقارنة الميزات" %}
        </h3>

        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>{% trans "الميزة" %}</th>
                                <th class="text-center">{% trans "الباقة المجانية" %}</th>
                                <th class="text-center">{% trans "الباقات المدفوعة" %}</th>
                                <th class="text-center">{% trans "الباقات المميزة" %}</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>
                                    <i class="fas fa-plus-circle text-primary me-2"></i>
                                    {% trans "نشر الإعلانات" %}
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <i class="fas fa-images text-primary me-2"></i>
                                    {% trans "رفع الصور" %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">3 {% trans "صور" %}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">10 {% trans "صور" %}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{% trans "غير محدود" %}</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <i class="fas fa-video text-primary me-2"></i>
                                    {% trans "إضافة فيديو" %}
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-times text-danger"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <i class="fas fa-shopping-cart text-primary me-2"></i>
                                    {% trans "سلة الحجز" %}
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-times text-danger"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-check text-success"></i>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <i class="fas fa-thumbtack text-primary me-2"></i>
                                    {% trans "إمكانية التثبيت" %}
                                </td>
                                <td class="text-center">
                                    <i class="fas fa-times text-danger"></i>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-warning">{% trans "مدفوع" %}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{% trans "خصم 50%" %}</span>
                                </td>
                            </tr>
                            <tr>
                                <td>
                                    <i class="fas fa-headset text-primary me-2"></i>
                                    {% trans "الدعم الفني" %}
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-secondary">{% trans "أساسي" %}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-primary">{% trans "مميز" %}</span>
                                </td>
                                <td class="text-center">
                                    <span class="badge bg-success">{% trans "أولوية" %}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- FAQ Section -->
    <div class="mb-5">
        <h3 class="mb-4 text-center">
            <i class="fas fa-question-circle me-2 text-info"></i>{% trans "أسئلة شائعة" %}
        </h3>

        <div class="accordion" id="faqAccordion">
            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                        {% trans "كيف أختار الباقة المناسبة؟" %}
                    </button>
                </h2>
                <div id="faq1" class="accordion-collapse collapse show" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {% trans "ابدأ بالباقة المجانية إذا كنت جديداً. للاستخدام المكثف، اختر الباقات المدفوعة. للأعمال التجارية، اختر الباقات المميزة." %}
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                        {% trans "هل يمكنني تغيير الباقة لاحقاً؟" %}
                    </button>
                </h2>
                <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {% trans "نعم، يمكنك ترقية باقتك في أي وقت. الإعلانات المتبقية من الباقة السابقة ستبقى متاحة." %}
                    </div>
                </div>
            </div>

            <div class="accordion-item">
                <h2 class="accordion-header">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                        {% trans "ماذا يحدث عند انتهاء الباقة؟" %}
                    </button>
                </h2>
                <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                    <div class="accordion-body">
                        {% trans "إعلاناتك الحالية ستبقى نشطة، لكن لن تتمكن من نشر إعلانات جديدة حتى تجدد الباقة أو تشتري باقة جديدة." %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Purchase Modal -->
<div class="modal fade" id="purchaseModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">{% trans "شراء الباقة" %}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="purchaseContent">
                    <!-- Purchase form will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock content %}

{% block extra_js %}
<script>
function purchasePackage(packageId) {
    // Show purchase modal
    const modal = new bootstrap.Modal(document.getElementById('purchaseModal'));
    document.getElementById('purchaseContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">{% trans "جارٍ التحميل..." %}</span>
            </div>
            <p class="mt-2">{% trans "جارٍ تحضير عملية الشراء..." %}</p>
        </div>
    `;
    modal.show();

    // Simulate purchase process (replace with actual payment integration)
    setTimeout(() => {
        document.getElementById('purchaseContent').innerHTML = `
            <div class="text-center">
                <i class="fas fa-credit-card text-primary fs-1 mb-3"></i>
                <h5>{% trans "اختر طريقة الدفع" %}</h5>
                <div class="d-grid gap-2 mt-3">
                    <button class="btn btn-primary" onclick="processPayment('visa')">
                        <i class="fab fa-cc-visa me-2"></i>{% trans "بطاقة ائتمانية" %}
                    </button>
                    <button class="btn btn-success" onclick="processPayment('mada')">
                        <i class="fas fa-credit-card me-2"></i>{% trans "مدى" %}
                    </button>
                    <button class="btn btn-info" onclick="processPayment('paypal')">
                        <i class="fab fa-paypal me-2"></i>{% trans "PayPal" %}
                    </button>
                </div>
            </div>
        `;
    }, 1000);
}

function activatePackage(packageId) {
    // Make AJAX call to activate package without confirmation
    fetch('/ajax/activate-package/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({
            'package_id': packageId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.showNotification(data.message, 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            // Show error message using toast notification
            window.showNotification(data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.showNotification('{% trans "حدث خطأ في تفعيل الباقة" %}', 'error');
    });
}

function processPayment(method) {
    document.getElementById('purchaseContent').innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">{% trans "جارٍ المعالجة..." %}</span>
            </div>
            <p class="mt-2">{% trans "جارٍ معالجة الدفع..." %}</p>
        </div>
    `;

    // Simulate payment processing
    setTimeout(() => {
        document.getElementById('purchaseContent').innerHTML = `
            <div class="text-center">
                <i class="fas fa-check-circle text-success fs-1 mb-3"></i>
                <h5 class="text-success">{% trans "تمت عملية الشراء بنجاح!" %}</h5>
                <p>{% trans "تم تفعيل الباقة في حسابك" %}</p>
                <button class="btn btn-success" onclick="location.reload()">
                    {% trans "إغلاق" %}
                </button>
            </div>
        `;
    }, 2000);
}
</script>
{% endblock extra_js %}

{% block extra_css %}
<style>
    .ribbon {
        position: absolute;
        top: 10px;
        right: -5px;
        background: #ffc107;
        color: #000;
        padding: 5px 15px;
        font-size: 12px;
        font-weight: bold;
        transform: rotate(45deg);
        z-index: 1;
    }

    .ribbon-warning {
        background: #ffc107;
    }

    .card {
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    }

    .price-section {
        padding: 1rem 0;
    }

    .feature-item {
        display: flex;
        align-items: center;
        justify-content: flex-start;
        text-align: left;
    }

    .category-section {
        border-left: 4px solid var(--primary-color);
        padding-left: 1rem;
        margin-left: 0.5rem;
    }

    .accordion-button:not(.collapsed) {
        background-color: var(--bs-primary);
        color: white;
    }

    .table-hover tbody tr:hover {
        background-color: rgba(13, 110, 253, 0.05);
    }

    .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }

    @media (max-width: 768px) {
        .display-5 {
            font-size: 2rem;
        }

        .card {
            margin-bottom: 1rem;
        }

        .feature-item {
            font-size: 0.9rem;
        }
    }
</style>
{% endblock extra_css %}
