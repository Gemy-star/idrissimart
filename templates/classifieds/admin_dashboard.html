{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% load currency_tags %}

{% block title %}{% trans "لوحة تحكم الإدارة" %} - {% trans "إدارة الإعلانات" %}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --card-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        --card-hover-shadow: 0 8px 30px rgba(0, 0, 0, 0.12);
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
        --warning-gradient: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        --info-gradient: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
    }

    body {
        background: #f5f7fa;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
    }

    .admin-header {
        background: linear-gradient(135deg, var(--primary-color) 0%, #1d4ed8 100%);
        color: white;
        padding: 2rem 0;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .admin-header h1 {
        font-size: 2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stats-row {
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        transition: transform 0.2s, box-shadow 0.2s;
        border-left: 4px solid;
        cursor: pointer;
    }

    .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card.active { border-left-color: var(--success-color); }
    .stat-card.pending { border-left-color: var(--warning-color); }
    .stat-card.hidden { border-left-color: var(--gray-600); }
    .stat-card.expired { border-left-color: var(--danger-color); }

    .stat-card .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
    }

    .stat-card .stat-label {
        color: var(--gray-600);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .filters-section {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .filter-group {
        display: flex;
        gap: 1rem;
        flex-wrap: wrap;
        align-items: end;
    }

    .filter-item {
        flex: 1;
        min-width: 200px;
    }

    .filter-item label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.875rem;
    }

    .filter-item select,
    .filter-item input {
        width: 100%;
        padding: 0.625rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 8px;
        font-size: 0.875rem;
        transition: border-color 0.2s;
    }

    .filter-item select:focus,
    .filter-item input:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }

    .btn-apply {
        padding: 0.625rem 2rem;
        background: var(--primary-color);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: background 0.2s;
    }

    .btn-apply:hover {
        background: #1d4ed8;
    }

    .ads-table-wrapper {
        background: white;
        border-radius: 12px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .ads-table {
        width: 100%;
        border-collapse: collapse;
    }

    .ads-table thead {
        background: var(--gray-100);
    }

    .ads-table th {
        padding: 1rem;
        text-align: right;
        font-weight: 600;
        color: var(--gray-700);
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid var(--gray-200);
    }

    .ads-table tbody tr {
        border-bottom: 1px solid var(--gray-200);
        transition: background 0.2s;
    }

    .ads-table tbody tr:hover {
        background: var(--gray-50);
    }

    .ads-table td {
        padding: 1rem;
        vertical-align: middle;
    }

    .ad-info {
        display: flex;
        gap: 1rem;
        align-items: center;
    }

    .ad-thumbnail {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid var(--gray-200);
    }

    .ad-details h4 {
        font-size: 1rem;
        font-weight: 600;
        margin-bottom: 0.25rem;
        color: var(--gray-800);
    }

    .ad-details p {
        font-size: 0.875rem;
        color: var(--gray-600);
        margin: 0.125rem 0;
    }

    .status-badge {
        display: inline-block;
        padding: 0.375rem 0.875rem;
        border-radius: 6px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .status-badge.active {
        background: #dcfce7;
        color: #166534;
    }

    .status-badge.pending {
        background: #fef3c7;
        color: #92400e;
    }

    .status-badge.expired {
        background: #fee2e2;
        color: #991b1b;
    }

    .status-badge.hidden {
        background: #f3f4f6;
        color: #374151;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
        justify-content: center;
    }

    .btn-action {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
        display: inline-flex;
        align-items: center;
        gap: 0.375rem;
    }

    .btn-view {
        background: var(--info-color);
        color: white;
    }

    .btn-view:hover {
        background: #0891b2;
    }

    .btn-hide {
        background: var(--gray-600);
        color: white;
    }

    .btn-hide:hover {
        background: var(--gray-700);
    }

    .btn-delete {
        background: var(--danger-color);
        color: white;
    }

    .btn-delete:hover {
        background: #dc2626;
    }

    .btn-cart {
        background: var(--success-color);
        color: white;
    }

    .btn-cart:hover {
        background: #16a34a;
    }

    .pagination {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 0.5rem;
        padding: 2rem 0;
    }

    .pagination a,
    .pagination span {
        padding: 0.5rem 1rem;
        border: 1px solid var(--gray-300);
        border-radius: 6px;
        text-decoration: none;
        color: var(--gray-700);
        transition: all 0.2s;
    }

    .pagination a:hover {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .pagination .current {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
    }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--gray-600);
    }

    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    [dir="rtl"] .ads-table th,
    [dir="rtl"] .ads-table td {
        text-align: right;
    }
</style>
{% endblock %}

{% block content %}
<div class="admin-header">
    <div class="container">
        <h1>{% trans "Advertisement Management" %}</h1>
        <p class="mb-0">{% trans "Manage all advertisements across the platform" %}</p>
    </div>
</div>

<div class="container">
    <!-- Statistics Row -->
    <div class="stats-row">
        <div class="row g-3">
            <div class="col-md-3">
                <div class="stat-card active" onclick="filterByStatus('active')">
                    <div class="stat-number text-success">{{ stats.active_count|default:0 }}</div>
                    <div class="stat-label">{% trans "Active" %} ({{ stats.active_count|default:0 }})</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card pending" onclick="filterByStatus('pending')">
                    <div class="stat-number text-warning">{{ stats.pending_count|default:0 }}</div>
                    <div class="stat-label">{% trans "Pending" %} ({{ stats.pending_count|default:0 }})</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card hidden" onclick="filterByStatus('hidden')">
                    <div class="stat-number text-secondary">{{ stats.hidden_count|default:0 }}</div>
                    <div class="stat-label">{% trans "Hidden" %} ({{ stats.hidden_count|default:0 }})</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card expired" onclick="filterByStatus('expired')">
                    <div class="stat-number text-danger">{{ stats.expired_count|default:0 }}</div>
                    <div class="stat-label">{% trans "Expired" %} ({{ stats.expired_count|default:0 }})</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="filters-section">
        <form method="get" id="filterForm">
            <div class="filter-group">
                <div class="filter-item">
                    <label>{% trans "Approval Selected" %}</label>
                    <select name="approval" id="approvalFilter">
                        <option value="">{% trans "All Statuses" %}</option>
                        <option value="active" {% if request.GET.approval == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                        <option value="pending" {% if request.GET.approval == 'pending' %}selected{% endif %}>{% trans "Pending" %}</option>
                        <option value="expired" {% if request.GET.approval == 'expired' %}selected{% endif %}>{% trans "Expired" %}</option>
                        <option value="hidden" {% if request.GET.approval == 'hidden' %}selected{% endif %}>{% trans "Hidden" %}</option>
                    </select>
                </div>

                <div class="filter-item">
                    <label>{% trans "Search advertisements..." %}</label>
                    <input type="text" name="search" placeholder="{% trans 'Search by title, user, category...' %}" value="{{ request.GET.search }}">
                </div>

                <div class="filter-item">
                    <label>{% trans "All Statuses" %}</label>
                    <select name="status">
                        <option value="">{% trans "All" %}</option>
                        <option value="active" {% if request.GET.status == 'active' %}selected{% endif %}>{% trans "Active" %}</option>
                        <option value="pending" {% if request.GET.status == 'pending' %}selected{% endif %}>{% trans "Pending Review" %}</option>
                        <option value="expired" {% if request.GET.status == 'expired' %}selected{% endif %}>{% trans "Expired" %}</option>
                        <option value="hidden" {% if request.GET.status == 'hidden' %}selected{% endif %}>{% trans "Hidden" %}</option>
                    </select>
                </div>

                <div class="filter-item">
                    <button type="submit" class="btn-apply">
                        <i class="fas fa-filter"></i> {% trans "Apply" %}
                    </button>
                </div>
            </div>
        </form>
    </div>

    <!-- Ads Table -->
    <div class="ads-table-wrapper">
        <table class="ads-table">
            <thead>
                <tr>
                    <th>{% trans "USER INFO" %}</th>
                    <th>{% trans "PRODUCT DETAILS" %}</th>
                    <th>{% trans "STATUS & FEATURES" %}</th>
                    <th>{% trans "METRICS" %}</th>
                    <th>{% trans "DATES" %}</th>
                    <th>{% trans "ACTIONS" %}</th>
                </tr>
            </thead>
            <tbody>
                {% for ad in ads %}
                <tr>
                    <td>
                        <div class="ad-info">
                            {% if ad.images.first %}
                                <img src="{{ ad.images.first.image.url }}" alt="{{ ad.title }}" class="ad-thumbnail">
                            {% else %}
                                <div class="ad-thumbnail" style="background: var(--gray-200); display: flex; align-items: center; justify-content: center;">
                                    <i class="fas fa-image text-muted"></i>
                                </div>
                            {% endif %}
                            <div class="ad-details">
                                <h4>{{ ad.title|truncatewords:5 }}</h4>
                                <p><i class="fas fa-user"></i> {{ ad.user.username }}</p>
                                <p><i class="fas fa-folder"></i> {{ ad.category.name }}</p>
                            </div>
                        </div>
                    </td>

                    <td>
                        <p><strong>{% trans "Price:" %}</strong> {{ ad.price|format_currency }}</p>
                        {% if ad.reservation_amount > 0 %}
                        <p><strong>{% trans "Reservation:" %}</strong> {{ ad.reservation_amount|format_currency }}</p>
                        {% endif %}
                        <p><small class="text-muted">{{ ad.city }}</small></p>
                    </td>

                    <td>
                        {% if ad.status == 'active' %}
                            <span class="status-badge active">{% trans "Active" %}</span>
                        {% elif ad.status == 'pending' %}
                            <span class="status-badge pending">{% trans "Pending" %}</span>
                        {% elif ad.status == 'expired' %}
                            <span class="status-badge expired">{% trans "Expired" %}</span>
                        {% elif ad.is_hidden %}
                            <span class="status-badge hidden">{% trans "Hidden" %}</span>
                        {% endif %}

                        <div class="mt-2">
                            {% if ad.is_urgent %}<span class="badge bg-danger ms-1">{% trans "Urgent" %}</span>{% endif %}
                            {% if ad.is_highlighted %}<span class="badge bg-warning ms-1">{% trans "Featured" %}</span>{% endif %}
                            {% if ad.is_pinned %}<span class="badge bg-info ms-1">{% trans "Pinned" %}</span>{% endif %}
                            {% if ad.cart_enabled_by_admin %}<span class="badge bg-success ms-1">{% trans "Cart" %}</span>{% endif %}
                        </div>
                    </td>

                    <td>
                        <p><i class="fas fa-eye"></i> {{ ad.views_count }}</p>
                        <p><i class="fas fa-star"></i> {{ ad.user.average_rating|default:"N/A" }}</p>
                    </td>

                    <td>
                        <p><strong>{% trans "Created:" %}</strong><br>{{ ad.created_at|date:"d M Y" }}</p>
                        <p><strong>{% trans "Expires:" %}</strong><br>
                            {% if ad.expires_at %}
                                {{ ad.expires_at|date:"d M Y" }}
                            {% else %}
                                N/A
                            {% endif %}
                        </p>
                    </td>

                    <td>
                        <div class="action-buttons">
                            <a href="{% url 'main:ad_publisher_detail' ad.pk %}" class="btn-action btn-view" title="{% trans 'View Details' %}">
                                <i class="fas fa-eye"></i>
                            </a>

                            <button onclick="toggleHide({{ ad.pk }}, {{ ad.is_hidden|yesno:'false,true' }})"
                                    class="btn-action btn-hide"
                                    title="{% if ad.is_hidden %}{% trans 'Unhide' %}{% else %}{% trans 'Hide' %}{% endif %}">
                                <i class="fas fa-eye-slash"></i>
                            </button>

                            {% if ad.allow_cart and not ad.cart_enabled_by_admin %}
                            <button onclick="enableCart({{ ad.pk }})"
                                    class="btn-action btn-cart"
                                    title="{% trans 'Enable Cart' %}">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                            {% endif %}

                            <button onclick="deleteAd({{ ad.pk }})"
                                    class="btn-action btn-delete"
                                    title="{% trans 'Delete' %}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="6">
                        <div class="empty-state">
                            <i class="fas fa-inbox"></i>
                            <h3>{% trans "No advertisements found" %}</h3>
                            <p>{% trans "Try adjusting your filters" %}</p>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <!-- Pagination -->
        {% if ads.has_other_pages %}
        <div class="pagination">
            {% if ads.has_previous %}
                <a href="?page=1{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{% trans "First" %}</a>
                <a href="?page={{ ads.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{% trans "Previous" %}</a>
            {% endif %}

            <span class="current">{{ ads.number }} / {{ ads.paginator.num_pages }}</span>

            {% if ads.has_next %}
                <a href="?page={{ ads.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{% trans "Next" %}</a>
                <a href="?page={{ ads.paginator.num_pages }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.search %}&search={{ request.GET.search }}{% endif %}">{% trans "Last" %}</a>
            {% endif %}
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function filterByStatus(status) {
    const form = document.getElementById('filterForm');
    const statusSelect = form.querySelector('[name="status"]');
    statusSelect.value = status;
    form.submit();
}

function toggleHide(adId, hide) {
    if (confirm('{% trans "Are you sure you want to change the visibility of this ad?" %}')) {
        fetch(`/admin/ads/${adId}/toggle-hide/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ hide: hide })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('{% trans "Error updating advertisement" %}');
            }
        });
    }
}

function enableCart(adId) {
    if (confirm('{% trans "Enable cart for this advertisement? The product must be received first." %}')) {
        fetch(`/admin/ads/${adId}/enable-cart/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('{% trans "Cart enabled successfully" %}');
                location.reload();
            } else {
                alert('{% trans "Error enabling cart" %}');
            }
        });
    }
}

function deleteAd(adId) {
    if (confirm('{% trans "Are you sure you want to delete this advertisement? This action cannot be undone." %}')) {
        fetch(`/admin/ads/${adId}/delete/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('{% trans "Error deleting advertisement" %}');
            }
        });
    }
}
</script>
{% endblock %}
