{% extends "base.html" %}

{% load static i18n idrissimart_tags %}

{% block title %}
    {{ ad.title }} - {% trans "إعلانات مبوبة" %}

{% endblock title %}

{% block extra_css %}
    <style>
        /* Price Card Hover Effect */
        .ad-details-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ad-details-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(75, 49, 94, 0.25) !important;
        }

        /* Smooth transitions for badges */
        .badge {
            transition: all 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }
    </style>
{% endblock %}

{% block content %}
    <section class="ad-detail-section py-5" style="background: var(--bg-primary);">
        <div class="container">
            <div class="row g-lg-5">
                <!-- Left Column: Main Content -->
                <div class="col-lg-8">
                    <!-- Ad Title -->
                    <div class="modern-card ad-title-header mb-4 p-4 rounded-3 shadow-sm position-relative" style="background: var(--bg-primary); border-left: 4px solid var(--primary-color);">
                        <!-- Verified Badge in Top Right -->
                        {% if ad.user.is_verified %}
                            {% if ad.user.is_company %}
                                <div class="verified-badge-detail position-absolute" style="top: 15px; right: 15px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); z-index: 5;">
                                    <i class="fas fa-building me-1"></i>
                                    <span>{% trans "شركة موثقة" %}</span>
                                </div>
                            {% else %}
                                <div class="verified-badge-detail position-absolute" style="top: 15px; right: 15px; background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); z-index: 5;">
                                    <i class="fas fa-user-check me-1"></i>
                                    <span>{% trans "شخص موثوق" %}</span>
                                </div>
                            {% endif %}
                        {% endif %}

                        <h1 class="ad-title-main mb-3" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; padding-right: 150px;" title="{{ ad.title }}">{{ ad.title }}</h1>
                        <div class="ad-meta-info d-flex flex-wrap gap-3">
                            <span class="badge bg-light text-dark"><i class="fas fa-clock me-1"></i> {% trans "نشر في" %}: {{ ad.created_at|date:"d M, Y" }}</span>
                            <span class="badge bg-light text-dark"><i class="fas fa-eye me-1"></i> {{ ad.views_count }} {% trans "مشاهدة" %}</span>
                            {% render_ad_badges ad %}
                        </div>
                    </div>

                    {% if ad_inactive %}
                    <!-- Inactive Ad Warning -->
                    <div class="alert alert-warning border-0 shadow-sm mb-4" style="border-radius: 15px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-left: 4px solid #ffc107;">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x" style="color: #856404;"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading mb-1" style="color: #856404; font-weight: 600;">
                                    {% if ad_status == 'EXPIRED' %}
                                        {% trans "إعلان منتهي الصلاحية" %}
                                    {% elif ad_status == 'DRAFT' %}
                                        {% trans "إعلان في المسودة" %}
                                    {% elif ad_status == 'UNDER_REVIEW' %}
                                        {% trans "إعلان تحت المراجعة" %}
                                    {% elif ad_status == 'REJECTED' %}
                                        {% trans "إعلان مرفوض" %}
                                    {% elif ad_status == 'SOLD' %}
                                        {% trans "تم بيع هذا الإعلان" %}
                                    {% else %}
                                        {% trans "إعلان غير متاح" %}
                                    {% endif %}
                                </h5>
                                <p class="mb-0" style="color: #856404;">
                                    {% if ad_status == 'EXPIRED' %}
                                        {% trans "انتهت صلاحية هذا الإعلان. لا يمكن التفاعل معه حاليًا." %}
                                    {% elif ad_status == 'SOLD' %}
                                        {% trans "تم بيع هذا المنتج. شكرًا لاهتمامكم." %}
                                    {% else %}
                                        {% trans "هذا الإعلان غير متاح للتفاعل حاليًا. يمكنك مشاهدة التفاصيل فقط." %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Image Gallery -->
                    <div class="modern-card ad-gallery-container mb-4 rounded-3 overflow-hidden shadow-sm" style="background: var(--bg-primary);">
                        <div class="swiper ad-gallery-swiper" style="border-radius: 20px;">
                            <div class="swiper-wrapper">
                                {% for image in ad.images.all %}
                                    <div class="swiper-slide">
                                        <img src="{{ image.image.url }}"
                                             alt="{{ ad.title }} - {% trans 'صورة' %} {{ forloop.counter }}">
                                    </div>
                                {% empty %}
                                    <div class="swiper-slide">
                                        <img src="https://via.placeholder.com/800x600.png?text={% trans 'No Image' %}"
                                             alt="{% trans 'No Image' %}">
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-next"></div>
                            <div class="swiper-button-prev"></div>
                        </div>
                        {% if ad.images.count > 1 %}
                            <div class="swiper ad-thumbnails-swiper mt-2">
                                <div class="swiper-wrapper">
                                    {% for image in ad.images.all %}
                                        <div class="swiper-slide">
                                            <img src="{{ image.image.url }}"
                                                 alt="{{ ad.title }} - {% trans 'صورة مصغرة' %} {{ forloop.counter }}">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Ad Description Card -->
                    <div class="modern-card card ad-content-card mb-4 border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                        <div class="card-header bg-transparent border-bottom-0 pb-2">
                            <h4 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                <i class="fas fa-align-left me-2"></i>{% trans "وصف الإعلان" %}
                            </h4>
                        </div>
                        <div class="card-body pt-3">
                            {% autoescape off %}
                            <p class="ad-description mb-0" style="line-height: 1.8; color: var(--text-primary);">{{ ad.get_safe_description }}</p>
                            {% endautoescape %}
                        </div>
                    </div>

                    <!-- Custom Fields Card -->
                    {% if ad.custom_fields and ad.category.custom_field_schema %}
                        <div class="modern-card card ad-content-card mb-4 border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                            <div class="card-header bg-transparent border-bottom-0 pb-2">
                                <h4 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "المواصفات" %}
                                </h4>
                            </div>
                            <div class="card-body pt-3">
                                <div class="row g-3">
                                    {% for field_schema in ad.category.custom_field_schema %}
                                        {% if field_schema.name in ad.custom_fields %}
                                            <div class="col-md-6">
                                                <div class="custom-field-item p-3 rounded-3" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                                                    <label class="custom-field-label d-block mb-1" style="font-weight: 600; color: var(--text-muted); font-size: 0.85rem;">
                                                        {{ field_schema.label|default:field_schema.name|translate_field_label }}
                                                    </label>
                                                    <div class="custom-field-value" style="color: var(--text-primary); font-weight: 500;">
                                                        {% with value=ad.custom_fields|get_item:field_schema.name %}
                                                            {% if field_schema.type == 'checkbox' %}
                                                                {% if value == True or value == 'true' %}
                                                                    <i class="fas fa-check-circle text-success me-1"></i>{% trans "نعم" %}
                                                                {% else %}
                                                                    <i class="fas fa-times-circle text-danger me-1"></i>{% trans "لا" %}
                                                                {% endif %}
                                                            {% elif field_schema.type == 'date' %}
                                                                <i class="far fa-calendar me-1"></i>{{ value }}
                                                            {% elif field_schema.type == 'number' %}
                                                                <i class="fas fa-hashtag me-1"></i>{{ value }}
                                                            {% else %}
                                                                {{ value|translate_field_label }}
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    <!-- Reviews Card -->
                    <div class="modern-card card ad-content-card border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                        <div class="card-header bg-transparent border-bottom-0 pb-2">
                            <h4 class="card-title-main mb-0" style="color: var(--secondary-color); font-weight: 700;">
                                <i class="fas fa-star-half-alt me-2"></i>{% trans "التقييمات" %}
                            </h4>
                        </div>
                        <div class="card-body pt-3">
                            {# Placeholder for reviews - to be implemented when review model is ready #}
                            <div class="text-center py-4">
                                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                <p class="text-muted">{% trans "لا توجد تقييمات لهذا الإعلان بعد." %}</p>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Right Column: Sidebar -->
                <div class="col-lg-4">
                    <div class="ad-sidebar">
                        <!-- Price Card -->
                        <div class="modern-card card ad-details-card mb-4 border-0 rounded-4" style="background: var(--bg-primary); box-shadow: 0 4px 20px rgba(75, 49, 94, 0.15); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid var(--primary-color);">
                            <div class="card-body p-4">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div class="price-section">
                                        {% ad_price_formatted ad as formatted_price %}
                                        {% if formatted_price %}
                                            <span class="price-display" style="font-size: 2rem; font-weight: 900; color: var(--primary-color); text-shadow: 0 2px 4px rgba(75, 49, 94, 0.2);">
                                                {{ formatted_price }}
                                            </span>
                                        {% else %}
                                            <span class="price-display" style="font-size: 2rem; font-weight: 900; color: var(--primary-color); text-shadow: 0 2px 4px rgba(75, 49, 94, 0.2);">
                                                {% if ad.price %}
                                                    {{ ad.price }} {{ ad.currency|default:"ريال" }}
                                                {% else %}
                                                    {% trans "السعر غير محدد" %}
                                                {% endif %}
                                            </span>
                                        {% endif %}

                                        {% if ad.original_price and ad.original_price != ad.price %}
                                            <div class="price-comparison mt-2">
                                                <small class="text-decoration-line-through" style="color: var(--text-muted);">
                                                    {{ ad.original_price }} {{ ad.currency|default:"ريال" }}
                                                </small>
                                                <span class="badge bg-danger ms-2">
                                                    <i class="fas fa-percent me-1"></i>{% trans "خصم" %}
                                                </span>
                                            </div>
                                        {% endif %}
                                    </div>

                                    {% if ad.is_negotiable %}
                                        <span class="badge negotiable-badge" style="background: var(--secondary-color); color: white; padding: 8px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(255, 96, 1, 0.3);">
                                            <i class="fas fa-handshake me-1"></i>{% trans "قابل للتفاوض" %}
                                        </span>
                                    {% endif %}
                                </div>

                                <div class="ad-location d-flex align-items-center justify-content-between" style="color: var(--text-primary);">
                                    <div class="location-info">
                                        <i class="fas fa-map-marker-alt me-2" style="color: var(--secondary-color);"></i>
                                        <span>{{ ad.city }}, {{ ad.country.name }}</span>
                                    </div>

                                    <div class="ad-meta-badges">
                                        {% if ad.is_featured %}
                                            <span class="badge" style="background: rgba(255,215,0,0.15); color: #b8860b; border: 1px solid rgba(255,215,0,0.3); box-shadow: 0 2px 6px rgba(255,215,0,0.2);">
                                                <i class="fas fa-star me-1"></i>{% trans "مميز" %}
                                            </span>
                                        {% endif %}

                                        {% if ad.is_urgent %}
                                            <span class="badge" style="background: rgba(220,38,38,0.15); color: #dc2626; border: 1px solid rgba(220,38,38,0.3); box-shadow: 0 2px 6px rgba(220,38,38,0.2);">
                                                <i class="fas fa-bolt me-1"></i>{% trans "عاجل" %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Seller Card -->
                        <div class="modern-card card ad-details-card mb-4 border-0 shadow-sm rounded-4" style="background: var(--bg-primary); backdrop-filter: blur(10px);">
                            <div class="card-header bg-transparent border-bottom-0 text-center pb-2">
                                <h5 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                    <i class="fas fa-user-tie me-2"></i>{% trans "معلومات البائع" %}
                                </h5>
                            </div>
                            <div class="card-body text-center py-4">
                                {% user_avatar user=ad.user size=100 css_class="rounded-circle mb-3 shadow border border-3" %}
                                <h6 class="seller-name mb-2" style="font-weight: 600; color: var(--text-primary);">{{ ad.user.get_display_name }}</h6>
                                <small class="text-muted d-block mb-3">{{ ad.user.get_rank_display }}</small>
                                {% if ad.user.is_verified %}
                                    <div class="verification-badge mb-3">
                                        {% if ad.user.is_company %}
                                            <span class="badge verified-company-badge" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 8px 16px; border-radius: 15px; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                                <i class="fas fa-building me-1"></i>
                                                {% trans "شركة موثقة" %}
                                            </span>
                                        {% else %}
                                            <span class="badge verified-person-badge" style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 8px 16px; border-radius: 15px; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                                <i class="fas fa-user-check me-1"></i>
                                                {% trans "شخص موثوق" %}
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-transparent border-top-0 pt-0">
                                {% if ad_inactive %}
                                    <!-- Disabled Actions for Inactive Ads -->
                                    <div class="d-grid gap-2">
                                        <div class="alert alert-info border-0" style="border-radius: 10px; background: rgba(107, 76, 122, 0.1); color: var(--text-primary);">
                                            <i class="fas fa-info-circle me-2"></i>
                                            {% trans "الإجراءات غير متاحة لهذا الإعلان" %}
                                        </div>
                                        <button class="btn btn-lg shadow-sm" disabled
                                                style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                            <i class="fas fa-shopping-cart me-2"></i> {% trans "إضافة للسلة" %} - {% trans "غير متاح" %}
                                        </button>
                                        <button class="btn btn-outline-secondary btn-lg shadow-sm" disabled
                                                style="border-radius: 15px; font-weight: 600;">
                                            <i class="far fa-heart me-2"></i> {% trans "إضافة للمفضلة" %} - {% trans "غير متاح" %}
                                        </button>
                                    </div>
                                {% elif ad.cart_enabled_by_admin %}
                                    <div class="d-grid gap-2">
                                        {% if request.user.is_authenticated %}
                                            <button class="btn btn-lg shadow-sm add-to-cart-btn" {# Changed #}
                                                    data-type="cart" {# Added #}
                                                    data-action="{% if ad.is_in_cart %}remove-from-cart{% else %}add-to-cart{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: 15px; font-weight: 600; transition: all 0.3s ease;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="fas fa-shopping-cart me-2"></i> <span class="button-text">{% if ad.is_in_cart %}{% trans "إزالة من السلة" %}{% else %}{% trans "إضافة للسلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                            <button class="btn btn-outline-danger btn-lg shadow-sm wishlist-btn"
                                                    data-type="wishlist" {# Added #}
                                                    data-action="{% if ad.is_in_wishlist %}remove-from-wishlist{% else %}add-to-wishlist{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="border-radius: 15px; font-weight: 600;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="{% if ad.is_in_wishlist %}fas{% else %}far{% endif %} fa-heart me-2"></i> <span class="button-text">{% if ad.is_in_wishlist %}{% trans "إزالة من المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                        {% else %}
                                            <a href="{% url 'main:login' %}?next={{ request.path }}" class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                                <i class="fas fa-sign-in-alt me-2"></i> {% trans "سجل الدخول للشراء" %}
                                            </a>
                                        {% endif %}
                                        <small class="d-block text-center text-muted mt-2">{% trans "هذه الخدمة تتطلب دفع مبلغ حجز." %}</small>
                                    </div>
                                {% else %}
                                    <div class="d-grid gap-3">
                                        {% if ad_inactive %}
                                            <!-- Disabled Contact Actions for Inactive Ads -->
                                            <div class="alert alert-info border-0" style="border-radius: 10px; background: rgba(107, 76, 122, 0.1); color: var(--text-primary);">
                                                <i class="fas fa-info-circle me-2"></i>
                                                {% trans "التواصل غير متاح لهذا الإعلان" %}
                                            </div>
                                            <button class="btn btn-outline-secondary btn-lg shadow-sm" disabled
                                                    style="border-radius: 15px; font-weight: 600;">
                                                <i class="far fa-heart me-2"></i> {% trans "إضافة للمفضلة" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                    style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fas fa-comments me-2"></i> {% trans "محادثة البائع" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                   style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fas fa-phone-alt me-2"></i> {% trans "اتصال" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                   style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fab fa-whatsapp me-2"></i> {% trans "واتساب" %} - {% trans "غير متاح" %}
                                            </button>
                                        {% else %}
                                            <!-- Normal Active Ad Actions -->
                                        {% if request.user.is_authenticated %} {# Changed #}
                                            <button class="btn btn-outline-danger btn-lg shadow-sm mb-2 wishlist-btn" {# Changed #}
                                                    data-type="wishlist" {# Added #}
                                                    data-action="{% if ad.is_in_wishlist %}remove-from-wishlist{% else %}add-to-wishlist{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="border-radius: 15px; font-weight: 600;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="{% if ad.is_in_wishlist %}fas{% else %}far{% endif %} fa-heart me-2"></i> <span class="button-text">{% if ad.is_in_wishlist %}{% trans "إزالة من المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                            {% if request.user != ad.user %}
                                            <a href="{% url 'main:chat_room_new' %}?user_id={{ ad.user.id }}&ad_id={{ ad.id }}"
                                               class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                                <i class="fas fa-comments me-2"></i> {% trans "محادثة البائع" %}
                                            </a>
                                            {% endif %}
                                        {% endif %}
                                        <a href="tel:{{ ad.user.phone|default_if_none:'' }}"
                                           class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                            <i class="fas fa-phone-alt me-2"></i> {{ ad.user.phone|phone_format }}
                                        </a>
                                        <a href="https://wa.me/{{ ad.user.whatsapp|default_if_none:'' }}"
                                           target="_blank"
                                           class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #25d366, #128c7e); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                            <i class="fab fa-whatsapp me-2"></i> {% trans "مراسلة واتساب" %}
                                        </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Related Ads Section -->
            {% if related_ads %}
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="modern-card p-4 rounded-4 shadow-sm mb-4" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                            <h3 class="section-title-related mb-4" style="color: var(--primary-color); font-weight: 800; text-align: center;">
                                <i class="fas fa-layer-group me-2"></i>{% trans "إعلانات ذات صلة" %}
                            </h3>
                            <div class="swiper related-ads-swiper">
                                <div class="swiper-wrapper">
                                    {% for related_ad in related_ads %}
                                        <div class="swiper-slide"> {# Changed #}
                                            {% include "classifieds/_ad_card.html" with ad=related_ad %} {# Changed #}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="swiper-pagination related-ads-pagination"></div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>

{% endblock content %}

{% block extra_js %}
    <script>
        // Handle cart and wishlist actions
        window.handleCartWishlistAction = async function(button, event) {
            event.preventDefault();
            event.stopPropagation();

            const itemId = button.getAttribute('data-item-id');
            const itemName = button.getAttribute('data-item-name');
            const action = button.getAttribute('data-action');
            const type = button.getAttribute('data-type');

            if (!itemId) {
                console.error('No item ID found');
                return;
            }

            // Disable button during request
            button.disabled = true;

            try {
                let result;

                if (type === 'cart') {
                    if (action === 'add-to-cart') {
                        result = await window.CartWishlist.addToCart(itemId, itemName);
                        if (result && result.success) {
                            button.setAttribute('data-action', 'remove-from-cart');
                            const buttonText = button.querySelector('.button-text');
                            if (buttonText) {
                                buttonText.textContent = '{% trans "إزالة من السلة" %}';
                            }
                            // Ensure header counter is updated
                            if (result.cart_count !== undefined && window.CartWishlist.updateCartCountInHeader) {
                                window.CartWishlist.updateCartCountInHeader(result.cart_count);
                            }
                        }
                    } else if (action === 'remove-from-cart') {
                        result = await window.CartWishlist.removeFromCart(itemId, itemName);
                        if (result && result.success) {
                            button.setAttribute('data-action', 'add-to-cart');
                            const buttonText = button.querySelector('.button-text');
                            if (buttonText) {
                                buttonText.textContent = '{% trans "إضافة للسلة" %}';
                            }
                            // Ensure header counter is updated
                            if (result.cart_count !== undefined && window.CartWishlist.updateCartCountInHeader) {
                                window.CartWishlist.updateCartCountInHeader(result.cart_count);
                            }
                        }
                    }
                } else if (type === 'wishlist') {
                    if (action === 'add-to-wishlist') {
                        result = await window.CartWishlist.addToWishlist(itemId, itemName);
                        if (result && result.success) {
                            button.setAttribute('data-action', 'remove-from-wishlist');
                            const icon = button.querySelector('i');
                            if (icon) {
                                icon.classList.remove('far');
                                icon.classList.add('fas');
                            }
                            const buttonText = button.querySelector('.button-text');
                            if (buttonText) {
                                buttonText.textContent = '{% trans "إزالة من المفضلة" %}';
                            }
                            // Ensure header counter is updated
                            if (result.wishlist_count !== undefined && window.CartWishlist.updateWishlistCountInHeader) {
                                window.CartWishlist.updateWishlistCountInHeader(result.wishlist_count);
                            }
                        }
                    } else if (action === 'remove-from-wishlist') {
                        result = await window.CartWishlist.removeFromWishlist(itemId, itemName);
                        if (result && result.success) {
                            button.setAttribute('data-action', 'add-to-wishlist');
                            const icon = button.querySelector('i');
                            if (icon) {
                                icon.classList.remove('fas');
                                icon.classList.add('far');
                            }
                            const buttonText = button.querySelector('.button-text');
                            if (buttonText) {
                                buttonText.textContent = '{% trans "إضافة للمفضلة" %}';
                            }
                            // Ensure header counter is updated
                            if (result.wishlist_count !== undefined && window.CartWishlist.updateWishlistCountInHeader) {
                                window.CartWishlist.updateWishlistCountInHeader(result.wishlist_count);
                            }
                        }
                    }
                }
            } catch (error) {
                console.error('Error handling cart/wishlist action:', error);
                if (window.CartWishlist && window.CartWishlist.showNotification) {
                    window.CartWishlist.showNotification('{% trans "حدث خطأ، يرجى المحاولة مرة أخرى" %}', 'error');
                }
            } finally {
                button.disabled = false;
            }
        };
    </script>

    {% if ad.images.count > 1 %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                var thumbsSwiper = new Swiper(".ad-thumbnails-swiper", {
                    spaceBetween: 10,
                    slidesPerView: 4,
                    freeMode: true,
                    watchSlidesProgress: true,
                });

                new Swiper(".ad-gallery-swiper", {
                    spaceBetween: 10,
                    navigation: {
                        nextEl: ".swiper-button-next",
                        prevEl: ".swiper-button-prev",
                    },
                    thumbs: {
                        swiper: thumbsSwiper,
                    },
                });
            });
        </script>
    {% endif %}

    {% if related_ads %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const relatedAdsSwiper = document.querySelector('.related-ads-swiper');
                if (relatedAdsSwiper) {
                    const relatedSlides = relatedAdsSwiper.querySelectorAll('.swiper-slide');
                    const hasEnoughSlides = relatedSlides.length >= 3; // Need at least 3 for loop with slidesPerView

                    new Swiper('.related-ads-swiper', {
                        slidesPerView: 1,
                        spaceBetween: 20,
                        loop: hasEnoughSlides,
                        pagination: {
                            el: '.related-ads-pagination',
                            clickable: true,
                        },
                        breakpoints: {
                            768: { slidesPerView: 2 },
                            1200: { slidesPerView: 3 }
                        }
                    });
                }
            });
        </script>
    {% endif %}

    <!-- Floating Chat Button -->
    {% if user.is_authenticated and user != ad.user %}
    <div class="floating-chat-btn" style="position: fixed; bottom: 30px; left: 30px; z-index: 1000;">
        <a href="{% url 'main:chat_with_publisher' ad.id %}"
           class="btn btn-primary rounded-circle shadow-lg"
           style="width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; background: linear-gradient(135deg, #4b315e, #3a2449); border: none; transition: all 0.3s ease;"
           title="{% trans 'تواصل مع الناشر' %}"
           onmouseover="this.style.transform='scale(1.1)'; this.style.boxShadow='0 8px 25px rgba(75, 49, 94, 0.4)';"
           onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.3)';">
            <i class="fas fa-comment-dots" style="font-size: 1.5rem;"></i>
        </a>
        <div class="chat-tooltip" style="position: absolute; bottom: 70px; left: 0; background: var(--bg-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 8px; white-space: nowrap; opacity: 0; transition: opacity 0.3s; pointer-events: none; box-shadow: 0 2px 10px rgba(0,0,0,0.2);">
            {% trans "تواصل مع الناشر" %}
        </div>
    </div>
    <style>
        .floating-chat-btn:hover .chat-tooltip {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .floating-chat-btn {
                bottom: 20px;
                left: 20px;
            }
            .floating-chat-btn a {
                width: 50px;
                height: 50px;
            }
            .floating-chat-btn i {
                font-size: 1.2rem !important;
            }
        }
    </style>
    {% endif %}

{% endblock extra_js %}
