{% extends "base.html" %}

{% load static i18n idrissimart_tags %}

{% block title %}
    {{ ad.title }} - {% trans "إعلانات مبوبة" %}
{% endblock title %}

{% block extra_meta %}
{{ block.super }}
<!-- Open Graph meta tags for better social sharing -->
<meta property="og:type" content="product">
<meta property="og:title" content="{{ ad.title }}">
<meta property="og:description" content="{{ ad.description|striptags|truncatewords:30 }}">
<meta property="og:url" content="{{ request.build_absolute_uri }}">
{% if ad.images.first %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{{ ad.images.first.image.url }}">
<meta property="og:image:secure_url" content="{{ request.scheme }}://{{ request.get_host }}{{ ad.images.first.image.url }}">
<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="630">
<meta property="og:image:alt" content="{{ ad.title }}">
{% else %}
<meta property="og:image" content="{{ request.scheme }}://{{ request.get_host }}{% static 'images/placeholder-ad.jpg' %}">
{% endif %}

<!-- Product specific meta tags -->
{% if not ad.hide_price and not ad.price_on_request %}
<meta property="product:price:amount" content="{{ ad.price }}">
<meta property="product:price:currency" content="{{ ad.currency|default:'EGP' }}">
{% endif %}
<meta property="product:condition" content="{% if ad.custom_fields.condition == 'new' %}new{% else %}used{% endif %}">
<meta property="product:availability" content="{% if ad.status == 'active' %}in stock{% else %}out of stock{% endif %}">

<!-- Twitter Card meta tags -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="{{ ad.title }}">
<meta name="twitter:description" content="{{ ad.description|striptags|truncatewords:30 }}">
{% if ad.images.first %}
<meta name="twitter:image" content="{{ request.scheme }}://{{ request.get_host }}{{ ad.images.first.image.url }}">
{% endif %}

<!-- Additional SEO meta tags -->
<meta name="description" content="{{ ad.description|striptags|truncatewords:40 }}">
<meta name="keywords" content="{{ ad.title }}, {{ ad.category.name }}, {{ ad.city }}, {% trans "إعلانات مبوبة" %}">
<link rel="canonical" content="{{ request.build_absolute_uri }}">
{% endblock extra_meta %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/ad-card-enhancements.css' %}">
    <style>
        /* Price Card Hover Effect */
        .ad-details-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .ad-details-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 30px rgba(75, 49, 94, 0.25) !important;
        }

        /* Smooth transitions for badges */
        .badge {
            transition: all 0.2s ease;
        }

        .badge:hover {
            transform: scale(1.05);
        }

        /* Rating Stars for Detail Page */
        .rating-stars-detail {
            display: inline-flex;
            gap: 4px;
            font-size: 1.25rem;
        }

        .rating-stars-detail i {
            color: #fbbf24;
        }

        .rating-stars-detail .fa-star,
        .rating-stars-detail .fa-star-half-alt {
            color: #fbbf24;
        }

        .rating-stars-detail .far.fa-star {
            color: #d1d5db;
        }

        .rating-value-detail {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-left: 8px;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .rating-value-detail,
        .dark-theme .rating-value-detail {
            color: #ffffff;
            text-shadow: 0 2px 8px rgba(139, 92, 246, 0.3);
        }

        .rating-count-detail {
            font-size: 1rem;
            color: var(--text-muted);
            font-weight: 500;
            transition: color 0.3s ease;
        }

        [data-theme="dark"] .rating-count-detail,
        .dark-theme .rating-count-detail {
            color: #cbd5e0;
        }

        /* Category Badge for Detail Page */
        .category-badge-detail {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 4px 12px rgba(75, 49, 94, 0.25);
        }

        /* Lightbox Styles */
        .lightbox {
            display: none;
            position: fixed;
            z-index: 9999;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            animation: fadeIn 0.3s ease;
            touch-action: pan-y pinch-zoom;
        }

        .lightbox.active {
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .lightbox-content {
            position: relative;
            max-width: 90%;
            max-height: 90%;
            animation: zoomIn 0.3s ease;
            touch-action: none;
        }

        .lightbox-content img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            max-height: 90vh;
            transition: transform 0.3s ease;
            cursor: grab;
        }

        .lightbox-content img:active {
            cursor: grabbing;
        }

        .lightbox-close {
            position: absolute;
            top: 20px;
            right: 35px;
            color: #fff;
            font-size: 40px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.5);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .lightbox-close:hover {
            background: rgba(255, 96, 1, 0.8);
            transform: scale(1.1);
        }

        .lightbox-prev,
        .lightbox-next {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            color: #fff;
            font-size: 30px;
            font-weight: bold;
            cursor: pointer;
            padding: 15px 20px;
            background: rgba(0, 0, 0, 0.5);
            border-radius: 50%;
            transition: all 0.3s ease;
            user-select: none;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .lightbox-prev:hover,
        .lightbox-next:hover {
            background: rgba(255, 96, 1, 0.8);
            transform: translateY(-50%) scale(1.1);
        }

        .lightbox-prev {
            left: 20px;
        }

        .lightbox-next {
            right: 20px;
        }

        .lightbox-counter {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #fff;
            font-size: 18px;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            font-weight: 500;
        }

        /* Loading indicator for lightbox */
        .lightbox-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 20px;
            z-index: 10001;
        }

        /* Zoom indicators */
        .lightbox-zoom-indicator {
            position: absolute;
            top: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 14px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .lightbox-zoom-indicator.visible {
            opacity: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes zoomIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        /* Star Rating Input */
        .star-rating-input {
            display: inline-flex;
            flex-direction: row-reverse;
            gap: 5px;
        }

        .star-rating-input input[type="radio"] {
            display: none;
        }

        .star-rating-input .star-label i {
            transition: all 0.2s ease;
        }

        .star-rating-input .star-label:hover i {
            transform: scale(1.2);
        }

        /* Review Item */
        .review-item {
            transition: all 0.3s ease;
        }

        .review-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        /* Ad meta (date & views) */
        .ad-meta-info {
            gap: 0.75rem !important;
        }

        .ad-meta-pill {
            display: inline-flex;
            align-items: center;
            padding: 0.45rem 0.9rem;
            border-radius: 999px;
            font-size: 0.85rem;
            font-weight: 600;
            background: rgba(var(--bg-rgb, 255, 255, 255), 0.9);
            color: var(--text-color, #111827);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(var(--border-rgb, 148, 163, 184), 0.35);
            backdrop-filter: blur(6px);
            transition: all 0.2s ease;
        }

        /* Dark theme adaptation */
        @media (prefers-color-scheme: dark) {
            .ad-meta-pill {
                background: rgba(var(--bg-rgb, 30, 41, 59), 0.9);
                color: var(--text-color, #f1f5f9);
                border-color: rgba(var(--border-rgb, 71, 85, 105), 0.5);
                box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
            }
        }

        /* CSS variable based dark theme */
        [data-theme="dark"] .ad-meta-pill,
        .dark-theme .ad-meta-pill {
            background: rgba(30, 41, 59, 0.9);
            color: #f1f5f9;
            border-color: rgba(71, 85, 105, 0.5);
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.3);
        }

        .ad-meta-pill i {
            font-size: 0.9rem;
        }

        .ad-meta-pill-label {
            opacity: 0.85;
            margin-inline-end: 0.25rem;
            font-weight: 500;
            transition: opacity 0.3s ease;
        }

        [data-theme="dark"] .ad-meta-pill-label,
        .dark-theme .ad-meta-pill-label {
            opacity: 0.9;
        }

        .ad-meta-pill-value {
            font-weight: 700;
            color: var(--primary-color, #4b315e);
            transition: color 0.3s ease;
        }

        /* Dark theme primary color adaptation */
        @media (prefers-color-scheme: dark) {
            .ad-meta-pill-value {
                color: #ffffff;
                text-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
            }
        }

        [data-theme="dark"] .ad-meta-pill-value,
        .dark-theme .ad-meta-pill-value {
            color: #ffffff;
            text-shadow: 0 1px 3px rgba(139, 92, 246, 0.3);
        }

        .ad-meta-pill.views {
            background: linear-gradient(135deg, rgba(59,130,246,0.1), rgba(96,165,250,0.18));
            border-color: rgba(59,130,246,0.3);
        }

        /* Dark theme views pill */
        @media (prefers-color-scheme: dark) {
            .ad-meta-pill.views {
                background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(96,165,250,0.3));
                border-color: rgba(59,130,246,0.5);
            }
        }

        [data-theme="dark"] .ad-meta-pill.views,
        .dark-theme .ad-meta-pill.views {
            background: linear-gradient(135deg, rgba(59,130,246,0.2), rgba(96,165,250,0.3));
            border-color: rgba(59,130,246,0.5);
        }

        .ad-meta-pill.date {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(45,212,191,0.16));
            border-color: rgba(34,197,94,0.28);
        }

        /* Dark theme date pill */
        @media (prefers-color-scheme: dark) {
            .ad-meta-pill.date {
                background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(45,212,191,0.25));
                border-color: rgba(34,197,94,0.4);
            }
        }

        [data-theme="dark"] .ad-meta-pill.date,
        .dark-theme .ad-meta-pill.date {
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(45,212,191,0.25));
            border-color: rgba(34,197,94,0.4);
        }

        .ad-meta-pill:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.12);
        }

        /* Dark theme hover effect */
        @media (prefers-color-scheme: dark) {
            .ad-meta-pill:hover {
                box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
            }
        }

        [data-theme="dark"] .ad-meta-pill:hover,
        .dark-theme .ad-meta-pill:hover {
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
        }
    </style>
{% endblock extra_css %}

{% block content %}
    <section class="ad-detail-section py-5" style="background: var(--bg-primary);">
        <div class="container">
            <div class="row g-lg-5">
                <!-- Left Column: Main Content -->
                <div class="col-lg-8">
                    <!-- Ad Title -->
                    <div class="modern-card ad-title-header mb-4 p-4 rounded-3 shadow-sm position-relative" style="background: var(--bg-primary); border-left: 4px solid var(--primary-color);">
                        <!-- Verified Badge in Top Right -->
                        {% if ad.user.is_verified %}
                            {% if ad.user.is_company %}
                                <div class="verified-badge-detail position-absolute" style="top: 15px; right: 15px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3); z-index: 5;">
                                    <i class="fas fa-building me-1"></i>
                                    <span>{% trans "شركة موثقة" %}</span>
                                </div>
                            {% else %}
                                <div class="verified-badge-detail position-absolute" style="top: 15px; right: 15px; background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 6px 12px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); z-index: 5;">
                                    <i class="fas fa-user-check me-1"></i>
                                    <span>{% trans "شخص موثوق" %}</span>
                                </div>
                            {% endif %}
                        {% endif %}

                        <h1 class="ad-title-main mb-3" style="background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; padding-right: 150px;" title="{{ ad.title }}">{{ ad.title }}</h1>

                        <!-- Main Category Badge -->
                        {% if ad.category %}
                        {% with main_category=ad.category.get_root %}
                        <div class="mb-3">
                            <span class="category-badge-detail">
                                <i class="fas fa-tag"></i>
                                <span>
                                    {% if LANGUAGE_CODE == 'ar' and main_category.name_ar %}
                                        {{ main_category.name_ar }}
                                    {% else %}
                                        {{ main_category.name }}
                                    {% endif %}
                                </span>
                            </span>
                        </div>
                        {% endwith %}
                        {% endif %}

                        <!-- Rating Display -->
                        {% if ad.rating %}
                        <div class="mb-3">
                            <div class="rating-stars-detail">
                                {% with rating_int=ad.rating|floatformat:0|add:"0" %}
                                {% for i in "12345" %}
                                    {% if forloop.counter <= rating_int %}
                                        <i class="fas fa-star"></i>
                                    {% elif forloop.counter == rating_int|add:"1" and ad.rating|floatformat:1|slice:"-3:" != ".0" %}
                                        <i class="fas fa-star-half-alt"></i>
                                    {% else %}
                                        <i class="far fa-star"></i>
                                    {% endif %}
                                {% endfor %}
                                {% endwith %}
                                <span class="rating-value-detail">{{ ad.rating|floatformat:1 }}</span>
                                {% if ad.rating_count %}
                                <span class="rating-count-detail">({{ ad.rating_count }} {% trans "تقييم" %})</span>
                                {% endif %}
                            </div>
                        </div>
                        {% endif %}

                        <div class="ad-meta-info d-flex flex-wrap">
                            <span class="ad-meta-pill date">
                                <i class="fas fa-clock ms-1"></i>
                                <span class="ad-meta-pill-label">{% trans "نشر في" %}</span>
                                <span class="ad-meta-pill-value">{{ ad.created_at|date:"d M, Y" }}</span>
                            </span>
                            <span class="ad-meta-pill views">
                                <i class="fas fa-eye ms-1"></i>
                                <span class="ad-meta-pill-label">{% trans "المشاهدات" %}</span>
                                <span class="ad-meta-pill-value">{{ ad.views_count }}</span>
                            </span>
                            {% render_ad_badges ad %}
                        </div>
                    </div>

                    {% if ad_inactive %}
                    <!-- Inactive Ad Warning -->
                    <div class="alert alert-warning border-0 shadow-sm mb-4" style="border-radius: 15px; background: linear-gradient(135deg, #fff3cd, #ffeaa7); border-left: 4px solid #ffc107;">
                        <div class="d-flex align-items-center">
                            <div class="me-3">
                                <i class="fas fa-exclamation-triangle fa-2x" style="color: #856404;"></i>
                            </div>
                            <div>
                                <h5 class="alert-heading mb-1" style="color: #856404; font-weight: 600;">
                                    {% if ad_status == 'EXPIRED' %}
                                        {% trans "إعلان منتهي الصلاحية" %}
                                    {% elif ad_status == 'DRAFT' %}
                                        {% trans "إعلان في المسودة" %}
                                    {% elif ad_status == 'UNDER_REVIEW' %}
                                        {% trans "إعلان تحت المراجعة" %}
                                    {% elif ad_status == 'REJECTED' %}
                                        {% trans "إعلان مرفوض" %}
                                    {% elif ad_status == 'SOLD' %}
                                        {% trans "تم بيع هذا الإعلان" %}
                                    {% else %}
                                        {% trans "إعلان غير متاح" %}
                                    {% endif %}
                                </h5>
                                <p class="mb-0" style="color: #856404;">
                                    {% if ad_status == 'EXPIRED' %}
                                        {% trans "انتهت صلاحية هذا الإعلان. لا يمكن التفاعل معه حاليًا." %}
                                    {% elif ad_status == 'SOLD' %}
                                        {% trans "تم بيع هذا المنتج. شكرًا لاهتمامكم." %}
                                    {% else %}
                                        {% trans "هذا الإعلان غير متاح للتفاعل حاليًا. يمكنك مشاهدة التفاصيل فقط." %}
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    <!-- Image Gallery -->
                    <div class="modern-card ad-gallery-container mb-4 rounded-3 overflow-hidden shadow-sm" style="background: var(--bg-primary);">
                        <div class="swiper ad-gallery-swiper" style="border-radius: 20px;">
                            <div class="swiper-wrapper">
                                {% for image in ad.images.all %}
                                    <div class="swiper-slide">
                                        <img src="{{ image.image.url }}"
                                             alt="{{ ad.title }} - {% trans "صورة" %} {{ forloop.counter }}"
                                             onclick="openLightbox({{ forloop.counter0 }})"
                                             style="cursor: pointer;">
                                    </div>
                                {% empty %}
                                    <div class="swiper-slide">
                                        <img src="https://via.placeholder.com/800x600.png?text={% trans "No Image" %}"
                                             alt="{% trans "No Image" %}">
                                    </div>
                                {% endfor %}
                            </div>
                            <div class="swiper-button-next"></div>
                            <div class="swiper-button-prev"></div>
                        </div>
                        {% if ad.images.count > 1 %}
                            <div class="swiper ad-thumbnails-swiper mt-2">
                                <div class="swiper-wrapper">
                                    {% for image in ad.images.all %}
                                        <div class="swiper-slide">
                                            <img src="{{ image.image.url }}"
                                                 alt="{{ ad.title }} - {% trans "صورة مصغرة" %} {{ forloop.counter }}">
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    <!-- Buyer Safety Note -->
                    <div class="mb-4">
                        <div class="buyer-safety-note" role="alert" style="display: inline-flex; align-items: center; gap: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 10px 20px; border-radius: 10px; font-size: 0.875rem; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-shield-alt"></i>
                            <span>{% trans "تحقق من المنتج قبل الدفع - لا تدفع مقدمًا" %}</span>
                        </div>
                    </div>

                    <!-- Ad Description Card -->
                    <div class="modern-card card ad-content-card mb-4 border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                        <div class="card-header bg-transparent border-bottom-0 pb-2">
                            <h4 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                <i class="fas fa-align-left me-2"></i>{% trans "وصف الإعلان" %}
                            </h4>
                        </div>
                        <div class="card-body pt-3">
                            {% autoescape off %}
                            <p class="ad-description mb-0" style="line-height: 1.8; color: var(--text-primary);">{{ ad.get_safe_description }}</p>
                            {% endautoescape %}
                        </div>
                    </div>

                    <!-- Social Share Card -->
                    <div class="modern-card card ad-content-card mb-4 border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                        <div class="card-header bg-transparent border-bottom-0 pb-2">
                            <h4 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                <i class="fas fa-share-alt me-2"></i>{% trans "مشاركة الإعلان" %}
                            </h4>
                        </div>
                        <div class="card-body pt-3">
                            <div class="d-flex flex-wrap gap-2">
                                <!-- Facebook Share -->
                                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}"
                                   target="_blank"
                                   class="btn btn-sm shadow-sm"
                                   style="background: #1877f2; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fab fa-facebook-f me-2"></i>{% trans "فيسبوك" %}
                                </a>

                                <!-- Twitter Share -->
                                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ ad.title|urlencode }}"
                                   target="_blank"
                                   class="btn btn-sm shadow-sm"
                                   style="background: #1da1f2; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fab fa-twitter me-2"></i>{% trans "تويتر" %}
                                </a>

                                <!-- WhatsApp Share -->
                                <a href="https://wa.me/?text={{ ad.title|urlencode }}%20{{ request.build_absolute_uri }}"
                                   target="_blank"
                                   class="btn btn-sm shadow-sm"
                                   style="background: #25d366; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fab fa-whatsapp me-2"></i>{% trans "واتساب" %}
                                </a>

                                <!-- Telegram Share -->
                                <a href="https://t.me/share/url?url={{ request.build_absolute_uri }}&text={{ ad.title|urlencode }}"
                                   target="_blank"
                                   class="btn btn-sm shadow-sm"
                                   style="background: #0088cc; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fab fa-telegram-plane me-2"></i>{% trans "تيليجرام" %}
                                </a>

                                <!-- LinkedIn Share -->
                                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}"
                                   target="_blank"
                                   class="btn btn-sm shadow-sm"
                                   style="background: #0077b5; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fab fa-linkedin-in me-2"></i>{% trans "لينكدإن" %}
                                </a>

                                <!-- Copy Link -->
                                <button onclick="copyAdLink()"
                                        class="btn btn-sm shadow-sm"
                                        style="background: #6c757d; color: white; border-radius: 10px; padding: 8px 16px;">
                                    <i class="fas fa-link me-2"></i>{% trans "نسخ الرابط" %}
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Custom Fields Card -->
                    {% if ad.custom_fields and ad.category.custom_field_schema %}
                        <div class="modern-card card ad-content-card mb-4 border-0 shadow-sm rounded-3" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                            <div class="card-header bg-transparent border-bottom-0 pb-2">
                                <h4 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                    <i class="fas fa-info-circle me-2"></i>{% trans "المواصفات" %}
                                </h4>
                            </div>
                            <div class="card-body pt-3">
                                <div class="row g-3">
                                    {% for field_schema in ad.category.custom_field_schema %}
                                        {% if field_schema.name in ad.custom_fields %}
                                            <div class="col-md-6">
                                                <div class="custom-field-item p-3 rounded-3" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                                                    <label class="custom-field-label d-block mb-1" style="font-weight: 600; color: var(--text-muted); font-size: 0.85rem;">
                                                        {{ field_schema.label|default:field_schema.name|translate_field_label }}
                                                    </label>
                                                    <div class="custom-field-value" style="color: var(--text-primary); font-weight: 500;">
                                                        {% with value=ad.custom_fields|get_item:field_schema.name %}
                                                            {% if field_schema.type == 'checkbox' %}
                                                                {% if value == True or value == 'true' %}
                                                                    <i class="fas fa-check-circle text-success me-1"></i>{% trans "نعم" %}
                                                                {% else %}
                                                                    <i class="fas fa-times-circle text-danger me-1"></i>{% trans "لا" %}
                                                                {% endif %}
                                                            {% elif field_schema.type == 'date' %}
                                                                <i class="far fa-calendar me-1"></i>{{ value }}
                                                            {% elif field_schema.type == 'number' %}
                                                                <i class="fas fa-hashtag me-1"></i>{{ value }}
                                                            {% else %}
                                                                {{ value|translate_field_label }}
                                                            {% endif %}
                                                        {% endwith %}
                                                    </div>
                                                </div>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    <!-- Reviews Card -->
                    <div class="modern-card card ad-content-card border-0 shadow-sm rounded-3" id="reviews-section" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                        <div class="card-header bg-transparent border-bottom-0 pb-2">
                            <h4 class="card-title-main mb-0" style="color: var(--secondary-color); font-weight: 700;">
                                <i class="fas fa-star-half-alt me-2"></i>{% trans "التقييمات" %}
                                {% if ad.rating_count %}
                                    <span class="badge bg-primary ms-2">{{ ad.rating_count }}</span>
                                {% endif %}
                            </h4>
                        </div>
                        <div class="card-body pt-3">
                            {% if request.user.is_authenticated and request.user != ad.user %}
                                {% if user_has_pending_review %}
                                    <!-- Pending Review Alert -->
                                    <div class="alert alert-warning d-flex align-items-center mb-4" role="alert">
                                        <i class="fas fa-clock fa-2x me-3"></i>
                                        <div>
                                            <h6 class="alert-heading mb-1">{% trans "تقييمك بانتظار الموافقة" %}</h6>
                                            <p class="mb-0">{% trans "شكراً لك! تم استلام تقييمك وسيظهر بعد موافقة المشرف." %}</p>
                                        </div>
                                    </div>
                                {% elif not user_has_reviewed %}
                                    <!-- Add Review Form -->
                                    <div class="add-review-section mb-4 p-4 rounded-3" style="background: var(--bg-primary); border: 2px dashed var(--border-color);">
                                        <h5 class="mb-3">{% trans "أضف تقييمك" %}</h5>
                                        <form method="post" action="{% url 'main:submit_ad_review' ad.id %}" id="reviewForm">
                                            {% csrf_token %}
                                            <div class="mb-3">
                                                <label class="form-label">{% trans "التقييم" %}</label>
                                                <div class="star-rating-input d-flex gap-2">
                                                    {% for i in "12345" %}
                                                        <input type="radio" name="rating" value="{{ forloop.counter }}" id="star{{ forloop.counter }}" required>
                                                        <label for="star{{ forloop.counter }}" class="star-label">
                                                            <i class="far fa-star" style="font-size: 2rem; color: #fbbf24; cursor: pointer;"></i>
                                                        </label>
                                                    {% endfor %}
                                                </div>
                                            </div>
                                            <div class="mb-3">
                                                <label for="comment" class="form-label">{% trans "التعليق (اختياري)" %}</label>
                                                <textarea name="comment" id="comment" class="form-control" rows="3" placeholder="{% trans "شاركنا رأيك في هذا الإعلان" %}"></textarea>
                                            </div>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-paper-plane me-2"></i>{% trans "إرسال التقييم" %}
                                            </button>
                                        </form>
                                    </div>
                                {% endif %}
                            {% elif not request.user.is_authenticated %}
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    {% trans "يرجى" %} <a href="{% url 'main:login' %}?next={{ request.path }}">{% trans "تسجيل الدخول" %}</a> {% trans "لإضافة تقييم" %}
                                </div>
                            {% endif %}

                            <!-- Reviews List -->
                            {% if reviews %}
                                <div class="reviews-list">
                                    {% for review in reviews %}
                                        <div class="review-item p-3 mb-3 rounded-3" style="background: var(--bg-primary); border: 1px solid var(--border-color);">
                                            <div class="d-flex justify-content-between align-items-start mb-2">
                                                <div class="d-flex align-items-center gap-3">
                                                    {% load idrissimart_tags %}
                                                    {% user_avatar user=review.user size=40 css_class="rounded-circle" %}
                                                    <div>
                                                        <strong>{{ review.user.get_display_name }}</strong>
                                                        <div class="review-stars">
                                                            {% for i in "12345" %}
                                                                {% if forloop.counter <= review.rating %}
                                                                    <i class="fas fa-star" style="color: #fbbf24;"></i>
                                                                {% else %}
                                                                    <i class="far fa-star" style="color: #d1d5db;"></i>
                                                                {% endif %}
                                                            {% endfor %}
                                                        </div>
                                                    </div>
                                                </div>
                                                <small class="text-muted">{{ review.created_at|timesince }}</small>
                                            </div>
                                            {% if review.comment %}
                                                <p class="mb-0 text-muted">{{ review.comment }}</p>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-center py-4">
                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">{% trans "لا توجد تقييمات لهذا الإعلان بعد. كن أول من يقيّم!" %}</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <!-- Right Column: Sidebar -->
                <div class="col-lg-4">
                    <div class="ad-sidebar">
                        <!-- Price Card -->
                        <div class="modern-card card ad-details-card mb-4 border-0 rounded-4" style="background: var(--bg-primary); box-shadow: 0 4px 20px rgba(75, 49, 94, 0.15); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border: 2px solid var(--primary-color);">
                            <div class="card-body p-4">
                                {% if ad.hide_price or ad.price_on_request %}
                                    <!-- Get Quote / Price on Request -->
                                    <div class="ad-quote-box mb-3" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(240, 147, 251, 0.3);">
                                        <div class="d-flex align-items-center gap-3">
                                            <div class="quote-icon" style="font-size: 2.5rem; color: white;">
                                                <i class="fas fa-file-invoice-dollar"></i>
                                            </div>
                                            <div class="quote-content flex-grow-1">
                                                <h4 class="quote-text mb-2" style="color: white; font-weight: 700; margin: 0;">
                                                    {% if ad.price_on_request %}
                                                        {% trans "السعر عند الطلب" %}
                                                    {% else %}
                                                        {% trans "اطلب عرض سعر" %}
                                                    {% endif %}
                                                </h4>
                                                <p class="mb-0" style="color: rgba(255, 255, 255, 0.9); font-size: 0.875rem;">
                                                    {% trans "تواصل مع البائع للحصول على أفضل سعر" %}
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                {% else %}
                                    <!-- Regular Price Display -->
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <div class="price-section">
                                            {% ad_price_formatted ad as formatted_price %}
                                            {% if formatted_price %}
                                                <span class="price-display" style="font-size: 2rem; font-weight: 900; color: var(--primary-color); text-shadow: 0 2px 4px rgba(75, 49, 94, 0.2);">
                                                    {{ formatted_price }}
                                                </span>
                                            {% else %}
                                                <span class="price-display" style="font-size: 2rem; font-weight: 900; color: var(--primary-color); text-shadow: 0 2px 4px rgba(75, 49, 94, 0.2);">
                                                    {% if ad.price %}
                                                        {{ ad.price }} {{ ad.currency|default:"ريال" }}
                                                    {% else %}
                                                        {% trans "السعر غير محدد" %}
                                                    {% endif %}
                                                </span>
                                            {% endif %}

                                            {% if ad.original_price and ad.original_price != ad.price %}
                                                <div class="price-comparison mt-2">
                                                    <small class="text-decoration-line-through" style="color: var(--text-muted);">
                                                        {{ ad.original_price }} {{ ad.currency|default:"ريال" }}
                                                    </small>
                                                    <span class="badge bg-danger ms-2">
                                                        <i class="fas fa-percent me-1"></i>{% trans "خصم" %}
                                                    </span>
                                                </div>
                                            {% endif %}
                                        </div>

                                        {% if ad.is_negotiable %}
                                            <span class="badge negotiable-badge" style="background: var(--secondary-color); color: white; padding: 8px 12px; border-radius: 20px; box-shadow: 0 2px 8px rgba(255, 96, 1, 0.3);">
                                                <i class="fas fa-handshake me-1"></i>{% trans "قابل للتفاوض" %}
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}

                                <div class="ad-location d-flex align-items-center justify-content-between" style="color: var(--text-primary);">
                                    <div class="location-info">
                                        <i class="fas fa-map-marker-alt me-2" style="color: var(--secondary-color);"></i>
                                        <span>{{ ad.city }}, {{ ad.country.name }}</span>
                                    </div>

                                    <div class="ad-meta-badges">
                                        {% if ad.is_featured %}
                                            <span class="badge" style="background: rgba(255,215,0,0.15); color: #b8860b; border: 1px solid rgba(255,215,0,0.3); box-shadow: 0 2px 6px rgba(255,215,0,0.2);">
                                                <i class="fas fa-star me-1"></i>{% trans "مميز" %}
                                            </span>
                                        {% endif %}

                                        {% if ad.is_urgent %}
                                            <span class="badge" style="background: rgba(220,38,38,0.15); color: #dc2626; border: 1px solid rgba(220,38,38,0.3); box-shadow: 0 2px 6px rgba(220,38,38,0.2);">
                                                <i class="fas fa-bolt me-1"></i>{% trans "عاجل" %}
                                            </span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        <!-- Seller Card -->
                        <div class="modern-card card ad-details-card mb-4 border-0 shadow-sm rounded-4" style="background: var(--bg-primary); backdrop-filter: blur(10px);">
                            <div class="card-header bg-transparent border-bottom-0 text-center pb-2">
                                <h5 class="card-title-main mb-0" style="color: var(--primary-color); font-weight: 700;">
                                    <i class="fas fa-user-tie me-2"></i>{% trans "معلومات البائع" %}
                                </h5>
                            </div>
                            <div class="card-body text-center py-4">
                                {% user_avatar user=ad.user size=100 css_class="rounded-circle mb-3 shadow border border-3" %}
                                <h6 class="seller-name mb-2" style="font-weight: 600; color: var(--text-primary);">{{ ad.user.get_display_name }}</h6>
                                <small class="text-muted d-block mb-3">{{ ad.user.get_rank_display }}</small>
                                {% if ad.user.is_verified %}
                                    <div class="verification-badge mb-3">
                                        {% if ad.user.is_company %}
                                            <span class="badge verified-company-badge" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; padding: 8px 16px; border-radius: 15px; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                                <i class="fas fa-building me-1"></i>
                                                {% trans "شركة موثقة" %}
                                            </span>
                                        {% else %}
                                            <span class="badge verified-person-badge" style="background: linear-gradient(135deg, #3b82f6, #1e40af); color: white; padding: 8px 16px; border-radius: 15px; font-weight: 600; box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);">
                                                <i class="fas fa-user-check me-1"></i>
                                                {% trans "شخص موثوق" %}
                                            </span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="card-footer bg-transparent border-top-0 pt-0">
                                {% if ad_inactive %}
                                    <!-- Disabled Actions for Inactive Ads -->
                                    <div class="d-grid gap-2">
                                        <div class="alert alert-info border-0" style="border-radius: 10px; background: rgba(107, 76, 122, 0.1); color: var(--text-primary);">
                                            <i class="fas fa-info-circle me-2"></i>
                                            {% trans "الإجراءات غير متاحة لهذا الإعلان" %}
                                        </div>
                                        <button class="btn btn-lg shadow-sm" disabled
                                                style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                            <i class="fas fa-shopping-cart me-2"></i> {% trans "إضافة للسلة" %} - {% trans "غير متاح" %}
                                        </button>
                                        <button class="btn btn-outline-secondary btn-lg shadow-sm" disabled
                                                style="border-radius: 15px; font-weight: 600;">
                                            <i class="far fa-heart me-2"></i> {% trans "إضافة للمفضلة" %} - {% trans "غير متاح" %}
                                        </button>
                                    </div>
                                {% elif ad.cart_enabled_by_admin %}
                                    <div class="d-grid gap-2">
                                        {% if request.user.is_authenticated %}
                                            <button class="btn btn-lg shadow-sm add-to-cart-btn" {# Changed #}
                                                    data-type="cart" {# Added #}
                                                    data-action="{% if ad.is_in_cart %}remove-from-cart{% else %}add-to-cart{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: 15px; font-weight: 600; transition: all 0.3s ease;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="fas fa-shopping-cart me-2"></i> <span class="button-text">{% if ad.is_in_cart %}{% trans "إزالة من السلة" %}{% else %}{% trans "إضافة للسلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                            <button class="btn btn-outline-danger btn-lg shadow-sm wishlist-btn"
                                                    data-type="wishlist" {# Added #}
                                                    data-action="{% if ad.is_in_wishlist %}remove-from-wishlist{% else %}add-to-wishlist{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="border-radius: 15px; font-weight: 600;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="{% if ad.is_in_wishlist %}fas{% else %}far{% endif %} fa-heart me-2"></i> <span class="button-text">{% if ad.is_in_wishlist %}{% trans "إزالة من المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                        {% else %}
                                            <a href="{% url 'main:login' %}?next={{ request.path }}" class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, var(--primary-color), var(--primary-dark)); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                                <i class="fas fa-sign-in-alt me-2"></i> {% trans "سجل الدخول للشراء" %}
                                            </a>
                                        {% endif %}
                                        <small class="d-block text-center text-muted mt-2">{% trans "هذه الخدمة تتطلب دفع مبلغ حجز." %}</small>
                                    </div>
                                {% else %}
                                    <div class="d-grid gap-3">
                                        {% if ad_inactive %}
                                            <!-- Disabled Contact Actions for Inactive Ads -->
                                            <div class="alert alert-info border-0" style="border-radius: 10px; background: rgba(107, 76, 122, 0.1); color: var(--text-primary);">
                                                <i class="fas fa-info-circle me-2"></i>
                                                {% trans "التواصل غير متاح لهذا الإعلان" %}
                                            </div>
                                            <button class="btn btn-outline-secondary btn-lg shadow-sm" disabled
                                                    style="border-radius: 15px; font-weight: 600;">
                                                <i class="far fa-heart me-2"></i> {% trans "إضافة للمفضلة" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                    style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fas fa-comments me-2"></i> {% trans "محادثة البائع" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                   style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fas fa-phone-alt me-2"></i> {% trans "اتصال" %} - {% trans "غير متاح" %}
                                            </button>
                                            <button class="btn btn-lg shadow-sm" disabled
                                                   style="background: #e9ecef; color: #6c757d; border-radius: 15px; font-weight: 600;">
                                                <i class="fab fa-whatsapp me-2"></i> {% trans "واتساب" %} - {% trans "غير متاح" %}
                                            </button>
                                        {% else %}
                                            <!-- Normal Active Ad Actions -->
                                        {% if request.user.is_authenticated %} {# Changed #}
                                            <button class="btn btn-outline-danger btn-lg shadow-sm mb-2 wishlist-btn" {# Changed #}
                                                    data-type="wishlist" {# Added #}
                                                    data-action="{% if ad.is_in_wishlist %}remove-from-wishlist{% else %}add-to-wishlist{% endif %}" {# Changed #}
                                                    data-item-id="{{ ad.id }}"
                                                    data-item-name="{{ ad.title }}"
                                                    style="border-radius: 15px; font-weight: 600;" {# Changed #}
                                                    onclick="handleCartWishlistAction(this, event)"> {# Added #}
                                                <i class="{% if ad.is_in_wishlist %}fas{% else %}far{% endif %} fa-heart me-2"></i> <span class="button-text">{% if ad.is_in_wishlist %}{% trans "إزالة من المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}</span> {# Changed #}
                                            </button>
                                            {% if request.user != ad.user %}
                                            <a href="{% url 'main:chat_room_new' %}?user_id={{ ad.user.id }}&ad_id={{ ad.id }}"
                                               class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #667eea, #764ba2); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                                <i class="fas fa-comments me-2"></i> {% trans "محادثة البائع" %}
                                            </a>
                                            {% endif %}
                                        {% endif %}
                                        <a href="tel:{{ ad.user.phone|default_if_none:'' }}"
                                           class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                            <i class="fas fa-phone-alt me-2"></i> {{ ad.user.phone|phone_format }}
                                        </a>
                                        <a href="https://wa.me/{{ ad.user.whatsapp|default_if_none:'' }}"
                                           target="_blank"
                                           class="btn btn-lg shadow-sm" style="background: linear-gradient(135deg, #25d366, #128c7e); color: white; border-radius: 15px; font-weight: 600; text-decoration: none;">
                                            <i class="fab fa-whatsapp me-2"></i> {% trans "مراسلة واتساب" %}
                                        </a>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Report Ad Card -->
                        {% if request.user.is_authenticated and request.user != ad.user %}
                        <div class="modern-card card ad-details-card mb-4 border-0 shadow-sm rounded-4" style="background: var(--bg-primary); backdrop-filter: blur(10px);">
                            <div class="card-body text-center py-3">
                                <a href="{% url 'main:report_ad' ad.id %}" class="report-btn d-inline-flex align-items-center gap-2" style="color: #94a3b8; text-decoration: none; font-size: 0.875rem; transition: all 0.3s ease; padding: 8px 16px; border-radius: 8px;">
                                    <i class="fas fa-flag"></i>
                                    <span>{% trans "إبلاغ عن هذا الإعلان" %}</span>
                                </a>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            <!-- Related Ads Section -->
            {% if related_ads %}
                <div class="row mt-5">
                    <div class="col-12">
                        <div class="modern-card p-4 rounded-4 shadow-sm mb-4" style="background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary)); backdrop-filter: blur(10px);">
                            <h3 class="section-title-related mb-4" style="color: var(--primary-color); font-weight: 800; text-align: center;">
                                <i class="fas fa-layer-group me-2"></i>{% trans "إعلانات ذات صلة" %}
                            </h3>
                            <div class="swiper related-ads-swiper">
                                <div class="swiper-wrapper">
                                    {% for related_ad in related_ads %}
                                        <div class="swiper-slide"> {# Changed #}
                                            {% include "classifieds/_ad_card.html" with ad=related_ad %} {# Changed #}
                                        </div>
                                    {% endfor %}
                                </div>
                                <div class="swiper-pagination related-ads-pagination"></div>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </section>

    <!-- Lightbox Modal -->
    <div id="imageLightbox" class="lightbox" onclick="closeLightboxOnBackground(event)">
        <div class="lightbox-zoom-indicator" id="zoomIndicator">
            <i class="fas fa-search-plus me-1"></i>
            <span id="zoomLevel">100%</span>
        </div>
        <span class="lightbox-close" onclick="closeLightbox()" title="{% trans "إغلاق" %}">×</span>
        <span class="lightbox-prev" onclick="changeLightboxImage(-1)" title="{% trans "السابق" %}">‹</span>
        <div class="lightbox-content">
            <img id="lightboxImage" src="" alt="{% trans "صورة بالحجم الكامل" %}">
            <div class="lightbox-loading" id="lightboxLoading" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
            </div>
        </div>
        <span class="lightbox-next" onclick="changeLightboxImage(1)" title="{% trans "التالي" %}">›</span>
        <div class="lightbox-counter">
            <span id="lightboxCounter"></span>
        </div>
    </div>

{% endblock content %}

{% block extra_js %}
    <script>
        // Wait for DOM to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Lightbox functionality
            let currentLightboxIndex = 0;
            const lightboxImages = [
                {% for image in ad.images.all %}
                    {
                        url: "{{ image.image.url }}",
                        alt: "{{ ad.title }} - {% trans "صورة" %} {{ forloop.counter }}"
                    }{% if not forloop.last %},{% endif %}
                {% endfor %}
            ];

            // Debug: Check if images are loaded
            console.log('Lightbox images:', lightboxImages);
            console.log('Number of images:', lightboxImages.length);

            // Test lightbox functionality
            if (lightboxImages.length === 0) {
                console.warn('No images found for lightbox');
            }

            // Verify lightbox elements exist
            const lightboxElement = document.getElementById('imageLightbox');
            const lightboxImgElement = document.getElementById('lightboxImage');
            console.log('Lightbox element found:', !!lightboxElement);
            console.log('Lightbox image element found:', !!lightboxImgElement);

            function openLightbox(index) {
                console.log('Opening lightbox with index:', index);
                currentLightboxIndex = index;
                const lightbox = document.getElementById('imageLightbox');
                const lightboxImg = document.getElementById('lightboxImage');
                const lightboxCounter = document.getElementById('lightboxCounter');
                const loadingIndicator = document.getElementById('lightboxLoading');

                if (lightboxImages.length > 0) {
                    // Show loading indicator
                    loadingIndicator.style.display = 'block';

                    const imageUrl = lightboxImages[currentLightboxIndex].url;
                    console.log('Loading image:', imageUrl);

                    // Set image source directly without preloading for faster display
                    lightboxImg.src = imageUrl;
                    lightboxImg.alt = lightboxImages[currentLightboxIndex].alt;
                    lightboxCounter.textContent = `${currentLightboxIndex + 1} / ${lightboxImages.length}`;

                    // Show lightbox immediately
                    lightbox.classList.add('active');
                    document.body.style.overflow = 'hidden';

                    // Hide loading indicator after a short delay
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                    }, 300);

                    // Reset zoom
                    currentScale = 1;
                    lightboxImg.style.transform = 'scale(1)';
                    updateZoomIndicator();
                } else {
                    console.error('No images found in lightboxImages array');
                }
            }

            function closeLightbox() {
                const lightbox = document.getElementById('imageLightbox');
                lightbox.classList.remove('active');
                document.body.style.overflow = '';
            }

            function closeLightboxOnBackground(event) {
                if (event.target.id === 'imageLightbox') {
                    closeLightbox();
                }
            }

            function changeLightboxImage(direction) {
                currentLightboxIndex += direction;

                if (currentLightboxIndex >= lightboxImages.length) {
                    currentLightboxIndex = 0;
                } else if (currentLightboxIndex < 0) {
                    currentLightboxIndex = lightboxImages.length - 1;
                }

                const lightboxImg = document.getElementById('lightboxImage');
                const lightboxCounter = document.getElementById('lightboxCounter');
                const loadingIndicator = document.getElementById('lightboxLoading');

                console.log('Changing to image:', currentLightboxIndex);

                // Show loading indicator
                loadingIndicator.style.display = 'block';

                const imageUrl = lightboxImages[currentLightboxIndex].url;
                console.log('Loading new image:', imageUrl);

                // Set image source directly
                lightboxImg.src = imageUrl;
                lightboxImg.alt = lightboxImages[currentLightboxIndex].alt;
                lightboxCounter.textContent = `${currentLightboxIndex + 1} / ${lightboxImages.length}`;

                // Hide loading indicator after a short delay
                setTimeout(() => {
                    loadingIndicator.style.display = 'none';
                }, 300);

                // Reset zoom when changing images
                currentScale = 1;
                lightboxImg.style.transform = 'scale(1)';
                updateZoomIndicator();
            }

            function updateZoomIndicator() {
                const zoomIndicator = document.getElementById('zoomIndicator');
                const zoomLevel = document.getElementById('zoomLevel');

                if (currentScale > 1) {
                    zoomIndicator.classList.add('visible');
                    zoomLevel.textContent = `${Math.round(currentScale * 100)}%`;
                } else {
                    zoomIndicator.classList.remove('visible');
                }
            }

            // Make functions globally accessible
            window.openLightbox = openLightbox;
            window.closeLightbox = closeLightbox;
            window.changeLightboxImage = changeLightboxImage;
            window.updateZoomIndicator = updateZoomIndicator;

        }); // End DOMContentLoaded

        // Fallback functions in case DOMContentLoaded doesn't work
        function openLightbox(index) {
            console.log('Fallback openLightbox called with index:', index);
        }

        function closeLightbox() {
            console.log('Fallback closeLightbox called');
        }

    </script>
{% endblock extra_js %}
