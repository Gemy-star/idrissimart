{% load static i18n %}

<script>
    // Global authentication status for JavaScript
    window.isAuthenticated = {% if request.user.is_authenticated %}true{% else %}false{% endif %};
</script>

<nav class="yojad-header sticky-top" id="mainNav">
    <!-- Top Navigation Bar -->
    <div class="top-nav-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Logo -->
                <div class="header-logo-section">
                    <a class="navbar-brand" href="{% url 'main:home' %}">
                        <div class="logo-container">
                            <!-- Floating Survey Icons -->
                            <div class="header-survey-icons">
                                <span class="header-survey-icon icon-1"><i class="fas fa-ruler-combined"></i></span>
                                <span class="header-survey-icon icon-2"><i class="fas fa-drafting-compass"></i></span>
                                <span class="header-survey-icon icon-3"><i class="fas fa-map-marked-alt"></i></span>
                                <span class="header-survey-icon icon-4"><i class="fas fa-satellite"></i></span>
                            </div>

                            <!-- Wide Logo -->
                            <div class="logo-wrapper">
                                <img src="{% static 'images/logos/logo-white-theme.png' %}"
                                     alt="Idrissimart Logo"
                                     class="header-main-logo light-theme-logo" />
                                <img src="{% static 'images/logos/logo-dark-theme.png' %}"
                                     alt="Idrissimart Logo"
                                     class="header-main-logo dark-theme-logo" />
                            </div>
                        </div>
                    </a>
                </div>
                <!-- Center: Search Bar -->
                <div class="header-search-section">
                    <form action="{% url 'main:ad_list' %}" method="get" class="search-wrapper" id="headerSearchForm">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               name="search"
                               class="header-search-input"
                               placeholder="{% trans 'ابحث في جميع الإعلانات ...' %}"
                               value="{{ request.GET.search|default:'' }}">
                        <button type="submit" class="header-search-submit" aria-label="{% trans 'بحث' %}">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                    </form>
                </div>
                <!-- Right Side: Actions -->
                <div class="header-actions-section">
                    <div class="d-flex align-items-center gap-3">
                        <!-- Desktop Country Selector -->
                        <div class="dropdown country-dropdown-wrapper">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown"
                                    aria-label="Select Country">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span class="current-country" data-country-code="{{ selected_country }}">
                                    {% for country in countries %}
                                        {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                                    {% endfor %}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end country-dropdown">
                                {% for country in countries %}
                                    <li>
                                        <a class="dropdown-item country-item
                                                  {% if country.code == selected_country %}active{% endif %}"
                                           href="#"
                                           data-country="{{ country.code }}">
                                            <span class="country-flag">{{ country.flag_emoji }}</span>
                                            <span class="country-name">{{ country.name }}</span>
                                            {% if country.code == selected_country %}<i class="fas fa-check country-check"></i>{% endif %}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <!-- Language Switcher -->
                        <div class="dropdown">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-globe me-1"></i>
                                <span class="current-lang">
                                    {% get_current_language as LANGUAGE_CODE %}
                                    {{ LANGUAGE_CODE|upper }}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <form action="{% url 'set_language' %}" method="post">
                                        {% csrf_token %}
                                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                        <button type="submit" name="language" value="ar" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            العربية
                                        </button>
                                        <button type="submit" name="language" value="en" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            English
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <!-- Cart (Only for authenticated users) -->
                        {% if request.user.is_authenticated %}
                        <div class="header-cart-section">
                            <a href="{% url "main:cart_view" %}" class="header-action-btn position-relative" aria-label="{% trans "السلة" %}">
                                <i class="fas fa-shopping-cart"></i>
                                <span class="cart-count badge-count">{{ cart_count|default:0 }}</span>
                            </a>
                        </div>
                        {% endif %}
                        <!-- Wishlist (Only for authenticated users) -->
                        {% if request.user.is_authenticated %}
                        <div class="header-wishlist-section">
                            <a href="{% url "main:wishlist_view" %}" class="header-action-btn position-relative" aria-label="{% trans "المفضلة" %}">
                                <i class="fas fa-heart"></i>
                                <span class="wishlist-count badge-count">{{ wishlist_count|default:0 }}</span>
                            </a>
                        </div>
                        {% endif %}
                        <!-- User Account -->
                        <div class="header-user-section dropdown">
                            {% if request.user.is_authenticated %}
                                <a class="header-action-btn dropdown-toggle d-flex align-items-center gap-2"
                                   href="#"
                                   role="button"
                                   data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    <i class="fas fa-user-circle"></i>
                                    <span class="badge bg-primary rounded-pill">{{ request.user.get_full_name|default:request.user.username|slice:":2"|upper }}</span>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    {% if request.user.is_staff %}
                                    <!-- Admin/Staff Only Links -->
                                    <li><h6 class="dropdown-header text-danger">{% trans "لوحة الإدارة" %}</h6></li>
                                    <li><a class="dropdown-item" href="{% url 'main:admin_dashboard' %}"><i class="fas fa-shield-alt fa-fw me-2"></i>{% trans "لوحة الإدارة الرئيسية" %}</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:admin_support_chats" %}">
                                            <i class="fas fa-headset me-2 text-success"></i>{% trans "دعم العملاء" %}
                                        </a>
                                    </li>
                                    {% else %}
                                    <!-- Regular Users - Publisher Dashboard Links -->
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:dashboard" %}">
                                            <i class="fas fa-tachometer-alt me-2 text-primary"></i>{% trans "لوحة التحكم" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:publisher_chats" %}">
                                            <i class="fas fa-comments me-2 text-success"></i>{% trans "رسائلي" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:publisher_notifications" %}">
                                            <i class="fas fa-bell me-2 text-warning"></i>{% trans "الإشعارات" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:my_ads" %}">
                                            <i class="fas fa-bullhorn me-2 text-info"></i>{% trans "إعلاناتي" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:packages_list" %}">
                                            <i class="fas fa-gift me-2 text-purple"></i>{% trans "باقات النشر" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:publisher_settings" %}">
                                            <i class="fas fa-cog me-2 text-secondary"></i>{% trans "الإعدادات" %}
                                        </a>
                                    </li>
                                    {% if request.user.verification_status != 'verified' %}
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:publisher_settings" %}">
                                            <i class="fas fa-shield-alt me-2 text-success"></i>{% trans "توثيق العضوية" %}
                                            <span class="badge bg-warning text-dark ms-2">جديد</span>
                                        </a>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <a class="dropdown-item" href="{% url "main:saved_searches" %}">
                                            <i class="fas fa-bookmark me-2 text-secondary"></i>{% trans "عمليات البحث المحفوظة" %}
                                        </a>
                                    </li>
                                    {% endif %}

                                    <li><hr class="dropdown-divider"></li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url "main:logout" %}">
                                            <i class="fas fa-sign-out-alt me-2"></i>{% trans "تسجيل الخروج" %}
                                        </a>
                                    </li>
                                </ul>
                            {% else %}
                                <!-- Guest User - Show Login and Register Links -->
                                <div class="d-flex gap-1 gap-md-2 align-items-center">
                                    <a class="header-action-btn" href="{% url "main:login" %}" title="{% trans "تسجيل الدخول" %}">
                                        <i class="fas fa-sign-in-alt"></i>
                                        <span class="d-none d-lg-inline ms-1">{% trans "دخول" %}</span>
                                    </a>
                                    <a class="header-action-btn btn-register" href="{% url "main:register" %}" title="{% trans "تسجيل عضوية جديدة" %}">
                                        <i class="fas fa-user-plus"></i>
                                        <span class="d-none d-lg-inline ms-1">{% trans "تسجيل" %}</span>
                                    </a>
                                </div>
                            {% endif %}
                        </div>
                        <!-- Notification Bell (Only for authenticated users) -->
                        {% if request.user.is_authenticated %}
                        <div class="header-notification-section dropdown">
                            <a href="#"
                               class="header-action-btn position-relative dropdown-toggle"
                               role="button"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <i class="fas fa-bell"></i>
                                {% if unread_notifications_count > 0 %}
                                    <span class="notification-badge">{{ unread_notifications_count }}</span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end notification-dropdown">
                                <li class="notification-header">
                                    <h6>{% trans "الإشعارات" %}</h6>
                                </li>
                                {% for notification in latest_notifications %}
                                    <li>
                                        <a class="dropdown-item notification-item"
                                           href="{{ notification.link|default:'#' }}">
                                            <p class="mb-0">{{ notification.message }}</p>
                                            <small class="text-muted">{{ notification.created_at|timesince }} {% trans "ago" %}</small>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li class="text-center p-3 text-muted">{% trans "لا توجد إشعارات جديدة" %}</li>
                                {% endfor %}
                                <li class="notification-footer">
                                    <a href="{% url 'main:notification_list' %}">{% trans "عرض كل الإشعارات" %}</a>
                                </li>
                            </ul>
                        </div>
                        {% endif %}
                        <!-- Theme Toggle -->
                        <div class="header-theme-section">
                            <button class="header-action-btn header-icon-btn header-theme-toggle"
                                    id="headerThemeToggle"
                                    type="button"
                                    aria-label="{% trans "تبديل المظهر" %}">
                                <i class="fas fa-sun theme-icon-light"></i>
                                <i class="fas fa-moon theme-icon-dark"></i>
                            </button>
                        </div>
                        <!-- Post Ad Button -->
                        <div class="header-post-ad">
                            <a href="{% url 'main:ad_create' %}" class="btn-post-ad">
                                <i class="fas fa-plus-circle me-2"></i>
                                {% trans "نشر الإعلان" %}
                            </a>
                        </div>
                        <!-- Blog Link -->
                        <div class="d-none d-lg-block ms-2">
                            <a class="header-action-btn header-icon-btn"
                               href="{% url 'content:blog_list' %}"
                               aria-label="{% trans "المدونة" %}"
                               title="{% trans "المدونة" %}">
                                <i class="fas fa-newspaper"></i>
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Mobile Cart & Wishlist (beside hamburger) - Only for authenticated users -->
                {% if request.user.is_authenticated %}
                <div class="mobile-header-actions d-lg-none">
                    <!-- Mobile Cart Button -->
                    <a href="{% url "main:cart_view" %}" class="mobile-header-btn position-relative" aria-label="{% trans "السلة" %}">
                        <i class="fas fa-shopping-cart"></i>
                        <span class="mobile-header-badge cart-count">{{ cart_count|default:0 }}</span>
                    </a>
                    <!-- Mobile Wishlist Button -->
                    <a href="{% url "main:wishlist_view" %}" class="mobile-header-btn position-relative" aria-label="{% trans "المفضلة" %}">
                        <i class="fas fa-heart"></i>
                        <span class="mobile-header-badge wishlist-count">{{ wishlist_count|default:0 }}</span>
                    </a>
                </div>
                {% endif %}
                <!-- Hamburger (Mobile) -->
                <button class="hamburger d-lg-none"
                        id="hamburgerBtn"
                        type="button"
                        aria-label="Toggle menu">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </div>
    <!-- Categories Navigation Bar -->
    <div class="categories-nav-bar">
        <div class="container">
            <div class="categories-scroll-container">
                <div class="categories-nav-list">
                    <!-- Dynamic Category Items -->
                    {% for category in header_categories %}
                        <div class="category-nav-item"
                             data-category-id="{{ category.id }}"
                             data-category-color="category-{{ forloop.counter }}"
                             data-category-url="{% url 'main:categories' %}?section={{ category.section_type }}"
                             onclick="handleCategoryClick(this, {{ category.id }})"
                             role="button"
                             tabindex="0">
                            <div class="category-icon">
                                {% if category.icon %}
                                    <i class="{{ category.icon }} text-white"></i>
                                {% else %}
                                    <i class="fas fa-folder text-white"></i>
                                {% endif %}
                            </div>
                            <span class="yojad-category-name">{{ category.name_ar|default:category.name }}</span>
                            <div class="category-loading" style="display: none;">
                                <i class="fas fa-spinner fa-spin"></i>
                            </div>
                        </div>
                    {% empty %}
                        <!-- Fallback if no categories -->
                        <a href="{% url 'main:categories' %}"
                           class="category-nav-item"
                           data-category-color="green">
                            <div class="category-icon">
                                <i class="fas fa-book text-white"></i>
                            </div>
                            <span class="yojad-category-name">{% trans "كتب وبرامج مساحية" %}</span>
                        </a>
                    {% endfor %}
                </div>
            </div>

            <style>
                /* Scrollable Categories Container */
                .categories-scroll-container {
                    overflow-x: auto;
                    overflow-y: hidden;
                    -webkit-overflow-scrolling: touch;
                    scrollbar-width: thin;
                    scrollbar-color: rgba(75, 49, 94, 0.5) transparent;
                    padding: 0.5rem 0;
                }

                .categories-scroll-container::-webkit-scrollbar {
                    height: 6px;
                }

                .categories-scroll-container::-webkit-scrollbar-track {
                    background: transparent;
                }

                .categories-scroll-container::-webkit-scrollbar-thumb {
                    background-color: rgba(75, 49, 94, 0.5);
                    border-radius: 3px;
                }

                .categories-scroll-container::-webkit-scrollbar-thumb:hover {
                    background-color: rgba(75, 49, 94, 0.7);
                }

                .categories-nav-list {
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    padding: 0.5rem 0;
                    min-width: min-content;
                    justify-content: flex-start;
                }

                /* Mobile: < 576px */
                @media (max-width: 575.98px) {
                    .categories-scroll-container {
                        padding: 0.25rem 0;
                    }

                    .categories-nav-list {
                        justify-content: flex-start;
                        gap: 0.5rem;
                        padding: 0.25rem 0;
                    }

                    .category-nav-item {
                        min-width: 80px !important;
                        font-size: 0.75rem !important;
                    }
                }

                /* Tablet: 576px - 991px */
                @media (min-width: 576px) and (max-width: 991.98px) {
                    .categories-scroll-container {
                        padding: 0.4rem 0;
                    }

                    .categories-nav-list {
                        justify-content: flex-start;
                        gap: 0.75rem;
                        padding: 0.4rem 0;
                    }

                    .category-nav-item {
                        min-width: 90px !important;
                        font-size: 0.85rem !important;
                    }
                }

                /* Desktop: 992px - 1199px */
                @media (min-width: 992px) and (max-width: 1199.98px) {
                    .categories-nav-list {
                        justify-content: flex-start;
                        gap: 0.875rem;
                    }

                    .category-nav-item {
                        min-width: 95px !important;
                        font-size: 0.9rem !important;
                    }
                }

                /* Large Desktop: 1200px - 1399px */
                @media (min-width: 1200px) and (max-width: 1399.98px) {
                    .categories-nav-list {
                        justify-content: flex-start;
                        gap: 1rem;
                    }

                    .category-nav-item {
                        min-width: 100px !important;
                    }
                }

                /* Extra Large Desktop: >= 1400px */
                @media (min-width: 1400px) {
                    .categories-nav-list {
                        justify-content: flex-start;
                        gap: 1.25rem;
                    }

                    .category-nav-item {
                        min-width: 110px !important;
                    }
                }
            </style>
        </div>

        <!-- Subcategories Dropdown -->
        <div class="subcategories-dropdown" id="subcategoriesDropdown">
            <div class="container">
                <div class="subcategories-wrapper">
                    <div class="subcategories-header">
                        <h6 class="subcategories-title">الفئات الفرعية</h6>
                        <span class="parent-category-name" id="parentCategoryName"></span>
                        <button class="subcategories-close" onclick="hideSubcategories()" aria-label="إغلاق الفئات الفرعية">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <!-- Subcategories List -->
                    <div class="subcategories-list" id="subcategoriesList">
                        <!-- Subcategories will be loaded here dynamically -->
                    </div>
                    <!-- Sub-subcategories container -->
                    <div class="sub-subcategories-section" id="subSubcategoriesSection" style="display: none;">
                        <div class="sub-subcategories-header">
                            <h6 class="sub-subcategories-title">الفئات الفرعية الثانوية</h6>
                            <span class="parent-subcategory-name" id="parentSubcategoryName"></span>
                        </div>
                        <div class="sub-subcategories-grid" id="subSubcategoriesList">
                            <!-- Sub-subcategories will be loaded here -->
                        </div>
                    </div>
                    <div class="subcategories-footer">
                        <a href="#" class="view-all-link" id="viewAllSubcategories">
                            <i class="fas fa-arrow-left me-2"></i>
                            عرض جميع الفئات الفرعية
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-close"
                id="mobileNavClose"
                type="button"
                aria-label="{% trans 'إغلاق القائمة' %}">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="mobile-nav-header">
            <div class="mobile-logo-container">
                <img src="{% static 'images/logos/mini-logo-white-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo light-theme-logo" />
                <img src="{% static 'images/logos/mini-logo-dark-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo dark-theme-logo" />
            </div>
            {% if request.user.is_authenticated %}
                {% load idrissimart_tags %}

                <div class="mobile-user-info">
                    {% user_avatar user=request.user size=60 css_class="mobile-user-avatar" %}
                    <div class="mobile-user-details">
                        <span class="mobile-user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                        <span class="mobile-user-email">{{ request.user.email }}</span>
                    </div>
                </div>
            {% else %}
                <div class="mobile-guest-info">
                    <i class="fas fa-user-circle"></i>
                    <p>{% trans "مرحباً بك" %}</p>
                </div>
            {% endif %}
        </div>
        <ul class="mobile-nav-menu">
            <li>
                <a href="{% url 'main:home' %}" class="mobile-nav-link">
                    <i class="fas fa-home"></i><span>{% trans "الرئيسية" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:categories' %}" class="mobile-nav-link">
                    <i class="fas fa-th-large"></i><span>{% trans "الأقسام" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'content:blog_list' %}" class="mobile-nav-link">
                    <i class="fas fa-newspaper fa-fw"></i><span>{% trans "المدونة" %}</span>
                </a>
            </li>
            <!-- Cart & Wishlist Links - Only for authenticated users -->
            {% if request.user.is_authenticated %}
            <li class="mobile-nav-divider"></li>
            <li>
                <a href="{% url "main:cart_view" %}" class="mobile-nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>{% trans "السلة" %}</span>
                    <span class="mobile-badge cart-count">{{ cart_count|default:0 }}</span>
                </a>
            </li>
            <li>
                <a href="{% url "main:wishlist_view" %}" class="mobile-nav-link">
                    <i class="fas fa-heart text-danger"></i>
                    <span>{% trans "المفضلة" %}</span>
                    <span class="mobile-badge wishlist-count">{{ wishlist_count|default:0 }}</span>
                </a>
            </li>
            <li class="mobile-nav-divider"></li>
            {% endif %}
            {% if request.user.is_authenticated %}
                <li>
                    <a href="{% url 'main:saved_searches' %}" class="mobile-nav-link">
                        <i class="fas fa-save"></i><span>{% trans "عمليات البحث المحفوظة" %}</span>
                    </a>
                </li>
                {% if request.user.is_superuser %}
                    <li>
                        <a href="{% url 'main:admin_dashboard' %}" class="mobile-nav-link">
                            <i class="fas fa-shield-alt text-danger"></i><span>{% trans "لوحة الإدارة الرئيسية" %}</span>
                        </a>
                    </li>
                {% endif %}
                <li>
                    <a href="{% url 'main:logout' %}" class="mobile-nav-link logout">
                        <i class="fas fa-sign-out-alt"></i><span>{% trans "تسجيل الخروج" %}</span>
                    </a>
                </li>
            {% else %}
                <li>
                    <a href="{% url "main:login" %}" class="mobile-nav-link highlight">
                        <i class="fas fa-sign-in-alt"></i><span>{% trans "تسجيل الدخول" %}</span>
                    </a>
                </li>
            {% endif %}
            <li class="mobile-nav-divider"></li>
            <!-- Mobile Theme Toggle -->
            <li>
                <button class="header-theme-toggle mobile-nav-link mobile-theme-toggle-btn"
                        id="mobileThemeToggle"
                        type="button"
                        aria-label="{% trans 'تبديل المظهر' %}">
                    <span class="theme-toggle-icons">
                        <i class="fas fa-sun theme-icon-light"></i>
                        <i class="fas fa-moon theme-icon-dark"></i>
                    </span>
                </button>
            </li>
        </ul>
        <!-- Mobile Country Selector -->
        <div class="mobile-country-selector">
            <div class="mobile-section-title">
                <i class="fas fa-map-marker-alt me-2"></i>{% trans "اختر البلد" %}
            </div>
            <button class="mobile-country-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileCountryList">
                <div class="current-selection">
                    <span class="country-flag-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                        {% endfor %}
                    </span>
                    <span class="country-name-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.name }}{% endif %}
                        {% endfor %}
                    </span>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileCountryList">
                <div class="country-list-wrapper">
                    {% for country in countries %}
                        <div class="mobile-country-item
                                    {% if country.code == selected_country %}active{% endif %}"
                             data-country="{{ country.code }}">
                            <div class="country-content">
                                <span class="country-flag-item">{{ country.flag_emoji }}</span>
                                <span class="country-name-item">{{ country.name }}</span>
                            </div>
                            {% if country.code == selected_country %}<i class="fas fa-check-circle check-icon"></i>{% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Mobile Language Switcher -->
        <div class="mobile-lang-selector mt-3">
            <div class="mobile-section-title">
                <i class="fas fa-globe me-2"></i>{% trans "اختر اللغة" %}
            </div>
            <button class="mobile-lang-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileLangList">
                <div class="current-selection">
                    {% if LANGUAGE_CODE == 'ar' %}
                        <span class="lang-name-large">العربية</span>
                    {% else %}
                        <span class="lang-name-large">English</span>
                    {% endif %}
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileLangList">
                <div class="language-list-wrapper">
                    <form action="{% url 'set_language' %}" method="post">
                        {% csrf_token %}
                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                        <button type="submit"
                                name="language"
                                value="ar"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'ar' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            العربية
                        </button>
                        <button type="submit"
                                name="language"
                                value="en"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'en' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            English
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="mobile-nav-backdrop" id="mobileBackdrop"></div>
</nav>

<script>
    // Enhanced header subcategory functionality
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburgerBtn');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavClose = document.getElementById('mobileNavClose');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        const subcategoriesDropdown = document.getElementById('subcategoriesDropdown');

        let currentCategoryId = null;

        // Categories are now simple scrollable - no Swiper initialization needed
        console.log('✅ Categories loaded - Simple scrollable layout');

        // Mobile menu toggle
        function toggleMobileMenu(show) {
            if (show) {
                mobileNav.classList.add('show');
                mobileBackdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                mobileNav.classList.remove('show');
                mobileBackdrop.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Event listeners
        hamburger?.addEventListener('click', () => toggleMobileMenu(true));
        mobileNavClose?.addEventListener('click', () => toggleMobileMenu(false));
        mobileBackdrop?.addEventListener('click', () => toggleMobileMenu(false));

        // Category click handler
        globalThis.handleCategoryClick = function(element, categoryId) {
            const categoryUrl = element.dataset.categoryUrl;
            const loadingEl = element.querySelector('.category-loading');

            // Check if subcategories are already shown for this category
            if (currentCategoryId === categoryId && subcategoriesDropdown.classList.contains('show')) {
                // Navigate to category page
                globalThis.location.href = categoryUrl;
                return;
            }

            // Show loading
            loadingEl.style.display = 'block';

            // Load subcategories
            loadSubcategories(categoryId, element.querySelector('.yojad-category-name').textContent)
                .then(() => {
                    loadingEl.style.display = 'none';
                    showSubcategories(categoryId);
                })
                .catch(() => {
                    loadingEl.style.display = 'none';
                    // Navigate to category page if loading fails
                    globalThis.location.href = categoryUrl;
                });
        };

        // Show subcategories dropdown
        globalThis.showSubcategories = function(categoryId) {
            currentCategoryId = categoryId;
            subcategoriesDropdown.classList.add('show');

            // Hide sub-subcategories when showing new subcategories
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Hide subcategories dropdown
        globalThis.hideSubcategories = function() {
            subcategoriesDropdown.classList.remove('show');
            currentCategoryId = null;

            // Hide sub-subcategories too
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Load subcategories
        function loadSubcategories(categoryId, categoryName) {
            return new Promise((resolve, reject) => {
                const parentCategoryName = document.getElementById('parentCategoryName');
                const subcategoriesList = document.getElementById('subcategoriesList');
                const viewAllLink = document.getElementById('viewAllSubcategories');

                parentCategoryName.textContent = categoryName;
                subcategoriesList.innerHTML = '<div><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';

                fetch(`/ajax/subcategories/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            subcategoriesList.innerHTML = '<div>خطأ في تحميل الفئات الفرعية</div>';
                            reject(new Error(data.error));
                            return;
                        }

                        if (data.subcategories && data.subcategories.length > 0) {
                            // Render subcategories
                            subcategoriesList.innerHTML = data.subcategories.map(subcat => `
                                <div class="subcategory-item"
                                     data-subcategory-id="${subcat.id}"
                                     data-subcategory-url="${subcat.url}"
                                     data-has-children="${subcat.has_children}"
                                     onclick="handleSubcategoryClick(this, ${subcat.id}, '${subcat.url}', ${subcat.has_children}, '${subcat.name_ar || subcat.name}')">
                                    <div class="subcategory-icon">
                                        <i class="${subcat.icon || 'fas fa-folder'}"></i>
                                    </div>
                                    <span class="subcategory-name">${subcat.name_ar || subcat.name}</span>
                                    ${subcat.has_children ? '<i class="fas fa-chevron-right subcategory-expand"></i>' : ''}
                                </div>
                            `).join('');

                            // Update view all link
                            viewAllLink.href = `/categories?parent=${categoryId}`;

                            resolve();
                        } else {
                            subcategoriesList.innerHTML = '<div>لا توجد فئات فرعية</div>';
                            resolve();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading subcategories:', error);
                        subcategoriesList.innerHTML = '<div>خطأ في الاتصال</div>';
                        reject(error);
                    });
            });
        }

        // Handle subcategory click
        globalThis.handleSubcategoryClick = function(element, subcategoryId, url, hasChildren, subcategoryName) {
            if (hasChildren) {
                // Load sub-subcategories
                loadSubSubcategories(subcategoryId, subcategoryName);
            } else {
                // Navigate to subcategory page
                globalThis.location.href = url;
            }
        };

        // Load sub-subcategories
        function loadSubSubcategories(subcategoryId, subcategoryName) {
            const subSubSection = document.getElementById('subSubcategoriesSection');
            const parentSubcategoryName = document.getElementById('parentSubcategoryName');
            const subSubcategoriesList = document.getElementById('subSubcategoriesList');

            parentSubcategoryName.textContent = subcategoryName;
            subSubcategoriesList.innerHTML = '<div class="loading-item"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';
            subSubSection.style.display = 'block';

            fetch(`/ajax/subcategories/${subcategoryId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        subSubcategoriesList.innerHTML = '<div class="error-item">خطأ في تحميل الفئات</div>';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        subSubcategoriesList.innerHTML = data.subcategories.map(subSubcat => `
                            <div class="sub-subcategory-item" onclick="globalThis.location.href='${subSubcat.url}'">
                                <div class="sub-subcategory-icon">
                                    <i class="${subSubcat.icon || 'fas fa-folder'}"></i>
                                </div>
                                <span class="sub-subcategory-name">${subSubcat.name_ar || subSubcat.name}</span>
                            </div>
                        `).join('');
                    } else {
                        subSubcategoriesList.innerHTML = '<div class="empty-item">لا توجد فئات فرعية إضافية</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sub-subcategories:', error);
                    subSubcategoriesList.innerHTML = '<div class="error-item">خطأ في الاتصال</div>';
                });
        }

        // Close subcategories when clicking outside
        document.addEventListener('click', function(e) {
            if (!subcategoriesDropdown.contains(e.target) &&
                !e.target.closest('.category-nav-item')) {
                hideSubcategories();
            }
        });

        // Touch-friendly category navigation for mobile
        const categoryItems = document.querySelectorAll('.category-nav-item');
        for (const item of categoryItems) {
            let touchStartTime = 0;

            item.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
            });

            item.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                const categoryId = this.dataset.categoryId;

                // Handle touch
                if (touchDuration < 300 && categoryId) {
                    e.preventDefault();
                    handleCategoryClick(this, Number.parseInt(categoryId, 10));
                }
            });

            // Add keyboard support
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const categoryId = this.dataset.categoryId;
                    if (categoryId) {
                        handleCategoryClick(this, Number.parseInt(categoryId, 10));
                    }
                }
            });
        }

        // Mobile country/language selector improvements
        const mobileCountryItems = document.querySelectorAll('.mobile-country-item');
        for (const item of mobileCountryItems) {
            item.addEventListener('click', function() {
                const countryCode = this.dataset.country;
                if (countryCode && typeof setCountry === 'function') {
                    setCountry(countryCode);
                }
            });
        }

        // Close mobile menu on resize to desktop
        globalThis.addEventListener('resize', function() {
            if (globalThis.innerWidth > 768 && mobileNav.classList.contains('show')) {
                toggleMobileMenu(false);
            }
        });

        // Prevent menu close on scroll
        mobileNav?.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        });
    });
</script>
