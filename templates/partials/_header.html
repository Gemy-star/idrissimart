{% load static i18n %}

<nav class="yojad-header sticky-top" id="mainNav">
    <!-- Top Navigation Bar -->
    <div class="top-nav-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Logo -->
                <div class="header-logo-section">
                    <a class="navbar-brand" href="{% url 'main:home' %}">
                        <img src="{% static 'images/logos/logo-white-theme.png' %}"
                             alt="Logo"
                             class="header-main-logo light-theme-logo" />
                        <img src="{% static 'images/logos/logo-dark-theme.png' %}"
                             alt="Logo"
                             class="header-main-logo dark-theme-logo" />
                    </a>
                </div>
                <!-- Center: Search Bar -->
                <div class="header-search-section">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               class="header-search-input"
                               placeholder="{% trans 'ÿ®ÿØÿ° ÿßŸÑÿ®ÿ≠ÿ´ ...' %}">
                    </div>
                </div>
                <!-- Right Side: Actions -->
                <div class="header-actions-section">
                    <div class="d-flex align-items-center gap-3">
                        <!-- Desktop Country Selector -->
                        <div class="dropdown country-dropdown-wrapper">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown"
                                    aria-label="Select Country">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span class="current-country" data-country-code="{{ selected_country }}">
                                    {% for country in countries %}
                                        {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                                    {% endfor %}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end country-dropdown">
                                {% for country in countries %}
                                    <li>
                                        <a class="dropdown-item country-item
                                                  {% if country.code == selected_country %}active{% endif %}"
                                           href="#"
                                           data-country="{{ country.code }}">
                                            <span class="country-flag">{{ country.flag_emoji }}</span>
                                            <span class="country-name">{{ country.name }}</span>
                                            {% if country.code == selected_country %}<i class="fas fa-check country-check"></i>{% endif %}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <!-- Language Switcher -->
                        <div class="dropdown">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-globe me-1"></i>
                                <span class="current-lang">
                                    {% get_current_language as LANGUAGE_CODE %}
                                    {{ LANGUAGE_CODE|upper }}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <form action="{% url 'set_language' %}" method="post">
                                        {% csrf_token %}
                                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                        <button type="submit" name="language" value="ar" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                                        </button>
                                        <button type="submit" name="language" value="en" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            English
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <!-- Cart -->
                        <div class="header-cart-section">
                            <a href="{% url 'main:cart_view' %}" class="header-action-btn position-relative" aria-label="{% trans 'ÿßŸÑÿ≥ŸÑÿ©' %}">
                                <i class="fas fa-shopping-cart"></i>
                                {% if request.user.is_authenticated %}
                                    <span class="cart-count badge-count">{{ cart_count|default:0 }}</span>
                                {% endif %}
                            </a>
                        </div>
                        <!-- Wishlist -->
                        <div class="header-wishlist-section">
                            <a href="{% url 'main:wishlist_view' %}" class="header-action-btn position-relative" aria-label="{% trans 'ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©' %}">
                                <i class="fas fa-heart"></i>
                                {% if request.user.is_authenticated %}
                                    <span class="wishlist-count badge-count">{{ wishlist_count|default:0 }}</span>
                                {% else %}
                                    <span class="wishlist-count badge-count guest-wishlist-count">0</span>
                                {% endif %}
                            </a>
                        </div>
                        <!-- User Account -->
                        <div class="header-user-section dropdown">
                            {% if request.user.is_authenticated %}
                                <a class="header-action-btn dropdown-toggle d-flex align-items-center gap-2"
                                   href="#"
                                   role="button"
                                   data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    <i class="fas fa-user-circle"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:dashboard' %}">
                                            <i class="fas fa-tachometer-alt me-2 text-primary"></i>{% trans "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ" %}
                                        </a>
                                    </li>
                                    <li>
                                        {% if request.user.profile_type != 'default' %}
                                            <a class="dropdown-item" href="{% url 'main:publisher_chats' %}">
                                                <i class="fas fa-comments me-2 text-success"></i>{% trans "ÿ±ÿ≥ÿßÿ¶ŸÑŸä" %}
                                            </a>
                                        {% else %}
                                            <a class="dropdown-item" href="{% url 'main:chat_list' %}">
                                                <i class="fas fa-comments me-2 text-success"></i>{% trans "ÿ±ÿ≥ÿßÿ¶ŸÑŸä" %}
                                            </a>
                                        {% endif %}
                                    </li>
                                    <li>
                                        {% if request.user.profile_type != 'default' %}
                                            <a class="dropdown-item" href="{% url 'main:publisher_notifications' %}">
                                                <i class="fas fa-bell me-2 text-warning"></i>{% trans "ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™" %}
                                            </a>
                                        {% else %}
                                            <a class="dropdown-item" href="{% url 'main:notification_list' %}">
                                                <i class="fas fa-bell me-2 text-warning"></i>{% trans "ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™" %}
                                            </a>
                                        {% endif %}
                                    </li>
                                    {% if request.user.profile_type != 'default' %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:my_ads' %}">
                                            <i class="fas fa-bullhorn me-2 text-info"></i>{% trans "ÿ•ÿπŸÑÿßŸÜÿßÿ™Ÿä" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:packages_list' %}">
                                            <i class="fas fa-gift me-2 text-purple"></i>{% trans "ÿ®ÿßŸÇÿßÿ™ ÿßŸÑŸÜÿ¥ÿ±" %}
                                        </a>
                                    </li>
                                    {% endif %}
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:saved_searches' %}">
                                            <i class="fas fa-bookmark me-2 text-secondary"></i>{% trans "ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©" %}
                                        </a>
                                    </li>
                                    {% if request.user.is_superuser %}
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'main:admin_dashboard' %}">
                                                <i class="fas fa-shield-alt me-2 text-danger"></i>{% trans "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" %}
                                            </a>
                                        </li>
                                    {% endif %}
                                    {% if request.user.is_staff %}
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'main:reservation_management' %}">
                                                <i class="fas fa-shopping-cart me-2 text-info"></i>{% trans "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™" %}
                                            </a>
                                        </li>
                                    {% endif %}
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'main:logout' %}">{% trans "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨" %}</a>
                                    </li>
                                </ul>
                            {% else %}
                                <a class="header-action-btn" href="{% url 'main:login' %}">
                                    <i class="fas fa-user"></i>
                                </a>
                            {% endif %}
                        </div>
                        <!-- Notification Bell -->
                        <div class="header-notification-section dropdown">
                            <a href="#"
                               class="header-action-btn position-relative dropdown-toggle"
                               role="button"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <i class="fas fa-bell"></i>
                                {% if unread_notifications_count > 0 %}
                                    <span class="notification-badge">{{ unread_notifications_count }}</span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end notification-dropdown">
                                <li class="notification-header">
                                    <h6>{% trans "ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™" %}</h6>
                                </li>
                                {% for notification in latest_notifications %}
                                    <li>
                                        <a class="dropdown-item notification-item"
                                           href="{{ notification.link|default:'#' }}">
                                            <p class="mb-0">{{ notification.message }}</p>
                                            <small class="text-muted">{{ notification.created_at|timesince }} {% trans "ago" %}</small>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li class="text-center p-3 text-muted">{% trans "ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ¨ÿØŸäÿØÿ©" %}</li>
                                {% endfor %}
                                <li class="notification-footer">
                                    <a href="{% url 'main:notification_list' %}">{% trans "ÿπÿ±ÿ∂ ŸÉŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™" %}</a>
                                </li>
                            </ul>
                        </div>
                        <!-- Theme Toggle -->
                        <div class="header-theme-section">
                            <button class="header-action-btn header-icon-btn header-theme-toggle"
                                    id="headerThemeToggle"
                                    type="button"
                                    aria-label="{% trans 'ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖÿ∏Ÿáÿ±' %}">
                                <i class="fas fa-sun theme-icon-light"></i>
                                <i class="fas fa-moon theme-icon-dark"></i>
                            </button>
                        </div>
                        <!-- Post Ad Button -->
                        <div class="header-post-ad">
                            <a href="{% url 'main:ad_create' %}" class="btn-post-ad">
                                <i class="fas fa-plus-circle me-2"></i>
                                {% trans "ŸÜÿ¥ÿ± ÿßŸÑÿ•ÿπŸÑÿßŸÜ" %}
                            </a>
                        </div>
                        <!-- New Desktop Dropdown Menu -->
                        <div class="dropdown d-none d-lg-block ms-2">
                            <button class="header-action-btn header-icon-btn"
                                    type="button"
                                    id="desktopMenuDropdown"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    aria-label="{% trans 'More pages' %}">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end"
                                aria-labelledby="desktopMenuDropdown">
                                <li>
                                    <a class="dropdown-item" href="{% url 'content:blog_list' %}">
                                        <i class="fas fa-newspaper fa-fw me-2"></i> {% trans "ÿßŸÑŸÖÿØŸàŸÜÿ©" %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'main:about' %}">
                                        <i class="fas fa-info-circle fa-fw me-2"></i> {% trans "ŸÖŸÜ ŸÜÿ≠ŸÜ" %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'main:contact' %}">
                                        <i class="fas fa-envelope fa-fw me-2"></i> {% trans "ÿßÿ™ÿµŸÑ ÿ®ŸÜÿß" %}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Mobile Cart & Wishlist (beside hamburger) -->
                <div class="mobile-header-actions d-lg-none">
                    <!-- Mobile Cart Button -->
                    <a href="{% url 'main:cart_view' %}" class="mobile-header-btn position-relative" aria-label="{% trans 'ÿßŸÑÿ≥ŸÑÿ©' %}">
                        <i class="fas fa-shopping-cart"></i>
                        {% if request.user.is_authenticated %}
                            <span class="mobile-header-badge cart-count">{{ cart_count|default:0 }}</span>
                        {% else %}
                            <span class="mobile-header-badge cart-count guest-cart-count">0</span>
                        {% endif %}
                    </a>
                    <!-- Mobile Wishlist Button -->
                    <a href="{% url 'main:wishlist_view' %}" class="mobile-header-btn position-relative" aria-label="{% trans 'ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©' %}">
                        <i class="fas fa-heart"></i>
                        {% if request.user.is_authenticated %}
                            <span class="mobile-header-badge wishlist-count">{{ wishlist_count|default:0 }}</span>
                        {% else %}
                            <span class="mobile-header-badge wishlist-count guest-wishlist-count">0</span>
                        {% endif %}
                    </a>
                </div>
                <!-- Hamburger (Mobile) -->
                <button class="hamburger d-lg-none"
                        id="hamburgerBtn"
                        type="button"
                        aria-label="Toggle menu">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </div>
    <!-- Categories Navigation Bar -->
    <div class="categories-nav-bar">
        <div class="container">
            <div class="categories-scroll-wrapper">
                <!-- Swiper Container -->
                <div class="swiper categories-swiper">
                    <!-- Navigation Arrows -->
                    <div class="categories-swiper-prev">
                        <i class="fas fa-chevron-right"></i>
                    </div>
                    <div class="categories-swiper-next">
                        <i class="fas fa-chevron-left"></i>
                    </div>

                    <div class="swiper-wrapper categories-nav-list">
                        <!-- Dynamic Category Items -->
                        {% for category in header_categories %}
                            <div class="category-nav-item swiper-slide"
                                 data-category-id="{{ category.id }}"
                                 data-category-color="category-{{ forloop.counter }}"
                                 data-category-url="{% url 'main:categories' %}?section={{ category.section_type }}"
                                 onclick="handleCategoryClick(this, {{ category.id }})"
                                 role="button"
                                 tabindex="0">
                                <div class="category-icon">
                                    {% if category.icon %}
                                        <i class="{{ category.icon }} text-white"></i>
                                    {% else %}
                                        <i class="fas fa-folder text-white"></i>
                                    {% endif %}
                                </div>
                                <span class="yojad-category-name">{{ category.name_ar|default:category.name }}</span>
                                <div class="category-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        {% empty %}
                            <!-- Fallback if no categories -->
                            <a href="{% url 'main:categories' %}"
                               class="category-nav-item swiper-slide"
                               data-category-color="green">
                                <div class="category-icon">
                                    <i class="fas fa-book text-white"></i>
                                </div>
                                <span class="yojad-category-name">{% trans "ŸÉÿ™ÿ® Ÿàÿ®ÿ±ÿßŸÖÿ¨ ŸÖÿ≥ÿßÿ≠Ÿäÿ©" %}</span>
                            </a>
                        {% endfor %}
                    </div>
                    <!-- Pagination Dots -->
                    <div class="swiper-pagination categories-swiper-pagination"></div>
                </div>

                <style>
                    /* Categories Swiper Navigation Arrows */
                    .categories-swiper-prev,
                    .categories-swiper-next {
                        position: absolute;
                        top: 50%;
                        transform: translateY(-50%);
                        width: 30px;
                        height: 30px;
                        border-radius: 50%;
                        background: rgba(75, 49, 94, 0.8);
                        color: #fff;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        cursor: pointer;
                        z-index: 10;
                        transition: all 0.3s ease;
                        font-size: 14px;
                    }

                    .categories-swiper-prev:hover,
                    .categories-swiper-next:hover {
                        background: rgba(75, 49, 94, 1);
                        transform: translateY(-50%) scale(1.1);
                    }

                    .categories-swiper-prev {
                        right: 10px;
                    }

                    .categories-swiper-next {
                        left: 10px;
                    }

                    .categories-swiper-prev.swiper-button-disabled,
                    .categories-swiper-next.swiper-button-disabled {
                        opacity: 0.3;
                        cursor: not-allowed;
                    }

                    /* Hide arrows on mobile */
                    @media (max-width: 768px) {
                        .categories-swiper-prev,
                        .categories-swiper-next {
                            display: none;
                        }
                    }
                </style>
            </div>
        </div>

        <!-- Subcategories Dropdown -->
        <div class="subcategories-dropdown" id="subcategoriesDropdown">
            <div class="container">
                <div class="subcategories-wrapper">
                    <div class="subcategories-header">
                        <h6 class="subcategories-title">ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ©</h6>
                        <span class="parent-category-name" id="parentCategoryName"></span>
                        <button class="subcategories-close" onclick="hideSubcategories()" aria-label="ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ©">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <!-- Subcategories Swiper -->
                    <div class="swiper subcategories-swiper">
                        <div class="swiper-wrapper" id="subcategoriesList">
                            <!-- Subcategories will be loaded here dynamically -->
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                    <!-- Sub-subcategories container -->
                    <div class="sub-subcategories-section" id="subSubcategoriesSection" style="display: none;">
                        <div class="sub-subcategories-header">
                            <h6 class="sub-subcategories-title">ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ© ÿßŸÑÿ´ÿßŸÜŸàŸäÿ©</h6>
                            <span class="parent-subcategory-name" id="parentSubcategoryName"></span>
                        </div>
                        <div class="sub-subcategories-grid" id="subSubcategoriesList">
                            <!-- Sub-subcategories will be loaded here -->
                        </div>
                    </div>
                    <div class="subcategories-footer">
                        <a href="#" class="view-all-link" id="viewAllSubcategories">
                            <i class="fas fa-arrow-left me-2"></i>
                            ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ©
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-close"
                id="mobileNavClose"
                type="button"
                aria-label="{% trans 'ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑŸÇÿßÿ¶ŸÖÿ©' %}">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="mobile-nav-header">
            <div class="mobile-logo-container">
                <img src="{% static 'images/logos/mini-logo-white-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo light-theme-logo" />
                <img src="{% static 'images/logos/mini-logo-dark-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo dark-theme-logo" />
            </div>
            {% if request.user.is_authenticated %}
                {% load idrissimart_tags %}

                <div class="mobile-user-info">
                    {% user_avatar user=request.user size=60 css_class="mobile-user-avatar" %}
                    <div class="mobile-user-details">
                        <span class="mobile-user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                        <span class="mobile-user-email">{{ request.user.email }}</span>
                    </div>
                </div>
            {% else %}
                <div class="mobile-guest-info">
                    <i class="fas fa-user-circle"></i>
                    <p>{% trans "ŸÖÿ±ÿ≠ÿ®ÿßŸã ÿ®ŸÉ" %}</p>
                </div>
            {% endif %}
        </div>
        <ul class="mobile-nav-menu">
            <li>
                <a href="{% url 'main:home' %}" class="mobile-nav-link">
                    <i class="fas fa-home"></i><span>{% trans "ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:categories' %}" class="mobile-nav-link">
                    <i class="fas fa-th-large"></i><span>{% trans "ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'content:blog_list' %}" class="mobile-nav-link">
                    <i class="fas fa-newspaper fa-fw"></i><span>{% trans "ÿßŸÑŸÖÿØŸàŸÜÿ©" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:about' %}" class="mobile-nav-link">
                    <i class="fas fa-info-circle"></i><span>{% trans "ŸÖŸÜ ŸÜÿ≠ŸÜ" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:contact' %}" class="mobile-nav-link">
                    <i class="fas fa-envelope"></i><span>{% trans "ÿßÿ™ÿµŸÑ ÿ®ŸÜÿß" %}</span>
                </a>
            </li>
            <li class="mobile-nav-divider"></li>
            <!-- Cart & Wishlist Links -->
            <li>
                <a href="{% url 'main:cart_view' %}" class="mobile-nav-link">
                    <i class="fas fa-shopping-cart"></i>
                    <span>{% trans "ÿßŸÑÿ≥ŸÑÿ©" %}</span>
                    {% if request.user.is_authenticated %}
                        <span class="mobile-badge cart-count">{{ cart_count|default:0 }}</span>
                    {% else %}
                        <span class="mobile-badge cart-count guest-cart-count">0</span>
                    {% endif %}
                </a>
            </li>
            <li>
                <a href="{% url 'main:wishlist_view' %}" class="mobile-nav-link">
                    <i class="fas fa-heart text-danger"></i>
                    <span>{% trans "ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©" %}</span>
                    {% if request.user.is_authenticated %}
                        <span class="mobile-badge wishlist-count">{{ wishlist_count|default:0 }}</span>
                    {% else %}
                        <span class="mobile-badge wishlist-count guest-wishlist-count">0</span>
                    {% endif %}
                </a>
            </li>
            <li class="mobile-nav-divider"></li>
            {% if request.user.is_authenticated %}
                <li>
                    <a href="{% url 'main:saved_searches' %}" class="mobile-nav-link">
                        <i class="fas fa-save"></i><span>{% trans "ÿπŸÖŸÑŸäÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©" %}</span>
                    </a>
                </li>
                {% if request.user.is_superuser %}
                    <li>
                        <a href="{% url 'main:admin_dashboard' %}" class="mobile-nav-link">
                            <i class="fas fa-shield-alt text-danger"></i><span>{% trans "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©" %}</span>
                        </a>
                    </li>
                {% endif %}
                {% if request.user.is_staff %}
                    <li>
                        <a href="{% url 'main:reservation_management' %}" class="mobile-nav-link">
                            <i class="fas fa-shopping-cart text-info"></i><span>{% trans "ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ≠ÿ¨Ÿàÿ≤ÿßÿ™" %}</span>
                        </a>
                    </li>
                {% endif %}
                <li>
                    <a href="{% url 'main:logout' %}" class="mobile-nav-link logout">
                        <i class="fas fa-sign-out-alt"></i><span>{% trans "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨" %}</span>
                    </a>
                </li>
            {% else %}
                <li>
                    <a href="{% url 'main:login' %}" class="mobile-nav-link highlight">
                        <i class="fas fa-sign-in-alt"></i><span>{% trans "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ" %}</span>
                    </a>
                </li>
            {% endif %}
            <li class="mobile-nav-divider"></li>
            <!-- Mobile Theme Toggle -->
            <li>
                <button class="header-theme-toggle mobile-nav-link mobile-theme-toggle-btn"
                        id="mobileThemeToggle"
                        type="button"
                        aria-label="{% trans 'ÿ™ÿ®ÿØŸäŸÑ ÿßŸÑŸÖÿ∏Ÿáÿ±' %}">
                    <span class="theme-toggle-icons">
                        <i class="fas fa-sun theme-icon-light"></i>
                        <i class="fas fa-moon theme-icon-dark"></i>
                    </span>
                </button>
            </li>
        </ul>
        <!-- Mobile Country Selector -->
        <div class="mobile-country-selector">
            <div class="mobile-section-title">
                <i class="fas fa-map-marker-alt me-2"></i>{% trans "ÿßÿÆÿ™ÿ± ÿßŸÑÿ®ŸÑÿØ" %}
            </div>
            <button class="mobile-country-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileCountryList">
                <div class="current-selection">
                    <span class="country-flag-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                        {% endfor %}
                    </span>
                    <span class="country-name-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.name }}{% endif %}
                        {% endfor %}
                    </span>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileCountryList">
                <div class="country-list-wrapper">
                    {% for country in countries %}
                        <div class="mobile-country-item
                                    {% if country.code == selected_country %}active{% endif %}"
                             data-country="{{ country.code }}">
                            <div class="country-content">
                                <span class="country-flag-item">{{ country.flag_emoji }}</span>
                                <span class="country-name-item">{{ country.name }}</span>
                            </div>
                            {% if country.code == selected_country %}<i class="fas fa-check-circle check-icon"></i>{% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Mobile Language Switcher -->
        <div class="mobile-lang-selector mt-3">
            <div class="mobile-section-title">
                <i class="fas fa-globe me-2"></i>{% trans "ÿßÿÆÿ™ÿ± ÿßŸÑŸÑÿ∫ÿ©" %}
            </div>
            <button class="mobile-lang-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileLangList">
                <div class="current-selection">
                    {% if LANGUAGE_CODE == 'ar' %}
                        <span class="lang-name-large">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</span>
                    {% else %}
                        <span class="lang-name-large">English</span>
                    {% endif %}
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileLangList">
                <div class="language-list-wrapper">
                    <form action="{% url 'set_language' %}" method="post">
                        {% csrf_token %}
                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                        <button type="submit"
                                name="language"
                                value="ar"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'ar' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            ÿßŸÑÿπÿ±ÿ®Ÿäÿ©
                        </button>
                        <button type="submit"
                                name="language"
                                value="en"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'en' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            English
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="mobile-nav-backdrop" id="mobileBackdrop"></div>
</nav>

<script>
    // Enhanced header subcategory functionality
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburgerBtn');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavClose = document.getElementById('mobileNavClose');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        const subcategoriesDropdown = document.getElementById('subcategoriesDropdown');

        let currentCategoryId = null;
        let subcategoriesSwiper = null;
        let categoriesSwiper = null;

        // Initialize Categories Swiper with conditional marquee effect
        const categorySlides = document.querySelectorAll('.categories-swiper .swiper-slide');
        const slideCount = categorySlides.length;

        // Determine if we need marquee based on screen size and slide count
        const isMobile = window.innerWidth < 768;
        // For production: 7 categories - enable marquee on desktop when > 4, mobile when > 2
        const shouldEnableMarquee = isMobile ? slideCount > 2 : slideCount > 4;

        // Calculate minimum slides required for loop mode
        // With 7 slides, we can safely enable loop mode
        const minSlidesForLoop = 4; // Minimum 4 slides for stable loop with slidesPerView: auto
        const canEnableLoop = shouldEnableMarquee && slideCount >= minSlidesForLoop;

        console.log('üé® Categories Swiper - Slides:', slideCount, '| Mobile:', isMobile, '| Marquee:', shouldEnableMarquee, '| Loop enabled:', canEnableLoop);        categoriesSwiper = new Swiper('.categories-swiper', {
            slidesPerView: 4,
            spaceBetween: 15,
            speed: 300,
            loop: false,
            centeredSlides: false,
            allowTouchMove: true,
            slidesPerGroup: 1,
            autoplay: false,
            navigation: {
                nextEl: '.categories-swiper-next',
                prevEl: '.categories-swiper-prev',
            },
            pagination: {
                el: '.categories-swiper-pagination',
                clickable: true,
                dynamicBullets: true,
            },
            breakpoints: {
                320: {
                    slidesPerView: 2,
                    spaceBetween: 10,
                },
                480: {
                    slidesPerView: 3,
                    spaceBetween: 10,
                },
                768: {
                    slidesPerView: 4,
                    spaceBetween: 12,
                },
                1024: {
                    slidesPerView: 7,
                    spaceBetween: 15,
                },
                1280: {
                    slidesPerView: 7,
                    spaceBetween: 15,
                },
                1440: {
                    slidesPerView: 7,
                    spaceBetween: 20,
                }
            },
            on: {
                init: function() {
                    console.log('‚úÖ Categories Swiper initialized - 7 on desktop, 4 on mobile');
                    console.log('   Total slides:', slideCount);
                }
            }
        });        // Reinitialize on resize to adjust marquee behavior
        let resizeTimer;
        window.addEventListener('resize', function() {
            clearTimeout(resizeTimer);
            resizeTimer = setTimeout(function() {
                const newIsMobile = window.innerWidth < 768;
                const newShouldEnableMarquee = newIsMobile ? slideCount > 3 : slideCount > 5;

                if (categoriesSwiper && (newShouldEnableMarquee !== shouldEnableMarquee)) {
                    categoriesSwiper.destroy(true, true);
                    location.reload(); // Reload to reinitialize properly
                }
            }, 250);
        });        // Mobile menu toggle
        function toggleMobileMenu(show) {
            if (show) {
                mobileNav.classList.add('show');
                mobileBackdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                mobileNav.classList.remove('show');
                mobileBackdrop.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Event listeners
        hamburger?.addEventListener('click', () => toggleMobileMenu(true));
        mobileNavClose?.addEventListener('click', () => toggleMobileMenu(false));
        mobileBackdrop?.addEventListener('click', () => toggleMobileMenu(false));

        // Category click handler
        globalThis.handleCategoryClick = function(element, categoryId) {
            const categoryUrl = element.dataset.categoryUrl;
            const loadingEl = element.querySelector('.category-loading');

            // Check if subcategories are already shown for this category
            if (currentCategoryId === categoryId && subcategoriesDropdown.classList.contains('show')) {
                // Navigate to category page
                globalThis.location.href = categoryUrl;
                return;
            }

            // Show loading
            loadingEl.style.display = 'block';

            // Load subcategories
            loadSubcategories(categoryId, element.querySelector('.yojad-category-name').textContent)
                .then(() => {
                    loadingEl.style.display = 'none';
                    showSubcategories(categoryId);
                })
                .catch(() => {
                    loadingEl.style.display = 'none';
                    // Navigate to category page if loading fails
                    globalThis.location.href = categoryUrl;
                });
        };

        // Show subcategories dropdown
        globalThis.showSubcategories = function(categoryId) {
            currentCategoryId = categoryId;
            subcategoriesDropdown.classList.add('show');

            // Hide sub-subcategories when showing new subcategories
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Hide subcategories dropdown
        globalThis.hideSubcategories = function() {
            subcategoriesDropdown.classList.remove('show');
            currentCategoryId = null;

            // Hide sub-subcategories too
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Load subcategories
        function loadSubcategories(categoryId, categoryName) {
            return new Promise((resolve, reject) => {
                const parentCategoryName = document.getElementById('parentCategoryName');
                const subcategoriesList = document.getElementById('subcategoriesList');
                const viewAllLink = document.getElementById('viewAllSubcategories');

                parentCategoryName.textContent = categoryName;
                subcategoriesList.innerHTML = '<div class="swiper-slide"><i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';

                fetch(`/ajax/subcategories/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            subcategoriesList.innerHTML = '<div class="swiper-slide">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅÿ¶ÿßÿ™ ÿßŸÑŸÅÿ±ÿπŸäÿ©</div>';
                            reject(new Error(data.error));
                            return;
                        }

                        if (data.subcategories && data.subcategories.length > 0) {
                            // Render subcategories
                            subcategoriesList.innerHTML = data.subcategories.map(subcat => `
                                <div class="swiper-slide">
                                    <div class="subcategory-item"
                                         data-subcategory-id="${subcat.id}"
                                         data-subcategory-url="${subcat.url}"
                                         data-has-children="${subcat.has_children}"
                                         onclick="handleSubcategoryClick(this, ${subcat.id}, '${subcat.url}', ${subcat.has_children}, '${subcat.name_ar || subcat.name}')">
                                        <div class="subcategory-icon">
                                            <i class="${subcat.icon || 'fas fa-folder'}"></i>
                                        </div>
                                        <span class="subcategory-name">${subcat.name_ar || subcat.name}</span>
                                        ${subcat.has_children ? '<i class="fas fa-chevron-right subcategory-expand"></i>' : ''}
                                    </div>
                                </div>
                            `).join('');

                            // Update view all link
                            viewAllLink.href = `/categories?parent=${categoryId}`;

                            // Initialize/update swiper
                            if (subcategoriesSwiper) {
                                subcategoriesSwiper.destroy(true, true);
                            }

                            subcategoriesSwiper = new Swiper('.subcategories-swiper', {
                                slidesPerView: 1,
                                spaceBetween: 15,
                                navigation: {
                                    nextEl: '.swiper-button-next',
                                    prevEl: '.swiper-button-prev',
                                },
                                breakpoints: {
                                    480: {
                                        slidesPerView: 2,
                                        spaceBetween: 15,
                                    },
                                    768: {
                                        slidesPerView: 3,
                                        spaceBetween: 20,
                                    },
                                    1024: {
                                        slidesPerView: 3,
                                        spaceBetween: 25,
                                    }
                                }
                            });

                            resolve();
                        } else {
                            subcategoriesList.innerHTML = '<div class="swiper-slide">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅÿ¶ÿßÿ™ ŸÅÿ±ÿπŸäÿ©</div>';
                            resolve();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading subcategories:', error);
                        subcategoriesList.innerHTML = '<div class="swiper-slide">ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ</div>';
                        reject(error);
                    });
            });
        }

        // Handle subcategory click
        globalThis.handleSubcategoryClick = function(element, subcategoryId, url, hasChildren, subcategoryName) {
            if (hasChildren) {
                // Load sub-subcategories
                loadSubSubcategories(subcategoryId, subcategoryName);
            } else {
                // Navigate to subcategory page
                globalThis.location.href = url;
            }
        };

        // Load sub-subcategories
        function loadSubSubcategories(subcategoryId, subcategoryName) {
            const subSubSection = document.getElementById('subSubcategoriesSection');
            const parentSubcategoryName = document.getElementById('parentSubcategoryName');
            const subSubcategoriesList = document.getElementById('subSubcategoriesList');

            parentSubcategoryName.textContent = subcategoryName;
            subSubcategoriesList.innerHTML = '<div class="loading-item"><i class="fas fa-spinner fa-spin"></i> ÿ¨ÿßÿ±Ÿä ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...</div>';
            subSubSection.style.display = 'block';

            fetch(`/ajax/subcategories/${subcategoryId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        subSubcategoriesList.innerHTML = '<div class="error-item">ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑŸÅÿ¶ÿßÿ™</div>';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        subSubcategoriesList.innerHTML = data.subcategories.map(subSubcat => `
                            <div class="sub-subcategory-item" onclick="globalThis.location.href='${subSubcat.url}'">
                                <div class="sub-subcategory-icon">
                                    <i class="${subSubcat.icon || 'fas fa-folder'}"></i>
                                </div>
                                <span class="sub-subcategory-name">${subSubcat.name_ar || subSubcat.name}</span>
                            </div>
                        `).join('');
                    } else {
                        subSubcategoriesList.innerHTML = '<div class="empty-item">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÅÿ¶ÿßÿ™ ŸÅÿ±ÿπŸäÿ© ÿ•ÿ∂ÿßŸÅŸäÿ©</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sub-subcategories:', error);
                    subSubcategoriesList.innerHTML = '<div class="error-item">ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿßÿ™ÿµÿßŸÑ</div>';
                });
        }

        // Close subcategories when clicking outside
        document.addEventListener('click', function(e) {
            if (!subcategoriesDropdown.contains(e.target) &&
                !e.target.closest('.category-nav-item')) {
                hideSubcategories();
            }
        });

        // Touch-friendly category navigation for mobile
        const categoryItems = document.querySelectorAll('.category-nav-item');
        for (const item of categoryItems) {
            let touchStartTime = 0;

            item.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
            });

            item.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                const categoryId = this.dataset.categoryId;

                // Handle touch
                if (touchDuration < 300 && categoryId) {
                    e.preventDefault();
                    handleCategoryClick(this, Number.parseInt(categoryId, 10));
                }
            });

            // Add keyboard support
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const categoryId = this.dataset.categoryId;
                    if (categoryId) {
                        handleCategoryClick(this, Number.parseInt(categoryId, 10));
                    }
                }
            });
        }

        // Mobile country/language selector improvements
        const mobileCountryItems = document.querySelectorAll('.mobile-country-item');
        for (const item of mobileCountryItems) {
            item.addEventListener('click', function() {
                const countryCode = this.dataset.country;
                if (countryCode && typeof setCountry === 'function') {
                    setCountry(countryCode);
                }
            });
        }

        // Close mobile menu on resize to desktop
        globalThis.addEventListener('resize', function() {
            if (globalThis.innerWidth > 768 && mobileNav.classList.contains('show')) {
                toggleMobileMenu(false);
            }
        });

        // Prevent menu close on scroll
        mobileNav?.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        });
    });
</script>
