{% load static i18n %}

<nav class="yojad-header sticky-top" id="mainNav">
    <!-- Top Navigation Bar -->
    <div class="top-nav-bar">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <!-- Left Side: Logo -->
                <div class="header-logo-section">
                    <a class="navbar-brand" href="{% url 'main:home' %}">
                        <img src="{% static 'images/logos/logo-white-theme.png' %}"
                             alt="Logo"
                             class="header-main-logo light-theme-logo" />
                        <img src="{% static 'images/logos/logo-dark-theme.png' %}"
                             alt="Logo"
                             class="header-main-logo dark-theme-logo" />
                    </a>
                </div>
                <!-- Center: Search Bar -->
                <div class="header-search-section">
                    <div class="search-wrapper">
                        <i class="fas fa-search search-icon"></i>
                        <input type="text"
                               class="header-search-input"
                               placeholder="{% trans 'بدء البحث ...' %}">
                    </div>
                </div>
                <!-- Right Side: Actions -->
                <div class="header-actions-section">
                    <div class="d-flex align-items-center gap-3">
                        <!-- Desktop Country Selector -->
                        <div class="dropdown country-dropdown-wrapper">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown"
                                    aria-label="Select Country">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span class="current-country" data-country-code="{{ selected_country }}">
                                    {% for country in countries %}
                                        {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                                    {% endfor %}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end country-dropdown">
                                {% for country in countries %}
                                    <li>
                                        <a class="dropdown-item country-item
                                                  {% if country.code == selected_country %}active{% endif %}"
                                           href="#"
                                           data-country="{{ country.code }}">
                                            <span class="country-flag">{{ country.flag_emoji }}</span>
                                            <span class="country-name">{{ country.name }}</span>
                                            {% if country.code == selected_country %}<i class="fas fa-check country-check"></i>{% endif %}
                                        </a>
                                    </li>
                                {% endfor %}
                            </ul>
                        </div>
                        <!-- Language Switcher -->
                        <div class="dropdown">
                            <button class="header-action-btn dropdown-toggle"
                                    type="button"
                                    data-bs-toggle="dropdown">
                                <i class="fas fa-globe me-1"></i>
                                <span class="current-lang">
                                    {% get_current_language as LANGUAGE_CODE %}
                                    {{ LANGUAGE_CODE|upper }}
                                </span>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li>
                                    <form action="{% url 'set_language' %}" method="post">
                                        {% csrf_token %}
                                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                                        <button type="submit" name="language" value="ar" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            العربية
                                        </button>
                                        <button type="submit" name="language" value="en" class="dropdown-item">
                                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check me-2"></i>{% endif %}
                                            English
                                        </button>
                                    </form>
                                </li>
                            </ul>
                        </div>
                        <!-- User Account -->
                        <div class="header-user-section dropdown">
                            {% if request.user.is_authenticated %}
                                <a class="header-action-btn dropdown-toggle"
                                   href="#"
                                   role="button"
                                   data-bs-toggle="dropdown"
                                   aria-expanded="false">
                                    <i class="fas fa-user-circle"></i>
                                </a>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li>
                                        <a class="dropdown-item" href="#">{% trans "لوحة التحكم" %}</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:my_ads' %}">{% trans "إعلاناتي" %}</a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:packages_list' %}">
                                            <i class="fas fa-gift me-2 text-primary"></i>{% trans "باقات النشر" %}
                                        </a>
                                    </li>
                                    <li>
                                        <a class="dropdown-item" href="{% url 'main:saved_searches' %}">{% trans "عمليات البحث المحفوظة" %}</a>
                                    </li>
                                    {% if request.user.is_staff %}
                                        <li>
                                            <hr class="dropdown-divider">
                                        </li>
                                        <li>
                                            <a class="dropdown-item" href="{% url 'main:reservation_management' %}">
                                                <i class="fas fa-shopping-cart me-2 text-info"></i>{% trans "إدارة الحجوزات" %}
                                            </a>
                                        </li>
                                    {% endif %}
                                    <li>
                                        <hr class="dropdown-divider">
                                    </li>
                                    <li>
                                        <a class="dropdown-item text-danger" href="{% url 'main:logout' %}">{% trans "تسجيل الخروج" %}</a>
                                    </li>
                                </ul>
                            {% else %}
                                <a class="header-action-btn" href="{% url 'main:login' %}">
                                    <i class="fas fa-user"></i>
                                </a>
                            {% endif %}
                        </div>
                        <!-- Notification Bell -->
                        <div class="header-notification-section dropdown">
                            <a href="#"
                               class="header-action-btn position-relative dropdown-toggle"
                               role="button"
                               data-bs-toggle="dropdown"
                               aria-expanded="false">
                                <i class="fas fa-bell"></i>
                                {% if unread_notifications_count > 0 %}
                                    <span class="notification-badge">{{ unread_notifications_count }}</span>
                                {% endif %}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end notification-dropdown">
                                <li class="notification-header">
                                    <h6>{% trans "الإشعارات" %}</h6>
                                </li>
                                {% for notification in latest_notifications %}
                                    <li>
                                        <a class="dropdown-item notification-item"
                                           href="{{ notification.link|default:'#' }}">
                                            <p class="mb-0">{{ notification.message }}</p>
                                            <small class="text-muted">{{ notification.created_at|timesince }} {% trans "ago" %}</small>
                                        </a>
                                    </li>
                                {% empty %}
                                    <li class="text-center p-3 text-muted">{% trans "لا توجد إشعارات جديدة" %}</li>
                                {% endfor %}
                                <li class="notification-footer">
                                    <a href="{% url 'main:notification_list' %}">{% trans "عرض كل الإشعارات" %}</a>
                                </li>
                            </ul>
                        </div>
                        <!-- Theme Toggle -->
                        <div class="header-theme-section">
                            <button class="header-action-btn header-icon-btn header-theme-toggle"
                                    id="headerThemeToggle"
                                    type="button"
                                    aria-label="{% trans 'تبديل المظهر' %}">
                                <i class="fas fa-sun theme-icon-light"></i>
                                <i class="fas fa-moon theme-icon-dark"></i>
                            </button>
                        </div>
                        <!-- Post Ad Button -->
                        <div class="header-post-ad">
                            <a href="{% url 'main:ad_create' %}" class="btn-post-ad">
                                <i class="fas fa-plus-circle me-2"></i>
                                {% trans "نشر الإعلان" %}
                            </a>
                        </div>
                        <!-- New Desktop Dropdown Menu -->
                        <div class="dropdown d-none d-lg-block ms-2">
                            <button class="header-action-btn header-icon-btn"
                                    type="button"
                                    id="desktopMenuDropdown"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false"
                                    aria-label="{% trans 'More pages' %}">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end"
                                aria-labelledby="desktopMenuDropdown">
                                <li>
                                    <a class="dropdown-item" href="{% url 'content:blog_list' %}">
                                        <i class="fas fa-newspaper fa-fw me-2"></i> {% trans "المدونة" %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'main:about' %}">
                                        <i class="fas fa-info-circle fa-fw me-2"></i> {% trans "من نحن" %}
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item" href="{% url 'main:contact' %}">
                                        <i class="fas fa-envelope fa-fw me-2"></i> {% trans "اتصل بنا" %}
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
                <!-- Hamburger (Mobile) -->
                <button class="hamburger d-lg-none"
                        id="hamburgerBtn"
                        type="button"
                        aria-label="Toggle menu">
                    <span></span><span></span><span></span>
                </button>
            </div>
        </div>
    </div>
    <!-- Categories Navigation Bar -->
    <div class="categories-nav-bar">
        <div class="container">
            <div class="categories-scroll-wrapper">
                <!-- Swiper Container -->
                <div class="swiper categories-swiper">
                    <div class="swiper-wrapper categories-nav-list">
                        <!-- Dynamic Category Items -->
                        {% for category in header_categories %}
                            <div class="category-nav-item swiper-slide"
                                 data-category-id="{{ category.id }}"
                                 data-category-color="category-{{ forloop.counter }}"
                                 data-category-url="{% url 'main:categories' %}?section={{ category.section_type }}"
                                 onclick="handleCategoryClick(this, {{ category.id }})"
                                 role="button"
                                 tabindex="0">
                                <div class="category-icon">
                                    {% if category.icon %}
                                        <i class="{{ category.icon }} text-white"></i>
                                    {% else %}
                                        <i class="fas fa-folder text-white"></i>
                                    {% endif %}
                                </div>
                                <span class="category-name">{{ category.name_ar|default:category.name }}</span>
                                <div class="category-loading" style="display: none;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                </div>
                            </div>
                        {% empty %}
                            <!-- Fallback if no categories -->
                            <a href="{% url 'main:categories' %}"
                               class="category-nav-item swiper-slide"
                               data-category-color="green">
                                <div class="category-icon">
                                    <i class="fas fa-book text-white"></i>
                                </div>
                                <span class="category-name">{% trans "كتب وبرامج مساحية" %}</span>
                            </a>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Subcategories Dropdown -->
        <div class="subcategories-dropdown" id="subcategoriesDropdown">
            <div class="container">
                <div class="subcategories-wrapper">
                    <div class="subcategories-header">
                        <h6 class="subcategories-title">الفئات الفرعية</h6>
                        <span class="parent-category-name" id="parentCategoryName"></span>
                        <button class="subcategories-close" onclick="hideSubcategories()" aria-label="إغلاق الفئات الفرعية">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <!-- Subcategories Swiper -->
                    <div class="swiper subcategories-swiper">
                        <div class="swiper-wrapper" id="subcategoriesList">
                            <!-- Subcategories will be loaded here dynamically -->
                        </div>
                        <div class="swiper-button-next"></div>
                        <div class="swiper-button-prev"></div>
                    </div>
                    <!-- Sub-subcategories container -->
                    <div class="sub-subcategories-section" id="subSubcategoriesSection" style="display: none;">
                        <div class="sub-subcategories-header">
                            <h6 class="sub-subcategories-title">الفئات الفرعية الثانوية</h6>
                            <span class="parent-subcategory-name" id="parentSubcategoryName"></span>
                        </div>
                        <div class="sub-subcategories-grid" id="subSubcategoriesList">
                            <!-- Sub-subcategories will be loaded here -->
                        </div>
                    </div>
                    <div class="subcategories-footer">
                        <a href="#" class="view-all-link" id="viewAllSubcategories">
                            <i class="fas fa-arrow-left me-2"></i>
                            عرض جميع الفئات الفرعية
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Mobile Nav -->
    <div class="mobile-nav" id="mobileNav">
        <button class="mobile-nav-close"
                id="mobileNavClose"
                type="button"
                aria-label="{% trans 'إغلاق القائمة' %}">
            <svg xmlns="http://www.w3.org/2000/svg"
                 width="24"
                 height="24"
                 fill="none"
                 stroke="currentColor"
                 stroke-width="2"
                 stroke-linecap="round"
                 stroke-linejoin="round">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </button>
        <div class="mobile-nav-header">
            <div class="mobile-logo-container">
                <img src="{% static 'images/logos/mini-logo-white-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo light-theme-logo" />
                <img src="{% static 'images/logos/mini-logo-dark-theme.png' %}"
                     alt="Logo"
                     class="mobile-logo dark-theme-logo" />
            </div>
            {% if request.user.is_authenticated %}
                {% load idrissimart_tags %}

                <div class="mobile-user-info">
                    {% user_avatar user=request.user size=60 css_class="mobile-user-avatar" %}
                    <div class="mobile-user-details">
                        <span class="mobile-user-name">{{ request.user.get_full_name|default:request.user.username }}</span>
                        <span class="mobile-user-email">{{ request.user.email }}</span>
                    </div>
                </div>
            {% else %}
                <div class="mobile-guest-info">
                    <i class="fas fa-user-circle"></i>
                    <p>{% trans "مرحباً بك" %}</p>
                </div>
            {% endif %}
        </div>
        <ul class="mobile-nav-menu">
            <li>
                <a href="{% url 'main:home' %}" class="mobile-nav-link">
                    <i class="fas fa-home"></i><span>{% trans "الرئيسية" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:categories' %}" class="mobile-nav-link">
                    <i class="fas fa-th-large"></i><span>{% trans "الأقسام" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'content:blog_list' %}" class="mobile-nav-link">
                    <i class="fas fa-newspaper fa-fw"></i><span>{% trans "المدونة" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:about' %}" class="mobile-nav-link">
                    <i class="fas fa-info-circle"></i><span>{% trans "من نحن" %}</span>
                </a>
            </li>
            <li>
                <a href="{% url 'main:contact' %}" class="mobile-nav-link">
                    <i class="fas fa-envelope"></i><span>{% trans "اتصل بنا" %}</span>
                </a>
            </li>
            <li class="mobile-nav-divider"></li>
            {% if request.user.is_authenticated %}
                <li>
                    <a href="#" class="mobile-nav-link">
                        <i class="fas fa-tachometer-alt"></i><span>{% trans "لوحة التحكم" %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'main:packages_list' %}" class="mobile-nav-link">
                        <i class="fas fa-gift text-primary"></i><span>{% trans "باقات النشر" %}</span>
                    </a>
                </li>
                <li>
                    <a href="{% url 'main:saved_searches' %}" class="mobile-nav-link">
                        <i class="fas fa-save"></i><span>{% trans "عمليات البحث المحفوظة" %}</span>
                    </a>
                </li>
                {% if request.user.is_staff %}
                    <li>
                        <a href="{% url 'main:reservation_management' %}" class="mobile-nav-link">
                            <i class="fas fa-shopping-cart text-info"></i><span>{% trans "إدارة الحجوزات" %}</span>
                        </a>
                    </li>
                {% endif %}
                <li>
                    <a href="{% url 'main:logout' %}" class="mobile-nav-link logout">
                        <i class="fas fa-sign-out-alt"></i><span>{% trans "تسجيل الخروج" %}</span>
                    </a>
                </li>
            {% else %}
                <li>
                    <a href="{% url 'main:login' %}" class="mobile-nav-link highlight">
                        <i class="fas fa-sign-in-alt"></i><span>{% trans "تسجيل الدخول" %}</span>
                    </a>
                </li>
            {% endif %}
            <li class="mobile-nav-divider"></li>
            <!-- Mobile Theme Toggle -->
            <li>
                <button class="header-theme-toggle mobile-nav-link mobile-theme-toggle-btn"
                        id="mobileThemeToggle"
                        type="button"
                        aria-label="{% trans 'تبديل المظهر' %}">
                    <span class="theme-toggle-icons">
                        <i class="fas fa-sun theme-icon-light"></i>
                        <i class="fas fa-moon theme-icon-dark"></i>
                    </span>
                </button>
            </li>
        </ul>
        <!-- Mobile Country Selector -->
        <div class="mobile-country-selector">
            <div class="mobile-section-title">
                <i class="fas fa-map-marker-alt me-2"></i>{% trans "اختر البلد" %}
            </div>
            <button class="mobile-country-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileCountryList">
                <div class="current-selection">
                    <span class="country-flag-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.flag_emoji }}{% endif %}
                        {% endfor %}
                    </span>
                    <span class="country-name-large">
                        {% for country in countries %}
                            {% if country.code == selected_country %}{{ country.name }}{% endif %}
                        {% endfor %}
                    </span>
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileCountryList">
                <div class="country-list-wrapper">
                    {% for country in countries %}
                        <div class="mobile-country-item
                                    {% if country.code == selected_country %}active{% endif %}"
                             data-country="{{ country.code }}">
                            <div class="country-content">
                                <span class="country-flag-item">{{ country.flag_emoji }}</span>
                                <span class="country-name-item">{{ country.name }}</span>
                            </div>
                            {% if country.code == selected_country %}<i class="fas fa-check-circle check-icon"></i>{% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        <!-- Mobile Language Switcher -->
        <div class="mobile-lang-selector mt-3">
            <div class="mobile-section-title">
                <i class="fas fa-globe me-2"></i>{% trans "اختر اللغة" %}
            </div>
            <button class="mobile-lang-toggle"
                    type="button"
                    data-bs-toggle="collapse"
                    data-bs-target="#mobileLangList">
                <div class="current-selection">
                    {% if LANGUAGE_CODE == 'ar' %}
                        <span class="lang-name-large">العربية</span>
                    {% else %}
                        <span class="lang-name-large">English</span>
                    {% endif %}
                </div>
                <i class="fas fa-chevron-down toggle-icon"></i>
            </button>
            <div class="collapse" id="mobileLangList">
                <div class="language-list-wrapper">
                    <form action="{% url 'set_language' %}" method="post">
                        {% csrf_token %}
                        <input name="next" type="hidden" value="{{ request.get_full_path }}" />
                        <button type="submit"
                                name="language"
                                value="ar"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'ar' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'ar' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            العربية
                        </button>
                        <button type="submit"
                                name="language"
                                value="en"
                                class="mobile-lang-item
                                       {% if LANGUAGE_CODE == 'en' %}active{% endif %}">
                            {% if LANGUAGE_CODE == 'en' %}<i class="fas fa-check-circle me-2"></i>{% endif %}
                            English
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <div class="mobile-nav-backdrop" id="mobileBackdrop"></div>
</nav>

<script>
    // Enhanced header subcategory functionality
    document.addEventListener('DOMContentLoaded', function() {
        const hamburger = document.getElementById('hamburgerBtn');
        const mobileNav = document.getElementById('mobileNav');
        const mobileNavClose = document.getElementById('mobileNavClose');
        const mobileBackdrop = document.getElementById('mobileBackdrop');
        const subcategoriesDropdown = document.getElementById('subcategoriesDropdown');

        let currentCategoryId = null;
        let subcategoriesSwiper = null;

        // Mobile menu toggle
        function toggleMobileMenu(show) {
            if (show) {
                mobileNav.classList.add('show');
                mobileBackdrop.classList.add('show');
                document.body.style.overflow = 'hidden';
            } else {
                mobileNav.classList.remove('show');
                mobileBackdrop.classList.remove('show');
                document.body.style.overflow = '';
            }
        }

        // Event listeners
        hamburger?.addEventListener('click', () => toggleMobileMenu(true));
        mobileNavClose?.addEventListener('click', () => toggleMobileMenu(false));
        mobileBackdrop?.addEventListener('click', () => toggleMobileMenu(false));

        // Category click handler
        globalThis.handleCategoryClick = function(element, categoryId) {
            const categoryUrl = element.dataset.categoryUrl;
            const loadingEl = element.querySelector('.category-loading');

            // Check if subcategories are already shown for this category
            if (currentCategoryId === categoryId && subcategoriesDropdown.classList.contains('show')) {
                // Navigate to category page
                globalThis.location.href = categoryUrl;
                return;
            }

            // Show loading
            loadingEl.style.display = 'block';

            // Load subcategories
            loadSubcategories(categoryId, element.querySelector('.category-name').textContent)
                .then(() => {
                    loadingEl.style.display = 'none';
                    showSubcategories(categoryId);
                })
                .catch(() => {
                    loadingEl.style.display = 'none';
                    // Navigate to category page if loading fails
                    globalThis.location.href = categoryUrl;
                });
        };

        // Show subcategories dropdown
        globalThis.showSubcategories = function(categoryId) {
            currentCategoryId = categoryId;
            subcategoriesDropdown.classList.add('show');

            // Hide sub-subcategories when showing new subcategories
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Hide subcategories dropdown
        globalThis.hideSubcategories = function() {
            subcategoriesDropdown.classList.remove('show');
            currentCategoryId = null;

            // Hide sub-subcategories too
            const subSubSection = document.getElementById('subSubcategoriesSection');
            subSubSection.style.display = 'none';
        };

        // Load subcategories
        function loadSubcategories(categoryId, categoryName) {
            return new Promise((resolve, reject) => {
                const parentCategoryName = document.getElementById('parentCategoryName');
                const subcategoriesList = document.getElementById('subcategoriesList');
                const viewAllLink = document.getElementById('viewAllSubcategories');

                parentCategoryName.textContent = categoryName;
                subcategoriesList.innerHTML = '<div class="swiper-slide"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';

                fetch(`/ajax/subcategories/${categoryId}/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            subcategoriesList.innerHTML = '<div class="swiper-slide">خطأ في تحميل الفئات الفرعية</div>';
                            reject(new Error(data.error));
                            return;
                        }

                        if (data.subcategories && data.subcategories.length > 0) {
                            // Render subcategories
                            subcategoriesList.innerHTML = data.subcategories.map(subcat => `
                                <div class="swiper-slide">
                                    <div class="subcategory-item"
                                         data-subcategory-id="${subcat.id}"
                                         data-subcategory-url="${subcat.url}"
                                         data-has-children="${subcat.has_children}"
                                         onclick="handleSubcategoryClick(this, ${subcat.id}, '${subcat.url}', ${subcat.has_children}, '${subcat.name_ar || subcat.name}')">
                                        <div class="subcategory-icon">
                                            <i class="${subcat.icon || 'fas fa-folder'}"></i>
                                        </div>
                                        <span class="subcategory-name">${subcat.name_ar || subcat.name}</span>
                                        ${subcat.has_children ? '<i class="fas fa-chevron-right subcategory-expand"></i>' : ''}
                                    </div>
                                </div>
                            `).join('');

                            // Update view all link
                            viewAllLink.href = `/categories?parent=${categoryId}`;

                            // Initialize/update swiper
                            if (subcategoriesSwiper) {
                                subcategoriesSwiper.destroy(true, true);
                            }

                            subcategoriesSwiper = new Swiper('.subcategories-swiper', {
                                slidesPerView: 1,
                                spaceBetween: 15,
                                navigation: {
                                    nextEl: '.swiper-button-next',
                                    prevEl: '.swiper-button-prev',
                                },
                                breakpoints: {
                                    480: {
                                        slidesPerView: 2,
                                        spaceBetween: 15,
                                    },
                                    768: {
                                        slidesPerView: 3,
                                        spaceBetween: 20,
                                    },
                                    1024: {
                                        slidesPerView: 3,
                                        spaceBetween: 25,
                                    }
                                }
                            });

                            resolve();
                        } else {
                            subcategoriesList.innerHTML = '<div class="swiper-slide">لا توجد فئات فرعية</div>';
                            resolve();
                        }
                    })
                    .catch(error => {
                        console.error('Error loading subcategories:', error);
                        subcategoriesList.innerHTML = '<div class="swiper-slide">خطأ في الاتصال</div>';
                        reject(error);
                    });
            });
        }

        // Handle subcategory click
        globalThis.handleSubcategoryClick = function(element, subcategoryId, url, hasChildren, subcategoryName) {
            if (hasChildren) {
                // Load sub-subcategories
                loadSubSubcategories(subcategoryId, subcategoryName);
            } else {
                // Navigate to subcategory page
                globalThis.location.href = url;
            }
        };

        // Load sub-subcategories
        function loadSubSubcategories(subcategoryId, subcategoryName) {
            const subSubSection = document.getElementById('subSubcategoriesSection');
            const parentSubcategoryName = document.getElementById('parentSubcategoryName');
            const subSubcategoriesList = document.getElementById('subSubcategoriesList');

            parentSubcategoryName.textContent = subcategoryName;
            subSubcategoriesList.innerHTML = '<div class="loading-item"><i class="fas fa-spinner fa-spin"></i> جاري التحميل...</div>';
            subSubSection.style.display = 'block';

            fetch(`/ajax/subcategories/${subcategoryId}/`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        subSubcategoriesList.innerHTML = '<div class="error-item">خطأ في تحميل الفئات</div>';
                        return;
                    }

                    if (data.subcategories && data.subcategories.length > 0) {
                        subSubcategoriesList.innerHTML = data.subcategories.map(subSubcat => `
                            <div class="sub-subcategory-item" onclick="globalThis.location.href='${subSubcat.url}'">
                                <div class="sub-subcategory-icon">
                                    <i class="${subSubcat.icon || 'fas fa-folder'}"></i>
                                </div>
                                <span class="sub-subcategory-name">${subSubcat.name_ar || subSubcat.name}</span>
                            </div>
                        `).join('');
                    } else {
                        subSubcategoriesList.innerHTML = '<div class="empty-item">لا توجد فئات فرعية إضافية</div>';
                    }
                })
                .catch(error => {
                    console.error('Error loading sub-subcategories:', error);
                    subSubcategoriesList.innerHTML = '<div class="error-item">خطأ في الاتصال</div>';
                });
        }

        // Close subcategories when clicking outside
        document.addEventListener('click', function(e) {
            if (!subcategoriesDropdown.contains(e.target) &&
                !e.target.closest('.category-nav-item')) {
                hideSubcategories();
            }
        });

        // Touch-friendly category navigation for mobile
        const categoryItems = document.querySelectorAll('.category-nav-item');
        for (const item of categoryItems) {
            let touchStartTime = 0;

            item.addEventListener('touchstart', function(e) {
                touchStartTime = Date.now();
            });

            item.addEventListener('touchend', function(e) {
                const touchDuration = Date.now() - touchStartTime;
                const categoryId = this.dataset.categoryId;

                // Handle touch
                if (touchDuration < 300 && categoryId) {
                    e.preventDefault();
                    handleCategoryClick(this, Number.parseInt(categoryId, 10));
                }
            });

            // Add keyboard support
            item.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const categoryId = this.dataset.categoryId;
                    if (categoryId) {
                        handleCategoryClick(this, Number.parseInt(categoryId, 10));
                    }
                }
            });
        }

        // Mobile country/language selector improvements
        const mobileCountryItems = document.querySelectorAll('.mobile-country-item');
        for (const item of mobileCountryItems) {
            item.addEventListener('click', function() {
                const countryCode = this.dataset.country;
                if (countryCode && typeof setCountry === 'function') {
                    setCountry(countryCode);
                }
            });
        }

        // Close mobile menu on resize to desktop
        globalThis.addEventListener('resize', function() {
            if (globalThis.innerWidth > 768 && mobileNav.classList.contains('show')) {
                toggleMobileMenu(false);
            }
        });

        // Prevent menu close on scroll
        mobileNav?.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        });
    });
</script>
