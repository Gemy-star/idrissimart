{% load i18n static idrissimart_tags %}

<article class="modern-ad-card">
    <!-- Image Section -->
    <div class="ad-image-container">
        <a href="{{ ad.get_absolute_url }}" class="ad-image-link" aria-label="{{ ad.title }}">
            {% if ad.images.first %}
                <img src="{{ ad.images.first.image.url }}"
                     class="ad-image" 
                     alt="{{ ad.title }}"
                     loading="lazy">
            {% else %}
                <div class="ad-image-placeholder">
                    <i class="fas fa-image" aria-hidden="true"></i>
                    <span>{% trans "No Image" %}</span>
                </div>
            {% endif %}
        </a>

        <!-- Badges Overlay - Top Priority Badges -->
        <div class="ad-badges-top">
            <div class="ad-badges-container">
                {% if ad.is_urgent %}
                    <span class="ad-badge urgent-badge" role="status" aria-label="{% trans 'Urgent Ad' %}"> 
                        <i class="fas fa-bolt" aria-hidden="true"></i>
                        <span>عاجل</span>
                    </span>
                {% endif %}

                {% if ad.is_pinned %}
                    <span class="ad-badge pinned-badge" role="status" aria-label="{% trans 'Pinned Ad' %}">
                        <i class="fas fa-thumbtack" aria-hidden="true"></i>
                        <span>مثبت</span>
                    </span>
                {% endif %}

                {% if ad.is_highlighted %}
                    <span class="ad-badge highlighted-badge" role="status" aria-label="{% trans 'Highlighted Ad' %}">
                        <i class="fas fa-certificate" aria-hidden="true"></i>
                        <span>بارز</span>
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Stats Overlay - Bottom Right -->
        <div class="ad-info-overlay">
            <div class="ad-stats-container">
                <span class="ad-stat-item" title="{% trans 'Views' %}" aria-label="{{ ad.views_count|default:0 }} {% trans 'views' %}">
                    <i class="fas fa-eye" aria-hidden="true"></i>
                    <span>{{ ad.views_count|default:0 }}</span>
                </span>
            </div>
            <div class="ad-quick-actions">
                <button class="quick-action-btn compare-btn"
                        data-ad-id="{{ ad.id }}"
                        data-ad-image="{% if ad.images.first %}{{ ad.images.first.image.url }}{% else %}{% static 'images/placeholder-ad.jpg' %}{% endif %}"
                        data-ad-title="{{ ad.title }}"
                        title="{% trans 'Compare' %}">
                    <i class="fas fa-exchange-alt"></i>
                </button>
            </div>
        </div>

        <!-- Wishlist Button - Top Right (Available for all users) -->
        <div class="ad-wishlist-btn-container">
            <button class="ad-wishlist-btn wishlist-btn-card"
                    data-ad-id="{{ ad.id }}"
                    data-ad-title="{{ ad.title }}"
                    data-ad-image="{% if ad.images.first %}{{ ad.images.first.image.url }}{% else %}{% static 'images/placeholder-ad.jpg' %}{% endif %}"
                    onclick="toggleWishlistCard({{ ad.id }}, this)"
                    title="{% trans 'إضافة للمفضلة' %}"
                    aria-label="{% trans 'إضافة للمفضلة' %}">
                <i class="far fa-heart"></i>
            </button>
        </div>
    </div>

    <!-- Content Section -->
    <div class="ad-content">
        <!-- Category Badge -->
        {% if ad.category %}
        <div class="ad-category-badge" role="status">
            <i class="fas fa-tag" aria-hidden="true"></i>
            <span>
                {% if LANGUAGE_CODE == 'ar' and ad.category.name_ar %}
                    {{ ad.category.name_ar }}
                {% else %}
                    {{ ad.category.name }}
                {% endif %}
            </span>
        </div>
        {% endif %}

        <!-- Title -->
        <h3 class="ad-title">
            <a href="{{ ad.get_absolute_url }}" title="{{ ad.title }}">
                {{ ad.title|truncatewords:8 }}
            </a>
        </h3>

        <!-- Location -->
        <div class="ad-location">
            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
            <span>{{ ad.city }}{% if ad.country %}, {{ ad.country.name }}{% endif %}</span>
        </div>

        <!-- Features Row with Badges -->
        <div class="ad-features-row">
            <!-- Publisher Badge -->
            <div class="publisher-badge-wrapper">
                {% user_avatar user=ad.user size=32 css_class="publisher-avatar-mini" %}
                {% if ad.user.is_verified %}
                    <span class="avatar-verified-badge person-badge" title="{% trans 'Verified' %}" aria-label="{% trans 'Verified User' %}">
                        <i class="fas fa-check-circle" aria-hidden="true"></i>
                    </span>
                {% elif ad.user.is_company %}
                    <span class="avatar-verified-badge company-badge" title="شركة">
                        <i class="fas fa-building" aria-hidden="true"></i>
                    </span>
                {% endif %}
            </div>

            <!-- Feature Tags -->
            {% if ad.is_delivery_available %}
            <span class="feature-tag delivery-tag" role="status" aria-label="{% trans 'Delivery Available' %}">
                <i class="fas fa-shipping-fast" aria-hidden="true"></i>
                <span>شحن متاح</span>
            </span>
            {% endif %}

            {% if ad.is_negotiable %}
            <span class="feature-tag negotiable-tag" role="status" aria-label="{% trans 'Negotiable' %}">
                <i class="fas fa-handshake" aria-hidden="true"></i>
                <span>قابل للتفاوض</span>
            </span>
            {% endif %}

            {% if ad.custom_fields.condition %}
            <span class="feature-tag condition-tag" role="status" aria-label="{% trans 'Condition' %}: {{ ad.custom_fields.condition }}">
                <i class="fas fa-box-open" aria-hidden="true"></i>
                <span>{{ ad.custom_fields.condition }}</span>
            </span>
            {% endif %}
        </div>

        <!-- Price Section -->
        <div class="ad-price-section">
            <div class="ad-price-box">
                <div class="price-header">
                    <div class="price-label">
                        <i class="fas fa-money-bill-wave" aria-hidden="true" role="img"></i>
                        <span>السعر</span>
                    </div>
                    {% if ad.is_negotiable %}
                    <span class="price-negotiable-tag" title="{% trans 'Negotiable' %}" aria-label="{% trans 'Price is negotiable' %}">
                        <i class="fas fa-handshake" aria-hidden="true" role="img"></i>
                    </span>
                    {% endif %}
                </div>
                <div class="ad-price-main">
                    {% ad_price_formatted ad as formatted_price %}
                    <span class="price-amount">{{ formatted_price|default_if_none:ad.price }}</span>
                    <span class="price-currency">{{ ad.currency|default:"جنيه" }}</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="ad-footer">
        <div class="ad-footer-content">
            <!-- Time Posted -->
            <div class="ad-time-posted" aria-label="{% trans 'Posted' %} {{ ad.created_at|timesince }} {% trans 'ago' %}">
                <i class="far fa-clock" aria-hidden="true"></i>
                <span>{{ ad.created_at|timesince }}</span>
            </div>

            <!-- Views Count -->
            <div class="ad-views-count" aria-label="{{ ad.views_count|default:0 }} {% trans 'views' %}">
                <i class="fas fa-eye" aria-hidden="true"></i>
                <span>{{ ad.views_count|default:0 }}</span>
            </div>
        </div>
    </footer>
</article>
