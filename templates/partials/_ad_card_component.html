{% load i18n static idrissimart_tags %}

{% is_in_cart ad.id as ad_in_cart %}
{% is_in_wishlist ad.id as ad_in_wishlist %}

<!-- Debug: Ad {{ ad.id }} - In Cart: {{ ad_in_cart }}, In Wishlist: {{ ad_in_wishlist }} -->

<article class="modern-ad-card
    {% if ad.is_highlighted %}highlighted{% endif %}
    {% if ad.is_urgent %}urgent{% endif %}
    {% if ad.is_pinned %}pinned{% endif %}"
    data-priority="{{ ad.get_display_priority }}">
    <!-- Image Section -->
    <div class="ad-image-container">
        <a href="{{ ad.get_absolute_url }}" class="ad-image-link" aria-label="{{ ad.title }}">
            {% if ad.images.first %}
                <img src="{{ ad.images.first.image.url }}"
                     class="ad-image"
                     alt="{{ ad.title }}"
                     loading="lazy">
            {% else %}
                <div class="ad-image-placeholder">
                    <i class="fas fa-image" aria-hidden="true"></i>
                    <span>{% trans "No Image" %}</span>
                </div>
            {% endif %}
        </a>

        <!-- Owner Actions Menu - Top Left -->
        {% if user.is_authenticated and user == ad.user %}
        <div class="ad-owner-actions" style="position: absolute; top: 10px; left: 10px; z-index: 10;">
            <div class="dropdown">
                <button class="btn btn-sm dropdown-toggle owner-actions-btn" type="button" data-bs-toggle="dropdown" aria-expanded="false" style="background: rgba(255, 255, 255, 0.95); border: none; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border-radius: 8px; padding: 6px 12px;">
                    <i class="fas fa-cog"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-start" style="border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">
                    <li><a class="dropdown-item" href="{% url 'main:ad_update' ad.id %}"><i class="fas fa-edit me-2 text-primary"></i>{% trans "تعديل" %}</a></li>
                    <li><a class="dropdown-item" href="{% url 'main:ad_upgrade_checkout' ad.id %}"><i class="fas fa-arrow-up me-2 text-success"></i>{% trans "ترقية" %}</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="toggleAdVisibility({{ ad.id }}, this)"><i class="fas fa-eye-slash me-2 text-warning"></i>{% trans "إخفاء/إظهار" %}</a></li>
                    <li><a class="dropdown-item" href="javascript:void(0)" onclick="markAdAsSold({{ ad.id }})"><i class="fas fa-check-circle me-2 text-info"></i>{% trans "تم البيع" %}</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="confirmDeleteAd({{ ad.id }}, '{{ ad.title|escapejs }}')"><i class="fas fa-trash me-2"></i>{% trans "حذف" %}</a></li>
                </ul>
            </div>
        </div>
        {% endif %}

        <!-- Badges Overlay - Top Priority Badges -->
        <div class="ad-badges-top">
            <div class="ad-badges-container">
                {% if ad.is_urgent %}
                    <span class="ad-badge urgent-badge" role="status" aria-label="{% trans 'Urgent Ad' %}">
                        <i class="fas fa-bolt" aria-hidden="true"></i>
                        <span>عاجل</span>
                    </span>
                {% endif %}

                {% if ad.is_pinned %}
                    <span class="ad-badge pinned-badge" role="status" aria-label="{% trans 'Pinned Ad' %}">
                        <i class="fas fa-thumbtack" aria-hidden="true"></i>
                        <span>مثبت</span>
                    </span>
                {% endif %}

                {% if ad.is_highlighted %}
                    <span class="ad-badge highlighted-badge" role="status" aria-label="{% trans 'Highlighted Ad' %}">
                        <i class="fas fa-certificate" aria-hidden="true"></i>
                        <span>بارز</span>
                    </span>
                {% endif %}
            </div>
        </div>

        <!-- Stats Overlay - Bottom Right -->
        <div class="ad-info-overlay">
            <div class="ad-quick-actions">
                <button class="quick-action-btn compare-btn"
                        data-ad-id="{{ ad.id }}"
                        data-ad-image="{% if ad.images.first %}{{ ad.images.first.image.url }}{% else %}{% static "images/placeholder-ad.jpg" %}{% endif %}"
                        data-ad-title="{{ ad.title }}"
                        title="{% trans "Compare" %}">
                    <i class="fas fa-exchange-alt"></i>
                </button>
                <!-- Wishlist Button - Only for authenticated users -->
                {% if request.user.is_authenticated %}
                <button class="ad-wishlist-btn wishlist-btn-card quick-action-btn {% if ad_in_wishlist %}active{% endif %}"
                        data-ad-id="{{ ad.id }}"
                        data-ad-title="{{ ad.title }}"
                        data-in-wishlist="{% if ad_in_wishlist %}true{% else %}false{% endif %}"
                        onclick="toggleWishlistCard({{ ad.id }}, this, '{{ ad.title|escapejs }}')"
                        title="{% if ad_in_wishlist %}{% trans "في المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}"
                        aria-label="{% if ad_in_wishlist %}{% trans "في المفضلة" %}{% else %}{% trans "إضافة للمفضلة" %}{% endif %}">
                    <i class="{% if ad_in_wishlist %}fas{% else %}far{% endif %} fa-heart"></i>
                </button>
                {% endif %}
                <!-- Cart Button (if cart enabled by admin) - Only for authenticated users -->
                {% if ad.cart_enabled_by_admin and request.user.is_authenticated %}
                <button class="ad-cart-btn cart-btn-card quick-action-btn {% if ad_in_cart %}active{% endif %}"
                        data-ad-id="{{ ad.id }}"
                        data-ad-title="{{ ad.title }}"
                        data-in-cart="{% if ad_in_cart %}true{% else %}false{% endif %}"
                        onclick="toggleCartCard({{ ad.id }}, this, '{{ ad.title|escapejs }}', {{ ad.price|default:0 }})"
                        title="{% if ad_in_cart %}{% trans "في السلة" %}{% else %}{% trans "إضافة للسلة" %}{% endif %}"
                        aria-label="{% if ad_in_cart %}{% trans "في السلة" %}{% else %}{% trans "إضافة للسلة" %}{% endif %}">
                    <i class="fas fa-shopping-cart"></i>
                </button>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Content Section -->
    <div class="ad-content">
        <!-- Category Badge - Show Main Category Only -->
        {% if ad.category %}
        {% with main_category=ad.category.get_root %}
        <div class="ad-category-badge" role="status">
            <i class="fas fa-tag" aria-hidden="true"></i>
            <span>
                {% if LANGUAGE_CODE == 'ar' and main_category.name_ar %}
                    {{ main_category.name_ar }}
                {% else %}
                    {{ main_category.name }}
                {% endif %}
            </span>
        </div>
        {% endwith %}
        {% endif %}

        <!-- Title -->
        <h3 class="ad-title">
            <a href="{{ ad.get_absolute_url }}" title="{{ ad.title }}">
                {{ ad.title|truncatewords:8 }}
            </a>
        </h3>

        <!-- Location -->
        <div class="ad-location">
            <i class="fas fa-map-marker-alt" aria-hidden="true"></i>
            <span>{{ ad.city }}{% if ad.country %}, {{ ad.country.name }}{% endif %}</span>
        </div>

        <!-- Features Row with Badges -->
        <div class="ad-features-row">
            <!-- Publisher Badge -->
            <div class="publisher-badge-wrapper">
                {% user_avatar user=ad.user size=48 css_class="publisher-avatar-mini" %}
                {% if ad.user.is_verified %}
                    <span class="avatar-verified-badge person-badge" title="{% trans 'Verified' %}" aria-label="{% trans 'Verified User' %}">
                        <i class="fas fa-check-circle" aria-hidden="true"></i>
                    </span>
                {% elif ad.user.is_company %}
                    <span class="avatar-verified-badge company-badge" title="شركة">
                        <i class="fas fa-building" aria-hidden="true"></i>
                    </span>
                {% endif %}
            </div>

            <!-- Rating Badge - Beside Avatar -->
            {% if ad.rating %}
            <div class="ad-rating-badge" title="{% trans 'Average Rating' %}">
                <div class="rating-stars">
                    {% with rating_int=ad.rating|floatformat:0|add:"0" %}
                    {% for i in "12345" %}
                        {% if forloop.counter <= rating_int %}
                            <i class="fas fa-star" aria-hidden="true"></i>
                        {% elif forloop.counter == rating_int|add:"1" and ad.rating|floatformat:1|slice:"-3:" != ".0" %}
                            <i class="fas fa-star-half-alt" aria-hidden="true"></i>
                        {% else %}
                            <i class="far fa-star" aria-hidden="true"></i>
                        {% endif %}
                    {% endfor %}
                    {% endwith %}
                </div>
                <span class="rating-value">{{ ad.rating|floatformat:1 }}</span>
                {% if ad.rating_count %}
                <span class="rating-count">({{ ad.rating_count }})</span>
                {% endif %}
            </div>
            {% endif %}

            <!-- Cart Enabled Badge -->
            {% if ad.cart_enabled_by_admin %}
            <span class="feature-tag cart-enabled-tag" role="status" aria-label="{% trans 'Cart Available' %}">
                <i class="fas fa-shopping-cart" aria-hidden="true"></i>
                <span>{% trans "يمكن الشراء" %}</span>
            </span>
            {% endif %}

            <!-- Feature Tags -->
            {% if ad.is_delivery_available %}
            <span class="feature-tag delivery-tag" role="status" aria-label="{% trans 'Delivery Available' %}">
                <i class="fas fa-shipping-fast" aria-hidden="true"></i>
                <span>شحن متاح</span>
            </span>
            {% endif %}

            {% if ad.is_negotiable %}
            <span class="feature-tag negotiable-tag" role="status" aria-label="{% trans 'Negotiable' %}">
                <i class="fas fa-handshake" aria-hidden="true"></i>
                <span>قابل للتفاوض</span>
            </span>
            {% endif %}

            <!-- Dynamic Custom Fields -->
            {% with custom_fields_for_card=ad.get_custom_fields_for_card %}
                {% for field in custom_fields_for_card %}
                <span class="feature-tag custom-field-tag" role="status" aria-label="{{ field.label }}: {{ field.value }}">
                    <i class="fas {{ field.icon }}" aria-hidden="true"></i>
                    <span>{{ field.label }}: {{ field.value }}</span>
                </span>
                {% endfor %}
            {% endwith %}
        </div>

        <!-- Price Section -->
        <div class="ad-price-section">
            {% if ad.hide_price or ad.price_on_request %}
                <!-- Get Quote / Price on Request -->
                <div class="ad-quote-box">
                    <div class="quote-icon">
                        <i class="fas fa-file-invoice-dollar" aria-hidden="true"></i>
                    </div>
                    <div class="quote-content">
                        <span class="quote-text">
                            {% if ad.price_on_request %}
                                {% trans "السعر عند الطلب" %}
                            {% else %}
                                {% trans "اطلب عرض سعر" %}
                            {% endif %}
                        </span>
                        <a href="{{ ad.get_absolute_url }}"
                           class="btn-get-quote"
                           onclick="event.stopPropagation();">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            {% trans "تواصل للسعر" %}
                        </a>
                    </div>
                </div>
            {% else %}
                <!-- Regular Price Display -->
                <div class="ad-price-box">
                    <div class="price-header">
                        <div class="price-label">
                            <i class="fas fa-money-bill-wave" aria-hidden="true" role="img"></i>
                            <span>السعر</span>
                        </div>
                        {% if ad.is_negotiable %}
                        <span class="price-negotiable-tag" title="{% trans 'Negotiable' %}" aria-label="{% trans 'Price is negotiable' %}">
                            <i class="fas fa-handshake" aria-hidden="true" role="img"></i>
                        </span>
                        {% endif %}
                    </div>
                    <div class="ad-price-main">
                        {% ad_price_formatted ad as formatted_price %}
                        <span class="price-amount">{{ formatted_price|default_if_none:ad.price|floatformat:"-2" }}</span>
                        <span class="price-currency">{{ selected_currency }}</span>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>

    <!-- Footer Section -->
    <footer class="ad-footer">
        <div class="ad-footer-content">
            <!-- Time Posted -->
            <div class="ad-time-posted" aria-label="{% trans 'Posted' %} {{ ad.created_at|timesince }} {% trans 'ago' %}">
                <i class="far fa-clock" aria-hidden="true"></i>
                <span>{{ ad.created_at|timesince }}</span>
            </div>

            <!-- Views Count -->
            <div class="ad-views-count" aria-label="{{ ad.views_count|default:0 }} {% trans 'views' %}">
                <i class="fas fa-eye" aria-hidden="true"></i>
                <span>{{ ad.views_count|default:0 }}</span>
            </div>
        </div>
    </footer>
</article>
