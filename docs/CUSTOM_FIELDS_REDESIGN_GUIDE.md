# ุฏููู ูุธุงู ุงูุญููู ุงููุฎุตุตุฉ ุงูุฌุฏูุฏ
## Custom Fields Redesign Guide

## ๐ ููุฎุต ุงูุชุญุฏูุซุงุช / Summary of Changes

ุชู ุฅุนุงุฏุฉ ุชุตููู ูุธุงู ุงูุญููู ุงููุฎุตุตุฉ ุจุงููุงูู ูุญู ุงููุดุงูู ุงูุชุงููุฉ:
- โ ุฅูุบุงุก ุงูููุงูุฐ ุงูููุจุซูุฉ (Modal) - ุงุณุชุฎุฏุงู TabularInline ุจุฏูุงู ูููุง
- โ ููุงูุฐ ูุชุงุจุฉ ูุงุณุนุฉ ูุณููุฉ ุงูุงุณุชุฎุฏุงู
- โ ุฎูุงุฑุงุช ุงูุญููู ูู ุฌุฏูู ูููุตู (ุจุฏูุงู ูู ุงูููุงุตู)
- โ ุญูู ูุงุญุฏ ูููู ุงุณุชุฎุฏุงูู ูู ุนุฏุฉ ุฃูุณุงู
- โ ุฅุนุฏุงุฏุงุช ูุฎุตุตุฉ ููู ูุณู

---

## ๐๏ธ ุงูุจููุฉ ุงูุฌุฏูุฏุฉ / New Structure

### 1. CustomField (ุงูุญูู ุงููุฎุตุต)
**ุงูุชุบููุฑุงุช:**
- โ ุชู ุฅุฒุงูุฉ: `category` (ForeignKey)
- โ ุชู ุฅุฒุงูุฉ: `options` (TextField)
- โ ุชู ุฅุฒุงูุฉ: `order` (IntegerField)
- โ ุชู ุฅุถุงูุฉ: `categories` (ManyToManyField ุนุจุฑ CategoryCustomField)
- โ ุชุญุฏูุซ: `name` ุฃุตุจุญ ูุฑูุฏ ุนูู ูุณุชูู ุงููุธุงู (ุจุฏูุงู ูู ูุฑูุฏ ููู ูุณู)
- โ ุชุญุฏูุซ: `is_required` โ "ูุทููุจ ุงูุชุฑุงุถูุงู"

### 2. CustomFieldOption (ุฌุฏูุฏ) - ุฎูุงุฑุงุช ุงูุญูู
**ุงูุบุฑุถ:** ุชุฎุฒูู ุฎูุงุฑุงุช ุงูุญููู ุงูููุณุฏูุฉ ุจุฏูุงู ูู ุงููุต ุงูููุตูู ุจููุงุตู

**ุงูุญููู:**
- `custom_field` - ุงูุญูู ุงููุฎุตุต (ForeignKey)
- `label_ar` - ุงูุชุณููุฉ ุจุงูุนุฑุจูุฉ
- `label_en` - ุงูุชุณููุฉ ุจุงูุฅูุฌููุฒูุฉ
- `value` - ุงููููุฉ ุงููุฎุฒูุฉ
- `order` - ุงูุชุฑุชูุจ
- `is_active` - ูุดุท/ุบูุฑ ูุดุท

**ูุซุงู:**
```python
# ูุฏูู (Old):
field.options = "ุฌุฏูุฏ,ูุณุชุนูู,ููุฅูุฌุงุฑ"

# ุฌุฏูุฏ (New):
CustomFieldOption.objects.create(custom_field=field, label_ar="ุฌุฏูุฏ", value="new", order=1)
CustomFieldOption.objects.create(custom_field=field, label_ar="ูุณุชุนูู", value="used", order=2)
CustomFieldOption.objects.create(custom_field=field, label_ar="ููุฅูุฌุงุฑ", value="rent", order=3)
```

### 3. CategoryCustomField (ุฌุฏูุฏ) - ุฑุจุท ุงูุฃูุณุงู ุจุงูุญููู
**ุงูุบุฑุถ:** ุฑุจุท many-to-many ูุน ุฅุนุฏุงุฏุงุช ูุฎุตุตุฉ ููู ูุณู

**ุงูุญููู:**
- `category` - ุงููุณู (ForeignKey)
- `custom_field` - ุงูุญูู ุงููุฎุตุต (ForeignKey)
- `is_required` - ูุทููุจ ูู ูุฐุง ุงููุณู (ุชุฌุงูุฒ ุงูุฅุนุฏุงุฏ ุงูุงูุชุฑุงุถู)
- `order` - ุชุฑุชูุจ ุงูุนุฑุถ ูู ูุฐุง ุงููุณู
- `is_active` - ูุดุท ูู ูุฐุง ุงููุณู

**ูุซุงู:**
```python
# ุญูู "ุงูุญุงูุฉ" ูู ูุณู "ุณูุงุฑุงุช" (ูุทููุจุ ุชุฑุชูุจ 1)
CategoryCustomField.objects.create(
    category=cars_category,
    custom_field=condition_field,
    is_required=True,  # ูุทููุจ ูู ูุณู ุงูุณูุงุฑุงุช
    order=1,
    is_active=True
)

# ููุณ ุงูุญูู ูู ูุณู "ุนูุงุฑุงุช" (ุบูุฑ ูุทููุจุ ุชุฑุชูุจ 3)
CategoryCustomField.objects.create(
    category=real_estate_category,
    custom_field=condition_field,
    is_required=False,  # ุบูุฑ ูุทููุจ ูู ูุณู ุงูุนูุงุฑุงุช
    order=3,
    is_active=True
)
```

---

## ๐จ ูุงุฌูุฉ ุงูุฅุฏุงุฑุฉ / Admin Interface

### ุฅูุดุงุก ุญูู ุฌุฏูุฏ / Creating a New Field

1. **ุงุฐูุจ ุฅูู:** ููุญุฉ ุงูุฅุฏุงุฑุฉ โ ุงูุญููู ุงููุฎุตุตุฉ โ ุฅุถุงูุฉ ุญูู ูุฎุตุต
2. **ุงููุฃ ุงููุนูููุงุช ุงูุฃุณุงุณูุฉ:**
   - ุงุณู ุงูุญูู (ูุซู: `condition`)
   - ุงูุชุณููุฉ ุจุงูุนุฑุจูุฉ (ูุซู: `ุงูุญุงูุฉ`)
   - ุงูุชุณููุฉ ุจุงูุฅูุฌููุฒูุฉ (ูุซู: `Condition`)
   - ููุน ุงูุญูู (SELECT, RADIO, CHECKBOX, TEXT, etc.)

3. **ุฃุถู ุงูุฎูุงุฑุงุช** (ููุญููู ุงูููุณุฏูุฉ ููุท):
   - ูู ูุณู "ุฎูุงุฑุงุช ุงูุญูู ุงููุฎุตุต" ุฃุณูู ุงูุตูุญุฉ
   - ุงุถุบุท "ุฅุถุงูุฉ ุตู" ููู ุฎูุงุฑ
   - ุงููุฃ: ุงูุฎูุงุฑ ุจุงูุนุฑุจูุฉุ ุจุงูุฅูุฌููุฒูุฉุ ุงููููุฉุ ุงูุชุฑุชูุจ

4. **ุฑุจุท ุจุงูุฃูุณุงู:**
   - ูู ูุณู "ุงูุฃูุณุงู ุงููุฑุชุจุทุฉ" ุฃุณูู ุงูุตูุญุฉ
   - ุงุฎุชุฑ ุงููุณู
   - ุญุฏุฏ: ูู ูุทููุจุ ุงูุชุฑุชูุจุ ูุดุทุ
   - ููููู ุฅุถุงูุฉ ููุณ ุงูุญูู ูุนุฏุฉ ุฃูุณุงู

### ุตูุฑุฉ ุชูุถูุญูุฉ ูููุงุฌูุฉ / Admin UI Layout

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ูุนูููุงุช ุฃุณุงุณูุฉ                         โ
โ  โโ ุงุณู ุงูุญูู: condition                โ
โ  โโ ุงูุชุณููุฉ (ุน): ุงูุญุงูุฉ                 โ
โ  โโ ุงูุชุณููุฉ (EN): Condition             โ
โ  โโ ููุน ุงูุญูู: ูุงุฆูุฉ ููุณุฏูุฉ             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุฅุนุฏุงุฏุงุช ุงูุญูู                          โ
โ  โโ ูุทููุจ ุงูุชุฑุงุถูุงู: โ                 โ
โ  โโ ูุดุท: โ                              โ
โ  โโ ูุต ุงููุณุงุนุฏุฉ: ุงุฎุชุฑ ุญุงูุฉ ุงูููุชุฌ       โ
โ  โโ Placeholder: ูุซุงู: ุฌุฏูุฏ             โ
โ  โโ ุงููููุฉ ุงูุงูุชุฑุงุถูุฉ: new             โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โผ ูููุฏ ุงูุชุญูู (ุงุฎุชูุงุฑู)               โ
โ     โโ ุงูุญุฏ ุงูุฃุฏูู ููุทูู:               โ
โ     โโ ุงูุญุฏ ุงูุฃูุตู ููุทูู:               โ
โ     โโ ุงูุญุฏ ุงูุฃุฏูู ูููููุฉ:              โ
โ     โโ ุงูุญุฏ ุงูุฃูุตู ูููููุฉ:              โ
โ     โโ Regex ููุชุญูู:                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุฎูุงุฑุงุช ุงูุญูู ุงููุฎุตุต:                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงูุชุณููุฉ(ุน) โ EN  โ ุงููููุฉ โ ุชุฑุชูุจโ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ  โ ุฌุฏูุฏ       โ New โ new   โ  1  โ โ  โ
โ  โ ูุณุชุนูู     โUsed โ used  โ  2  โ โ  โ
โ  โ ููุฅูุฌุงุฑ    โRent โ rent  โ  3  โ โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  [ุฅุถุงูุฉ ุฎูุงุฑ ุขุฎุฑ]                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  ุงูุฃูุณุงู ุงููุฑุชุจุทุฉ:                      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ ุงููุณู    โ ูุทููุจุ โ ุงูุชุฑุชูุจ โ ูุดุทโ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค  โ
โ  โ ุณูุงุฑุงุช   โ   โ   โ   1    โ โ โ  โ
โ  โ ุนูุงุฑุงุช   โ   โ   โ   3    โ โ โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  [ุฅุถุงูุฉ ูุณู ุขุฎุฑ]                        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## ๐ป ุงุณุชุฎุฏุงู ูู ุงูููุฏ / Code Usage

### ุฌูุจ ุงูุญููู ุงููุฎุตุตุฉ ููุณู / Get Custom Fields for Category

```python
# ูุฏูู (Old):
fields = CustomField.objects.filter(category=category, is_active=True).order_by('order')

# ุฌุฏูุฏ (New):
from main.models import CategoryCustomField

category_fields = CategoryCustomField.objects.filter(
    category=category,
    is_active=True
).select_related('custom_field').order_by('order')

for cf in category_fields:
    field = cf.custom_field
    is_required = cf.is_required  # ุฅุนุฏุงุฏ ุฎุงุต ุจูุฐุง ุงููุณู

    # ุงูุญุตูู ุนูู ุงูุฎูุงุฑุงุช
    if field.field_type in ['SELECT', 'RADIO', 'CHECKBOX']:
        options = field.field_options.filter(is_active=True).order_by('order')
        for option in options:
            print(option.label, option.value)
```

### ูู ุงูู Forms / In Forms

```python
# ูุฏูู (Old):
def add_custom_fields(self, category):
    for field in category.customfield_set.filter(is_active=True):
        # ...

# ุฌุฏูุฏ (New):
def add_custom_fields(self, category):
    category_fields = CategoryCustomField.objects.filter(
        category=category,
        is_active=True
    ).select_related('custom_field').prefetch_related(
        'custom_field__field_options'
    ).order_by('order')

    for cf in category_fields:
        field = cf.custom_field
        is_required = cf.is_required or field.is_required

        if field.field_type == 'SELECT':
            choices = [(opt.value, opt.label) for opt in field.field_options.filter(is_active=True)]
            self.fields[f'custom_{field.name}'] = forms.ChoiceField(
                label=field.label,
                choices=choices,
                required=is_required,
                # ...
            )
```

### ูู ุงูู Views / In Views

```python
# ูุฏูู (Old):
custom_fields = category.customfield_set.filter(is_active=True)

# ุฌุฏูุฏ (New):
category_fields = CategoryCustomField.objects.filter(
    category=category,
    is_active=True
).select_related('custom_field').prefetch_related(
    'custom_field__field_options'
).order_by('order')

context = {
    'custom_fields': [
        {
            'field': cf.custom_field,
            'is_required': cf.is_required,
            'order': cf.order,
            'options': cf.custom_field.field_options.filter(is_active=True) if cf.custom_field.field_type in ['SELECT', 'RADIO', 'CHECKBOX'] else []
        }
        for cf in category_fields
    ]
}
```

---

## ๐ ุชุฑุญูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ / Data Migration

ุฅุฐุง ูุงูุช ูุฏูู ุจูุงูุงุช ููุฌูุฏุฉุ ุณุชุญุชุงุฌ ูุชุฑุญูููุง:

```python
# ูู Django shell
python manage.py shell

from main.models import CustomField, CategoryCustomField, CustomFieldOption

# ูุซุงู: ุฅูุดุงุก CategoryCustomField ููุญููู ุงูููุฌูุฏุฉ
# (ุฅุฐุง ูุงูุช ูุฏูู ุจูุงูุงุช ูู ุงููููู ุงููุฏูู)
```

**ููุงุญุธุฉ:** ุชู ุญุฐู ุญูู `category` ูู CustomFieldุ ูุฐุง ุชุฃูุฏ ูู ุชุฑุญูู ุฃู ุจูุงูุงุช ููุฌูุฏุฉ ูุจู ุงูุญุฐู.

---

## โ ูุงุฆูุฉ ุงูุชุญูู / Checklist

- [x] ุชุญุฏูุซ Models (CustomField, CustomFieldOption, CategoryCustomField)
- [x] ุชุญุฏูุซ Admin Interface ูุน TabularInline
- [x] ุฅูุดุงุก Migration ูุชุทุจููู
- [ ] ุชุญุฏูุซ Forms (ClassifiedAdForm, etc.)
- [ ] ุชุญุฏูุซ Views (get custom fields queries)
- [ ] ุชุญุฏูุซ Templates (display custom fields)
- [ ] ุงุฎุชุจุงุฑ ุฅูุดุงุก ุญูู ุฌุฏูุฏ ูู Admin
- [ ] ุงุฎุชุจุงุฑ ุฅุถุงูุฉ ุฎูุงุฑุงุช ููุญูู
- [ ] ุงุฎุชุจุงุฑ ุฑุจุท ุญูู ุจุนุฏุฉ ุฃูุณุงู
- [ ] ุงุฎุชุจุงุฑ ุนุฑุถ ุงูุญููู ูู ุตูุญุฉ ุฅุถุงูุฉ ุฅุนูุงู

---

## ๐ ููุงุญุธุงุช ูุงูุฉ / Important Notes

1. **ุฃุณูุงุก ุงูุญููู ูุฑูุฏุฉ ุนุงูููุงู:**
   - ุงูุขู `name` ูุฌุจ ุฃู ูููู ูุฑูุฏ ูู ูู ุงููุธุงู
   - ูุง ูููู ุฅูุดุงุก ุญูููู ุจููุณ ุงูุงุณู ุญุชู ูู ูู ุฃูุณุงู ูุฎุชููุฉ
   - ูุฐุง ูุณูุญ ุจุฅุนุงุฏุฉ ุงุณุชุฎุฏุงู ุงูุญููู

2. **ุงูุฎูุงุฑุงุช ูู ุฌุฏูู ูููุตู:**
   - ูุง ุชุณุชุฎุฏู ุงูููุงุตู ุจุนุฏ ุงูุขู
   - ูู ุฎูุงุฑ ูู ุณุฌู ูููุตู ูู CustomFieldOption
   - ูููู ุชุนุฏูู/ุญุฐู/ุฅุถุงูุฉ ุฎูุงุฑุงุช ุจุณูููุฉ

3. **ุฅุนุฏุงุฏุงุช ุฎุงุตุฉ ุจูู ูุณู:**
   - ูููู ุชุฌุงูุฒ `is_required` ููู ูุณู
   - ุชุฑุชูุจ ูุฎุชูู ูู ูู ูุณู
   - ุชูุนูู/ุชุนุทูู ุงูุญูู ูู ุฃูุณุงู ูุญุฏุฏุฉ

4. **ุงูุฃุฏุงุก:**
   - ุงุณุชุฎุฏู `.select_related('custom_field')` ุนูุฏ ุฌูุจ CategoryCustomField
   - ุงุณุชุฎุฏู `.prefetch_related('field_options')` ุนูุฏ ุงูุญุงุฌุฉ ููุฎูุงุฑุงุช
   - ููุฑุณุฉ ุชููุงุฆูุฉ ุนูู ForeignKey ู unique_together

---

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก / Troubleshooting

### ุฎุทุฃ: "Field matching query does not exist"
- ุชุฃูุฏ ูู ุงุณุชุฎุฏุงู `CategoryCustomField` ุจุฏูุงู ูู `category.customfield_set`
- ุชุญูู ูู ูุฌูุฏ ุนูุงูุฉ M2M ุนุจุฑ through model

### ุฎุทุฃ: "get_options_list is not defined"
- ุชู ุญุฐู ูุฐู ุงูุฏุงูุฉ
- ุงุณุชุฎุฏู `field.field_options.all()` ุจุฏูุงู ูููุง

### ูุง ุชุธูุฑ ุงูุฎูุงุฑุงุช ูู Admin
- ุชุฃูุฏ ูู ุฃู `CustomFieldOptionInline` ูุถุงู ูู `CustomFieldAdmin.inlines`
- ุชุญูู ูู `is_active=True` ููุฎูุงุฑุงุช

---

## ๐ ููุงุฑุฏ ุฅุถุงููุฉ / Additional Resources

- [Django ManyToManyField through](https://docs.djangoproject.com/en/5.2/ref/models/fields/#django.db.models.ManyToManyField.through)
- [Django Admin Inlines](https://docs.djangoproject.com/en/5.2/ref/contrib/admin/#inlinemodeladmin-objects)
- [Django Model Meta Options](https://docs.djangoproject.com/en/5.2/ref/models/options/)

---

ุชุงุฑูุฎ ุงูุชุญุฏูุซ: 2 ุฏูุณูุจุฑ 2025
ุงูุฅุตุฏุงุฑ: 2.0
