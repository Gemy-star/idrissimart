# إعدادات التحقق من الحسابات - دليل الاستخدام

## نظرة عامة

تم إضافة نظام مرن للتحكم في متطلبات التحقق من الحسابات يسمح للمشرف بتفعيل أو إلغاء:
1. التحقق من البريد الإلكتروني أثناء التسجيل
2. التحقق من رقم الهاتف أثناء التسجيل
3. التحقق المطلوب لاستخدام خدمات الموقع

## الإعدادات من لوحة الإدارة

### الوصول للإعدادات
1. سجل الدخول للوحة الإدارة
2. اذهب إلى **المحتوى** > **إعدادات الموقع**
3. ستجد قسم **إعدادات التحقق من الحسابات**

### الخيارات المتاحة

#### 1. التحقق من البريد الإلكتروني إلزامي (`require_email_verification`)
- **القيمة الافتراضية**: غير مفعل (False)
- **الوصف**: إذا كان مفعلاً، سيتم إرسال رابط التحقق للمستخدمين الجدد عبر البريد الإلكتروني
- **التأثير**: يتم إرسال رسالة تحقق تلقائياً بعد التسجيل

#### 2. التحقق من رقم الهاتف إلزامي (`require_phone_verification`)
- **القيمة الافتراضية**: غير مفعل (False)
- **الوصف**: إذا كان مفعلاً، يجب على المستخدمين إدخال كود التحقق المرسل عبر SMS
- **التأثير**: لن يتمكن المستخدم من إكمال التسجيل بدون التحقق من رقم الهاتف

#### 3. التحقق مطلوب لاستخدام الخدمات (`require_verification_for_services`)
- **القيمة الافتراضية**: غير مفعل (False)
- **الوصف**: يشترط التحقق من الحساب (إيميل أو موبايل) لاستخدام خدمات الموقع
- **التأثير**: المستخدمون غير المتحققين لا يمكنهم:
  - نشر إعلانات
  - إضافة منتجات للسلة
  - إضافة للمفضلة
  - استخدام باقي الخدمات

#### 4. رسالة التحقق للخدمات (`verification_services_message`)
- **القيمة الافتراضية**: "يجب التحقق من حسابك لاستخدام هذه الخدمة"
- **الوصف**: الرسالة التي تظهر للمستخدمين غير المتحققين
- **متوفر بالعربية والإنجليزية**

## كيفية الاستخدام في الكود

### 1. للتحقق من الإعدادات

```python
from content.verification_utils import (
    is_email_verification_required,
    is_phone_verification_required,
    is_verification_required_for_services,
    get_verification_message,
)

# التحقق من إعداد معين
if is_email_verification_required():
    # إرسال رسالة تحقق
    pass

if is_phone_verification_required():
    # طلب كود التحقق
    pass
```

### 2. للتحقق من قدرة المستخدم على استخدام الخدمات

```python
from content.verification_utils import user_can_use_services

can_use, message = user_can_use_services(request.user)
if not can_use:
    messages.warning(request, message)
    return redirect('main:publisher_settings')
```

### 3. استخدام Decorator للحماية

```python
from main.decorators import verification_required_for_services

@verification_required_for_services
def my_service_view(request):
    # هذا الكود سيعمل فقط للمستخدمين المتحققين
    # (إذا كان الإعداد مفعل)
    pass
```

### 4. في القوالب (Templates)

```django
{% if verification_requirements.email_required %}
    <p>يجب تأكيد البريد الإلكتروني</p>
{% endif %}

{% if verification_requirements.phone_required %}
    <p>يجب تأكيد رقم الهاتف</p>
{% endif %}

{% if verification_requirements.services_require_verification %}
    <p>{{ verification_requirements.verification_message }}</p>
{% endif %}
```

## سيناريوهات الاستخدام

### السيناريو 1: تسجيل حر بدون قيود
- ✗ التحقق من البريد الإلكتروني
- ✗ التحقق من رقم الهاتف
- ✗ التحقق للخدمات
- **النتيجة**: المستخدمون يمكنهم التسجيل واستخدام جميع الخدمات مباشرة

### السيناريو 2: تحقق اختياري
- ✓ التحقق من البريد الإلكتروني
- ✓ التحقق من رقم الهاتف
- ✗ التحقق للخدمات
- **النتيجة**: يتم طلب التحقق أثناء التسجيل، لكن يمكن استخدام الخدمات بدون تحقق

### السيناريو 3: تحقق إلزامي كامل
- ✓ التحقق من البريد الإلكتروني
- ✓ التحقق من رقم الهاتف
- ✓ التحقق للخدمات
- **النتيجة**: يجب التحقق من الحساب بالكامل قبل استخدام أي خدمة

### السيناريو 4: تحقق للخدمات فقط
- ✗ التحقق من البريد الإلكتروني (أثناء التسجيل)
- ✗ التحقق من رقم الهاتف (أثناء التسجيل)
- ✓ التحقق للخدمات
- **النتيجة**: التسجيل حر، لكن لاستخدام الخدمات يجب التحقق من الحساب

## ملاحظات مهمة

1. **المشرفون والموظفون**: دائماً يمكنهم استخدام جميع الخدمات بغض النظر عن حالة التحقق
2. **التحقق المزدوج**: يكفي التحقق من الإيميل أو الموبايل (أي منهما) لاستخدام الخدمات
3. **الرسائل القابلة للتخصيص**: يمكن تغيير رسالة التحقق من لوحة الإدارة
4. **متعدد اللغات**: جميع الرسائل متوفرة بالعربية والإنجليزية

## الملفات المعدلة

1. `content/site_config.py` - إضافة الحقول الجديدة
2. `content/verification_utils.py` - دوال المساعدة (جديد)
3. `content/context_processors.py` - إضافة context processor
4. `content/admin.py` - واجهة الإدارة
5. `main/auth_views.py` - تطبيق الإعدادات في التسجيل
6. `main/decorators.py` - decorator جديد للحماية
7. `idrissimart/settings/common.py` - تفعيل context processor

## الترقيات المستقبلية الممكنة

- إضافة تحقق ثنائي (2FA)
- إضافة تحقق عبر رسائل WhatsApp
- نظام نقاط للمستخدمين المتحققين
- شارات توثيق على الملفات الشخصية
